feature:
  branch: "049-phase-context-meta"
  created: "2025-12-18"
  status: "Draft"
  input: |
    Add metadata flags to phase context generation in internal/workflow/phase_context.go. This addresses redundant artifact reads (15K tokens/session) and unnecessary checklists checks (128 checks across 6 sessions for non-existent directory).

    ## Problem Statement
    Analysis shows Claude consistently:
    1. Reads phase-X.yaml context file (contains bundled spec/plan/tasks)
    2. Immediately reads spec.yaml separately (REDUNDANT)
    3. Reads plan.yaml separately (REDUNDANT)
    4. Reads tasks.yaml separately (REDUNDANT)
    5. Checks for checklists/ directory (NEVER EXISTS in most projects)

    The phase context header says 'This file bundles spec, plan, and phase-specific tasks' but Claude ignores this because there is no machine-readable metadata.

    ## Required Changes

    ### 1. Update PhaseContext struct in internal/workflow/types.go or phase_context.go
    Add a ContextMeta field to the phase context YAML structure:

    ```yaml
    _context_meta:
      phase_artifacts_bundled: true    # Signals DO NOT read individual artifacts
      bundled_artifacts:
        - spec.yaml
        - plan.yaml
        - tasks.yaml (phase-filtered)
      has_checklists: false            # Skip checklists directory check
      skip_reads:
        - 'specs/<feature>/spec.yaml'
        - 'specs/<feature>/plan.yaml'
        - 'specs/<feature>/tasks.yaml'
    ```

    ### 2. Update phase context generation
    Modify the function that generates phase-X.yaml files to:
    - Always include _context_meta section at the top of generated files
    - Set phase_artifacts_bundled: true
    - List the bundled artifacts explicitly
    - Check if checklists/ directory exists and set has_checklists accordingly
    - Generate skip_reads list with actual paths

    ### 3. Update implement.md template
    Add section explaining _context_meta usage.

    ## Acceptance Criteria
    - PhaseContext struct includes ContextMeta field
    - Generated phase-X.yaml files include _context_meta section
    - _context_meta.phase_artifacts_bundled is always true for phase contexts
    - _context_meta.has_checklists reflects actual directory existence
    - _context_meta.skip_reads lists bundled artifact paths
    - implement.md template documents _context_meta usage
    - Existing tests pass after changes

    ## Non-Functional Requirements
    - Backward compatible (old phase contexts without _context_meta still work)
    - _context_meta section appears at TOP of generated YAML
    - Performance: directory existence check <1ms

user_stories:
  - id: "US-001"
    title: "Skip redundant artifact reads during implementation"
    priority: "P1"
    as_a: "Claude agent executing implementation tasks"
    i_want: "clear machine-readable metadata indicating which artifacts are already bundled in the phase context"
    so_that: "I can avoid redundant file reads that waste 5-15K tokens per session"
    why_this_priority: "Primary value proposition - directly addresses the root cause of wasted tokens"
    independent_test: "Generate phase context, verify _context_meta section is present and contains expected fields"
    acceptance_scenarios:
      - given: "A phase context file is generated for phase 2 of feature 'user-auth'"
        when: "Claude reads the phase-2.yaml context file"
        then: "_context_meta.phase_artifacts_bundled is true and skip_reads contains 'specs/user-auth/spec.yaml', 'specs/user-auth/plan.yaml', 'specs/user-auth/tasks.yaml'"
      - given: "A phase context file with _context_meta is loaded"
        when: "Claude parses the YAML"
        then: "bundled_artifacts list includes 'spec.yaml', 'plan.yaml', 'tasks.yaml (phase-filtered)'"

  - id: "US-002"
    title: "Indicate checklists directory existence"
    priority: "P1"
    as_a: "Claude agent executing implementation tasks"
    i_want: "metadata indicating whether a checklists directory exists for this feature"
    so_that: "I can skip 128+ unnecessary directory existence checks across sessions"
    why_this_priority: "High-frequency waste pattern identified across multiple sessions"
    independent_test: "Generate phase context for features with and without checklists directory, verify has_checklists flag accuracy"
    acceptance_scenarios:
      - given: "Feature directory 'specs/user-auth/' has no 'checklists/' subdirectory"
        when: "Phase context is generated"
        then: "_context_meta.has_checklists is false"
      - given: "Feature directory 'specs/user-auth/' has a 'checklists/' subdirectory"
        when: "Phase context is generated"
        then: "_context_meta.has_checklists is true"

  - id: "US-003"
    title: "Document context metadata usage"
    priority: "P2"
    as_a: "Claude agent reading implementation instructions"
    i_want: "clear documentation explaining _context_meta fields and expected behavior"
    so_that: "I reliably follow the metadata signals and avoid redundant reads"
    why_this_priority: "Documentation ensures metadata is actually used by Claude"
    independent_test: "Read implement.md template, verify _context_meta documentation section exists"
    acceptance_scenarios:
      - given: "implement.md template is loaded"
        when: "Claude searches for context metadata documentation"
        then: "A section explaining phase_artifacts_bundled, has_checklists, and skip_reads is found"
      - given: "implement.md contains _context_meta documentation"
        when: "Claude reads the documentation"
        then: "It explicitly states to NOT read files listed in skip_reads"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST add ContextMeta struct type with fields: PhaseArtifactsBundled (bool), BundledArtifacts ([]string), HasChecklists (bool), SkipReads ([]string)"
      testable: true
      acceptance_criteria: "ContextMeta struct is defined in phase_context.go with correct YAML tags"

    - id: "FR-002"
      description: "MUST add ContextMeta field to PhaseContext struct with yaml tag '_context_meta'"
      testable: true
      acceptance_criteria: "PhaseContext struct includes ContextMeta field and generated YAML contains _context_meta key"

    - id: "FR-003"
      description: "MUST populate _context_meta.phase_artifacts_bundled as true for all generated phase contexts"
      testable: true
      acceptance_criteria: "All generated phase-X.yaml files have _context_meta.phase_artifacts_bundled: true"

    - id: "FR-004"
      description: "MUST populate _context_meta.bundled_artifacts with list ['spec.yaml', 'plan.yaml', 'tasks.yaml (phase-filtered)']"
      testable: true
      acceptance_criteria: "Generated phase context contains bundled_artifacts list with three expected items"

    - id: "FR-005"
      description: "MUST check for existence of checklists/ directory under spec directory and set _context_meta.has_checklists accordingly"
      testable: true
      acceptance_criteria: "has_checklists is true only when checklists/ directory exists; false otherwise"

    - id: "FR-006"
      description: "MUST populate _context_meta.skip_reads with actual paths to spec.yaml, plan.yaml, tasks.yaml relative to project root"
      testable: true
      acceptance_criteria: "skip_reads contains three entries with actual spec directory paths (e.g., 'specs/feature-name/spec.yaml')"

    - id: "FR-007"
      description: "MUST add Phase Context Metadata section to implement.md template explaining _context_meta usage"
      testable: true
      acceptance_criteria: "implement.md contains section with title 'Phase Context Metadata' and explains all _context_meta fields"

    - id: "FR-008"
      description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
      testable: true
      acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"

  non_functional:
    - id: "NFR-001"
      category: "compatibility"
      description: "Phase context generation MUST remain backward compatible - existing code that doesn't use _context_meta continues to work"
      measurable_target: "All existing phase_context tests pass without modification"

    - id: "NFR-002"
      category: "performance"
      description: "Checklists directory existence check MUST complete in under 1ms"
      measurable_target: "os.Stat call takes <1ms as verified by benchmark or timing in test"

    - id: "NFR-003"
      category: "code_quality"
      description: "All functions must be under 40 lines; extract helpers for complex logic"
      measurable_target: "No function exceeds 40 lines excluding comments"

    - id: "NFR-004"
      category: "code_quality"
      description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
      measurable_target: "Zero bare 'return err' statements in new code"

    - id: "NFR-005"
      category: "code_quality"
      description: "Tests must use map-based table-driven pattern with t.Parallel()"
      measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"

    - id: "NFR-006"
      category: "code_quality"
      description: "Accept interfaces, return concrete types"
      measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Claude agents no longer read individual artifact files when phase context is available"
      metric: "Count of redundant artifact reads per session"
      target: "0 redundant reads when _context_meta.phase_artifacts_bundled is true"

    - id: "SC-002"
      description: "Claude agents no longer check for non-existent checklists directories"
      metric: "Count of checklists directory checks per session"
      target: "0 checks when _context_meta.has_checklists is false"

    - id: "SC-003"
      description: "Token consumption reduced during implementation phases"
      metric: "Estimated tokens saved per session"
      target: "5-15K tokens saved per session by avoiding redundant reads"

key_entities:
  - name: "ContextMeta"
    description: "Metadata structure embedded in phase context to signal file reading behavior to Claude"
    attributes:
      - "PhaseArtifactsBundled: bool indicating artifacts are bundled"
      - "BundledArtifacts: list of bundled artifact names"
      - "HasChecklists: bool indicating checklists directory existence"
      - "SkipReads: list of file paths that should not be read separately"

  - name: "PhaseContext"
    description: "Existing struct that bundles spec, plan, and phase-filtered tasks for implementation"
    attributes:
      - "Phase: current phase number"
      - "TotalPhases: total number of phases"
      - "SpecDir: path to spec directory"
      - "Spec: full spec.yaml content"
      - "Plan: full plan.yaml content"
      - "Tasks: phase-filtered tasks"
      - "ContextMeta: new metadata field (to be added)"

edge_cases:
  - scenario: "Checklists directory exists but is empty"
    expected_behavior: "has_checklists is true (directory exists regardless of contents)"

  - scenario: "Checklists is a file instead of a directory"
    expected_behavior: "has_checklists is false (only true for directories)"

  - scenario: "Spec directory path contains special characters"
    expected_behavior: "skip_reads paths are properly quoted/escaped in YAML output"

  - scenario: "Phase context is read by older Claude prompts without _context_meta handling"
    expected_behavior: "Phase context still works; _context_meta is ignored by old prompts"

  - scenario: "Multiple features being implemented in parallel"
    expected_behavior: "Each feature's phase context has correct paths for its own spec directory"

assumptions:
  - "Claude agents process YAML _context_meta fields when present in phase context"
  - "implement.md template is read by Claude before or during implementation"
  - "os.Stat is the appropriate method for checking directory existence in Go"
  - "YAML underscore-prefixed keys (_context_meta) are valid and will be parsed correctly"
  - "Checklists directory, if present, would be at specs/<feature>/checklists/"

constraints:
  - "Must modify existing PhaseContext struct without breaking YAML serialization"
  - "Cannot change YAML structure in ways that break existing phase context consumers"
  - "implement.md template location must be discovered from codebase"
  - "Performance budget: directory existence check under 1ms"

out_of_scope:
  - "Modifying Claude's behavior directly (relies on documentation to influence behavior)"
  - "Changes to other context generation (task context, full context)"
  - "Validation that Claude actually follows _context_meta signals"
  - "Metrics collection or telemetry for token savings"
  - "Changes to checklists feature itself"
  - "Retroactive updates to existing phase context files"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-18T07:39:08Z"
  artifact_type: "spec"
