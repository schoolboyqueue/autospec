feature:
  branch: "027-claude-settings-validation"
  created: "2025-12-16"
  status: "Completed"
  input: "make a spec for .dev/tasks/claude-settings-validation.md"

implementation_summary:
  completed: "2025-12-16"
  files_created:
    - "internal/claude/doc.go"
    - "internal/claude/settings.go"
    - "internal/claude/settings_test.go"
  files_modified:
    - "internal/cli/init.go"
    - "internal/cli/init_test.go"
    - "internal/health/health.go"
    - "internal/health/health_test.go"
  features:
    - "autospec init auto-creates .claude/settings.local.json with Bash(autospec:*) permission"
    - "autospec doctor validates Claude settings configuration"
    - "Warns on deny list conflicts without overriding user security decisions"
    - "Preserves existing settings when adding permissions"
    - "Atomic writes prevent file corruption"

user_stories:
  - id: "US-001"
    title: "Automatic Claude Code permissions configuration during init"
    priority: "P1"
    as_a: "developer using autospec"
    i_want: "autospec to automatically configure Claude Code permissions when I run init"
    so_that: "Claude can execute autospec commands without manual JSON file editing"
    why_this_priority: "Core functionality - without this permission, autospec workflows fail completely"
    independent_test: "Run autospec init in a project without Claude settings and verify .claude/settings.local.json is created with correct permissions"
    acceptance_scenarios:
      - given: "A project directory with no .claude/ directory"
        when: "User runs autospec init"
        then: ".claude/settings.local.json is created with Bash(autospec:*) permission in allow list"
        message: "Created .claude/settings.local.json with Claude Code permissions for autospec"
      - given: "A project with existing .claude/settings.local.json missing autospec permissions"
        when: "User runs autospec init"
        then: "Bash(autospec:*) permission is added to the existing allow list without removing other settings"
        message: "Added Bash(autospec:*) permission to .claude/settings.local.json"
      - given: "A project with .claude/settings.local.json already containing Bash(autospec:*)"
        when: "User runs autospec init"
        then: "Settings file is unchanged"
        message: "Claude Code permissions already configured"

  - id: "US-002"
    title: "Claude settings validation in doctor command"
    priority: "P1"
    as_a: "developer troubleshooting autospec issues"
    i_want: "autospec doctor to check if Claude Code permissions are correctly configured"
    so_that: "I can quickly identify permission issues before running workflows"
    why_this_priority: "Essential for diagnosing workflow failures caused by missing permissions"
    independent_test: "Run autospec doctor with various Claude settings states and verify appropriate pass/fail messages"
    acceptance_scenarios:
      - given: "A project with no .claude/settings.local.json file"
        when: "User runs autospec doctor"
        then: "Doctor reports failure with message to run 'autospec init'"
        message: "✗ Claude settings: .claude/settings.local.json not found (run 'autospec init' to configure)"
      - given: "A project with settings file missing Bash(autospec:*) permission"
        when: "User runs autospec doctor"
        then: "Doctor reports failure listing the missing permission"
        message: "✗ Claude settings: missing Bash(autospec:*) permission (run 'autospec init' to fix)"
      - given: "A project with correctly configured Claude settings"
        when: "User runs autospec doctor"
        then: "Doctor reports success for Claude settings check"
        message: "✓ Claude settings: Bash(autospec:*) permission configured"

  - id: "US-003"
    title: "Respect user's explicit deny rules"
    priority: "P1"
    as_a: "security-conscious developer"
    i_want: "autospec to warn but not override permissions I've explicitly denied"
    so_that: "My security policies are respected and I maintain control over Claude's permissions"
    why_this_priority: "Security-critical - must not silently override user's explicit security decisions"
    independent_test: "Add Bash(autospec:*) to deny list, run autospec init, verify warning is shown and deny list unchanged"
    acceptance_scenarios:
      - given: "A project with Bash(autospec:*) in the deny list"
        when: "User runs autospec init"
        then: "Warning is displayed explaining the conflict and file is not modified"
        message: "⚠ Warning: Bash(autospec:*) is in your deny list in .claude/settings.local.json. Remove it from permissions.deny to allow autospec commands."
      - given: "A project with Bash(autospec:*) in the deny list"
        when: "User runs autospec doctor"
        then: "Doctor reports the conflict and provides manual resolution instructions"
        message: "✗ Claude settings: Bash(autospec:*) is explicitly denied. Remove from permissions.deny in .claude/settings.local.json to allow autospec commands."

  - id: "US-004"
    title: "Preserve existing Claude settings"
    priority: "P2"
    as_a: "developer with customized Claude settings"
    i_want: "autospec to preserve all my existing settings when adding permissions"
    so_that: "My other Claude configurations remain intact"
    why_this_priority: "Important for user trust but not blocking if missing - users can reconfigure manually"
    independent_test: "Create settings file with custom sandbox and ask configurations, run init, verify all original settings preserved"
    acceptance_scenarios:
      - given: "A project with existing sandbox, ask, and other permission settings"
        when: "User runs autospec init"
        then: "All existing settings are preserved and only the new permission is added to allow list"
      - given: "A project with existing allow list containing other permissions"
        when: "User runs autospec init"
        then: "Existing permissions remain and Bash(autospec:*) is appended without duplicates"

requirements:
  functional:
    - id: "FR-001"
      description: "autospec init MUST create .claude/settings.local.json with Bash(autospec:*) permission if the file does not exist"
      testable: true
      acceptance_criteria: "Running init in a project without .claude/ directory creates the directory and settings file with correct permission"

    - id: "FR-002"
      description: "autospec init MUST merge Bash(autospec:*) into existing allow list if settings file exists but lacks the permission"
      testable: true
      acceptance_criteria: "Existing settings file gains the permission without losing other entries"

    - id: "FR-003"
      description: "autospec init MUST NOT modify settings if Bash(autospec:*) already exists in allow list"
      testable: true
      acceptance_criteria: "File modification timestamp unchanged when permission already present"

    - id: "FR-004"
      description: "autospec init MUST warn and NOT modify settings if Bash(autospec:*) is in the deny list"
      testable: true
      acceptance_criteria: "Warning message displayed and deny list unchanged after init"

    - id: "FR-005"
      description: "autospec doctor MUST report failure if .claude/settings.local.json does not exist"
      testable: true
      acceptance_criteria: "Doctor check fails with message pointing to 'autospec init'"

    - id: "FR-006"
      description: "autospec doctor MUST report failure if Bash(autospec:*) permission is missing from allow list"
      testable: true
      acceptance_criteria: "Doctor check fails listing the specific missing permission"

    - id: "FR-007"
      description: "autospec doctor MUST report success if Claude settings are correctly configured"
      testable: true
      acceptance_criteria: "Doctor check passes with confirmation message"

    - id: "FR-008"
      description: "Settings modifications MUST preserve all existing JSON structure including sandbox, ask, deny, and other fields"
      testable: true
      acceptance_criteria: "Round-trip test: load settings with various fields, add permission, verify all original fields preserved"

    - id: "FR-009"
      description: "Settings files MUST be written with human-readable formatting (pretty-printed JSON)"
      testable: true
      acceptance_criteria: "Written JSON file has proper indentation and is readable"

    - id: "FR-010"
      description: "All settings operations MUST output a user-facing message describing what was done"
      testable: true
      acceptance_criteria: "Every code path (create, modify, skip, warn) outputs an appropriate message to stdout"

  non_functional:
    - id: "NFR-001"
      category: "reliability"
      description: "Claude settings operations must be atomic - partial writes must not corrupt settings files"
      measurable_target: "Write to temp file then rename; never leave malformed JSON"

    - id: "NFR-002"
      category: "usability"
      description: "Error messages must clearly explain what is wrong and how to fix it"
      measurable_target: "All error messages include actionable remediation steps"

    - id: "NFR-003"
      category: "security"
      description: "Only minimum required permissions should be added (principle of least privilege)"
      measurable_target: "Only Bash(autospec:*) is added; no sandbox bypass or broad permissions"

    - id: "NFR-004"
      category: "performance"
      description: "Settings validation must complete quickly"
      measurable_target: "Settings check completes in under 100ms"

    - id: "NFR-005"
      category: "code_quality"
      description: "Go coding standards per PRIN-011"
      measurable_target: |
        Functions must be <40 lines. Extract helpers for complex logic.
        Errors must be wrapped with context: fmt.Errorf("doing X: %w", err).
        Tests use map-based table-driven pattern with t.Parallel().
        Accept interfaces, return concrete types.

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can successfully run autospec workflows without manually editing Claude settings"
      metric: "Percentage of new users who complete first workflow without permission errors"
      target: "100% of users running autospec init first can execute workflows"

    - id: "SC-002"
      description: "autospec doctor accurately identifies Claude permission issues"
      metric: "Detection rate for permission misconfigurations"
      target: "100% of missing permission scenarios are detected and reported"

    - id: "SC-003"
      description: "Existing user configurations are preserved during autospec init"
      metric: "Settings integrity after init"
      target: "100% of existing settings fields preserved after permission addition"

    - id: "SC-004"
      description: "Users receive clear guidance when permissions are denied"
      metric: "User understanding of deny list conflicts"
      target: "Warning messages include specific file path and permission name"

key_entities:
  - name: "Claude Settings"
    description: "JSON configuration file controlling Claude Code permissions for a project or user"
    attributes:
      - "permissions.allow - list of permitted operations"
      - "permissions.ask - list of operations requiring user confirmation"
      - "permissions.deny - list of blocked operations"
      - "sandbox - optional sandbox configuration"

  - name: "Permission Entry"
    description: "A string pattern defining what Claude Code is allowed to do"
    attributes:
      - "Tool name (e.g., Bash, Read, Write)"
      - "Tool arguments pattern (e.g., autospec:*)"
      - "Wildcard support for matching multiple commands"

  - name: "Settings Location"
    description: "Where Claude Code looks for configuration files"
    attributes:
      - "Project local: .claude/settings.local.json (not committed)"
      - "Project shared: .claude/settings.json (committed)"
      - "User global: ~/.claude/settings.json"
      - "Precedence: local > shared > user"

edge_cases:
  - scenario: "Malformed JSON in existing settings file"
    expected_behavior: "Report JSON parse error with file path; do not attempt to modify"

  - scenario: "Read-only settings file"
    expected_behavior: "Report permission error with specific file path"

  - scenario: "settings.local.json is a directory instead of a file"
    expected_behavior: "Report type mismatch error; suggest manual cleanup"

  - scenario: "Disk full during settings write"
    expected_behavior: "Atomic write prevents corruption; report disk space error"

  - scenario: "Permission exists in both allow and deny lists"
    expected_behavior: "Warn about conflicting configuration; deny takes precedence per Claude docs"

  - scenario: "Empty allow array exists (vs missing allow key)"
    expected_behavior: "Both cases handled identically - permission is added to allow list"

  - scenario: "Running autospec init outside of a git repository"
    expected_behavior: "Existing behavior - autospec already requires git repo; Claude settings not checked"

assumptions:
  - "Claude Code settings follow the documented JSON schema from Anthropic"
  - "Project-level settings (.claude/settings.local.json) are sufficient for autospec operation"
  - "Users running autospec init have write access to the project directory"
  - "The .claude/ directory can be created if it doesn't exist"
  - "JSON parsing and writing use standard Go encoding/json library"

constraints:
  - "Must not modify user-level (~/.claude/settings.json) without explicit user consent"
  - "Must not remove or modify any existing permissions in allow, ask, or deny lists"
  - "Must not add permissions beyond Bash(autospec:*)"
  - "Must not enable sandbox bypass or other broad permissions"
  - "Must work with existing autospec init workflow without breaking changes"

out_of_scope:
  - "User-level settings modification (requires explicit --user-settings flag, future enhancement)"
  - "Sandbox configuration (users decide their own sandbox policy)"
  - "Additional build tool permissions like Bash(make:*) (project-specific, defer to user)"
  - "Automatic .gitignore modification for .claude/settings.local.json"
  - "GUI or interactive prompts for permission selection"
  - "Validation of Claude Code installation or version"

_meta:
  version: "1.1.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T19:09:05Z"
  updated: "2025-12-16"
  artifact_type: "spec"
  changelog:
    - version: "1.1.0"
      changes:
        - "Added explicit message requirements to all acceptance scenarios"
        - "Added FR-010 requiring user-facing messages for all settings operations"
        - "Added NFR-005 for Go coding standards per PRIN-011"
