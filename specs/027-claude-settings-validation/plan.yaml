plan:
  branch: "027-claude-settings-validation"
  created: "2025-12-16"
  spec_path: "specs/027-claude-settings-validation/spec.yaml"

summary: |
  This implementation adds Claude Code settings validation and configuration to autospec,
  enabling automatic permission management for Claude CLI tool usage. The approach integrates
  with existing init and doctor commands, following established codebase patterns with a new
  internal/claude package for settings management.

  Key technical decisions: Use a dedicated claude package (not config) to maintain separation
  of concerns; implement atomic JSON writes for safety; integrate with existing health check
  aggregation; follow the multi-phase init pattern with status output.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "encoding/json"
      version: "stdlib"
      purpose: "Parse and write Claude settings.local.json files"
    - name: "github.com/spf13/cobra"
      version: "existing"
      purpose: "CLI command framework (already in use)"
    - name: "github.com/stretchr/testify"
      version: "existing"
      purpose: "Test assertions (already in use)"
  storage: "JSON files (.claude/settings.local.json)"
  testing:
    framework: "go test with testify"
    approach: |
      Unit tests for settings package with map-based table-driven patterns.
      Integration tests for init/doctor command changes using temp directories.
      All tests use t.Parallel() where safe.
  target_platform: "linux, darwin, windows (cross-platform)"
  project_type: "cli"
  performance_goals: "Settings validation <100ms per NFR-004"
  constraints:
    - "Must not modify user-level settings (~/.claude/settings.json)"
    - "Must not remove or modify existing permissions"
    - "Must not add permissions beyond Bash(autospec:*)"
    - "Must use atomic file writes to prevent corruption"
    - "Functions must be <40 lines per PRIN-011"
  scale_scope: "Single project settings file, minimal I/O operations"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Plan includes test tasks before implementation tasks"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "Settings validation integrated into doctor command preflight checks"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Settings check designed for <100ms; simple JSON parse operation"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Init skips modification if permission exists; atomic writes prevent corruption"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Doctor exits 1 on check failure; init returns errors for CLI handling"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "N/A"
      notes: "This feature uses JSON (Claude settings format); not applicable"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "Standard go fmt/vet will be applied"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Plan enforces <40 line functions, error wrapping, map-based tests"
    - name: "Cross-Platform Compatibility (PRIN-008)"
      status: "PASS"
      notes: "Using filepath.Join and os package for cross-platform paths"
    - name: "Explicit Dependencies (PRIN-009)"
      status: "PASS"
      notes: "Only stdlib JSON package needed; no new external dependencies"
    - name: "Documentation Standards (PRIN-010)"
      status: "PASS"
      notes: "docs/claude-settings.md already exists; will be updated if needed"

research_findings:
  decisions:
    - topic: "Package location for Claude settings"
      decision: "Create new internal/claude package"
      rationale: |
        Separation of concerns - Claude settings are not autospec configuration.
        Follows existing pattern of domain-specific packages (health, config, workflow).
        Keeps init.go and doctor.go as thin coordinators.
      alternatives_considered:
        - "Add to internal/config - rejected, mixes concerns"
        - "Add inline to init.go - rejected, lacks reusability"
    - topic: "JSON parsing approach"
      decision: "Use map[string]interface{} for flexible structure"
      rationale: |
        Claude settings schema may evolve; rigid struct limits future compatibility.
        Need to preserve unknown fields when modifying settings.
        Only access specific paths (permissions.allow, permissions.deny).
      alternatives_considered:
        - "Strongly typed struct - rejected, may not preserve unknown fields"
        - "Third-party JSON library - rejected, stdlib sufficient"
    - topic: "Atomic write implementation"
      decision: "Write to temp file, then os.Rename"
      rationale: |
        Standard Go pattern for atomic file operations.
        Prevents corruption on crash or disk-full scenarios.
        Already used in retry state persistence per PRIN-004.
      alternatives_considered:
        - "Direct write - rejected, risk of partial writes"
        - "Backup then write - rejected, more complex, less atomic"
    - topic: "Permission format"
      decision: "Use exact string 'Bash(autospec:*)'"
      rationale: |
        Matches Claude Code permission syntax exactly.
        Wildcard (*) allows all autospec subcommands.
        Minimal privilege - only autospec commands permitted.
      alternatives_considered:
        - "Bash(*) - rejected, too broad"
        - "Separate permissions per subcommand - rejected, maintenance burden"

data_model:
  entities:
    - name: "ClaudeSettings"
      description: "Represents the Claude Code settings.local.json file structure"
      fields:
        - name: "Permissions"
          type: "PermissionsConfig"
          description: "Container for permission lists"
          constraints: "Optional; created if missing"
        - name: "Other fields"
          type: "map[string]interface{}"
          description: "Unknown fields preserved during modification"
          constraints: "Not accessed directly; round-tripped unchanged"
      relationships:
        - target: "PermissionsConfig"
          type: "contains"
          description: "Settings contains permissions configuration"
    - name: "PermissionsConfig"
      description: "Permission lists for Claude Code operations"
      fields:
        - name: "Allow"
          type: "[]string"
          description: "List of permitted operations"
          constraints: "Order not significant; no duplicates"
        - name: "Ask"
          type: "[]string"
          description: "Operations requiring user confirmation"
          constraints: "Not modified by autospec"
        - name: "Deny"
          type: "[]string"
          description: "Blocked operations"
          constraints: "Takes precedence over allow; checked for conflicts"
      relationships:
        - target: "ClaudeSettings"
          type: "belongs-to"
          description: "Permissions is a section within settings"
    - name: "SettingsCheckResult"
      description: "Result of Claude settings validation"
      fields:
        - name: "Status"
          type: "SettingsStatus enum"
          description: "Configured, Missing, NeedsPermission, Denied"
          constraints: "One of four valid states"
        - name: "Message"
          type: "string"
          description: "Human-readable status explanation"
          constraints: "Includes actionable guidance"
        - name: "FilePath"
          type: "string"
          description: "Path to settings file (if exists)"
          constraints: "Empty if file not found"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/claude-settings.md"
      description: "Existing documentation for Claude settings; may need updates"
    - path: "CLAUDE.md"
      description: "Developer guidance; table already includes claude-settings.md"
  source_code:
    - path: "internal/claude/settings.go"
      description: "Core settings loading, validation, and modification functions"
    - path: "internal/claude/settings_test.go"
      description: "Unit tests for settings package"
    - path: "internal/cli/init.go"
      description: "Modified to call Claude settings configuration"
    - path: "internal/cli/init_test.go"
      description: "Expanded tests for Claude settings integration"
    - path: "internal/health/health.go"
      description: "Modified to include Claude settings check"
    - path: "internal/health/health_test.go"
      description: "Expanded tests for Claude settings health check"
  tests:
    - path: "internal/claude/*_test.go"
      description: "Unit tests for claude package"
    - path: "internal/cli/*_test.go"
      description: "Integration tests for CLI commands"
    - path: "internal/health/*_test.go"
      description: "Health check tests"

implementation_phases:
  - phase: 1
    name: "Core Settings Package"
    goal: "Create internal/claude package with settings management functions"
    deliverables:
      - "internal/claude/settings.go with Load, Save, HasPermission, AddPermission, CheckDenyList functions"
      - "internal/claude/settings_test.go with comprehensive test coverage"
      - "Atomic write implementation"
      - "Support for preserving existing settings"
  - phase: 2
    name: "Init Command Integration"
    goal: "Integrate settings configuration into autospec init workflow"
    dependencies:
      - "Phase 1"
    deliverables:
      - "configureClaudeSettings() function in init.go"
      - "Status output for all scenarios (created, updated, unchanged, conflict)"
      - "Tests for init command Claude settings behavior"
  - phase: 3
    name: "Doctor Command Integration"
    goal: "Add Claude settings validation to health checks"
    dependencies:
      - "Phase 1"
    deliverables:
      - "CheckClaudeSettings() function in health.go"
      - "Integration into RunHealthChecks() aggregation"
      - "Tests for doctor command Claude settings check"
  - phase: 4
    name: "Final Validation and Polish"
    goal: "Ensure all acceptance criteria met and code quality standards"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "All tests passing"
      - "make lint passes"
      - "Documentation updates if needed"
      - "Edge case handling verified"

risks:
  - risk: "Claude settings schema may change"
    likelihood: "low"
    impact: "medium"
    mitigation: "Use flexible map parsing that preserves unknown fields; only access known paths"
  - risk: "Permission string format may vary"
    likelihood: "low"
    impact: "low"
    mitigation: "Use exact string matching; document expected format clearly"
  - risk: "Race condition during concurrent init"
    likelihood: "low"
    impact: "low"
    mitigation: "Atomic writes prevent corruption; worst case is redundant permission addition"
  - risk: "Windows path handling differences"
    likelihood: "medium"
    impact: "low"
    mitigation: "Use filepath.Join consistently; add Windows-specific test cases"

open_questions:
  - question: "Should we also check .claude/settings.json (shared project settings)?"
    context: "Currently only targeting settings.local.json; shared settings may also need permissions"
    proposed_resolution: "Defer to future enhancement; local settings sufficient for current use case"
  - question: "Should init be idempotent for settings or warn about re-running?"
    context: "Spec says skip if permission exists; could alternatively always confirm current state"
    proposed_resolution: "Follow spec exactly - silent skip when permission already present, with status message"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T19:20:27Z"
  artifact_type: "plan"
