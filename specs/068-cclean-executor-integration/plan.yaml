plan:
  branch: "068-cclean-executor-integration"
  created: "2025-12-20"
  spec_path: "specs/068-cclean-executor-integration/spec.yaml"

summary: |
  Integrate the cclean library directly into the autospec executor to provide automatic, zero-configuration
  formatting of Claude's stream-json output. The implementation adds an output_style configuration option
  (default|compact|minimal|plain|raw) and --output-style CLI flag to all workflow commands.

  The approach intercepts stdout in the ClaudeExecutor when stream-json mode is detected with -p flag,
  parsing each JSONL line through cclean's parser and rendering via cclean's display package. This replaces
  the need for external post_processor configuration while maintaining backward compatibility with existing
  custom configurations.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/ariel-frischer/claude-clean"
      version: "v0.2.0"
      purpose: "JSONL parsing (parser.StreamMessage) and styled display (display.DisplayMessage)"
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "Configuration file parsing"
  storage: "None"
  testing:
    framework: "Go testing with testify"
    approach: "Table-driven unit tests with t.Parallel(), integration tests for CLI flag parsing"
  target_platform: "Linux, macOS (Intel/Apple Silicon), Windows"
  project_type: "cli"
  performance_goals: "Per-line parsing overhead under 1ms (NFR-005)"
  constraints:
    - "Must use existing cclean library dependency"
    - "Cannot break existing post_processor configurations"
    - "Must maintain backward compatibility with current config schema"
    - "CLI flag names must follow existing autospec conventions (--kebab-case)"
  scale_scope: "Single user CLI tool processing real-time streams"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "PRIN-001: Test-First Development"
      status: "PASS"
      notes: "All new code will have table-driven tests before implementation"
    - name: "PRIN-002: Validation-First Workflow"
      status: "PASS"
      notes: "Config validation added for output_style values"
    - name: "PRIN-003: Performance Standards"
      status: "PASS"
      notes: "Per-line processing targets <1ms overhead as specified in NFR-005"
    - name: "PRIN-006: YAML-First Artifacts"
      status: "PASS"
      notes: "New config option follows existing YAML config patterns"
    - name: "PRIN-007: Code Formatting"
      status: "PASS"
      notes: "All code must pass make fmt and make lint"
    - name: "PRIN-011: Go Coding Standards"
      status: "PASS"
      notes: "Functions <40 lines, error wrapping, map-based table tests"

research_findings:
  decisions:
    - topic: "Stream interception approach"
      decision: "Wrap stdout with io.Pipe in ClaudeExecutor.Execute when stream-json detected"
      rationale: "Allows line-by-line processing without modifying Agent interface; maintains real-time streaming behavior"
      alternatives_considered:
        - "Post-processing entire output after command completion - rejected due to loss of real-time feedback"
        - "Modifying Agent interface to support output transformation - rejected as too invasive"
    - topic: "Detection of stream-json mode"
      decision: "Check Agent.BuildCommand() args for --output-format stream-json and -p flag"
      rationale: "Non-invasive detection using existing BuildCommand API; works for both Agent and legacy paths"
      alternatives_considered:
        - "Adding explicit flag to ExecOptions - rejected as it couples configuration too tightly"
        - "Environment variable detection - rejected as less reliable than arg inspection"
    - topic: "OutputStyle type location"
      decision: "Define in internal/config as string type alias with validation"
      rationale: "Follows existing config pattern; keeps display logic separate from config definition"
      alternatives_considered:
        - "Reuse cclean display.Style directly - rejected to avoid tight coupling"
        - "Define in internal/workflow - rejected as it's primarily a config concern"
    - topic: "Flag propagation to workflow commands"
      decision: "Add --output-style persistent flag to root command, read in each stage command"
      rationale: "Consistent with existing flag patterns (--timeout, --max-retries); reduces duplication"
      alternatives_considered:
        - "Add flag individually to each command - rejected as too repetitive"
        - "Only support config file, no CLI flag - rejected per FR-007 requirement"

data_model:
  entities:
    - name: "OutputStyle"
      description: "Enumeration of supported output formatting styles"
      fields:
        - name: "Value"
          type: "string"
          description: "One of: default, compact, minimal, plain, raw"
          constraints: "Must be validated against allowed values"
      relationships: []
    - name: "StreamFormatter"
      description: "Component wrapping cclean for stream processing"
      fields:
        - name: "style"
          type: "OutputStyle"
          description: "Configured display style"
          constraints: "Immutable after construction"
        - name: "lineNum"
          type: "int"
          description: "Current line number for display"
          constraints: "Increments monotonically"
      relationships:
        - target: "display.Config"
          type: "uses"
          description: "Maps OutputStyle to cclean display configuration"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/cclean.md"
      description: "Updated with native integration documentation"
  source_code:
    - path: "internal/config/output_style.go"
      description: "OutputStyle type definition and validation"
    - path: "internal/workflow/formatter.go"
      description: "StreamFormatter wrapping cclean parser and display"
    - path: "internal/workflow/claude.go"
      description: "Modified to integrate StreamFormatter when stream-json detected"
    - path: "internal/cli/root.go"
      description: "Add --output-style persistent flag"
    - path: "internal/cli/stages/*.go"
      description: "Pass output_style to orchestrator"
    - path: "internal/cli/run.go"
      description: "Pass output_style to orchestrator"
    - path: "internal/cli/all.go"
      description: "Pass output_style to orchestrator"
    - path: "internal/cli/prep.go"
      description: "Pass output_style to orchestrator"
  tests:
    - path: "internal/config/output_style_test.go"
      description: "Validation tests for OutputStyle"
    - path: "internal/workflow/formatter_test.go"
      description: "StreamFormatter unit tests with sample JSONL"
    - path: "internal/workflow/claude_test.go"
      description: "Extended tests for stream-json detection and formatting"

implementation_phases:
  - phase: 1
    name: "Config and Types"
    goal: "Add output_style configuration with validation"
    deliverables:
      - "OutputStyle type with validation function in internal/config/output_style.go"
      - "Unit tests for validation in internal/config/output_style_test.go"
      - "Add output_style field to Configuration struct"
      - "Update GetDefaults() with default value 'default'"
      - "Update GetDefaultConfigTemplate() with documentation"
  - phase: 2
    name: "Stream Formatter"
    goal: "Implement cclean wrapper for stream processing"
    dependencies:
      - "Phase 1"
    deliverables:
      - "StreamFormatter struct in internal/workflow/formatter.go"
      - "ProcessLine() method parsing single JSONL lines"
      - "FormatAndWrite() method for styled output"
      - "Fallback to raw output on parse errors"
      - "Unit tests with sample JSONL in internal/workflow/formatter_test.go"
  - phase: 3
    name: "Executor Integration"
    goal: "Integrate StreamFormatter into ClaudeExecutor"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Add OutputStyle field to ClaudeExecutor"
      - "Detect stream-json + headless mode in Execute/StreamCommand"
      - "Wrap stdout with StreamFormatter when conditions met"
      - "Update tests in internal/workflow/claude_test.go"
  - phase: 4
    name: "CLI Integration"
    goal: "Add --output-style flag to all workflow commands"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Add --output-style persistent flag to root command"
      - "Read flag value in each stage command"
      - "Pass to orchestrator which sets on ClaudeExecutor"
      - "Update help text with valid options"
      - "Integration tests for flag precedence over config"
  - phase: 5
    name: "Documentation and Polish"
    goal: "Update documentation and ensure quality gates pass"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Update docs/cclean.md with native integration"
      - "Update docs/reference.md with --output-style flag"
      - "Verify make test, make fmt, make lint, make build pass"

risks:
  - risk: "cclean API changes breaking integration"
    likelihood: "low"
    impact: "medium"
    mitigation: "Pin to specific version v0.2.0; integration tests catch regressions"
  - risk: "Performance regression from line-by-line parsing"
    likelihood: "low"
    impact: "medium"
    mitigation: "Benchmark tests verify <1ms per line; buffered I/O used"
  - risk: "Breaking existing post_processor configurations"
    likelihood: "low"
    impact: "high"
    mitigation: "Native formatting only activates when post_processor not set"
  - risk: "Raw style produces different output than current behavior"
    likelihood: "medium"
    impact: "low"
    mitigation: "Raw style explicitly bypasses all formatting, matching current unprocessed output"

open_questions:
  - question: "Should raw style strip system reminders like other styles?"
    context: "Raw is documented as passing through unformatted, but users might expect system reminder stripping"
    proposed_resolution: "Raw means completely unprocessed; users wanting stripped raw can parse output separately"
  - question: "What happens when user has both post_processor and output_style configured?"
    context: "Need to decide which takes precedence or if it's an error"
    proposed_resolution: "post_processor takes precedence; output_style only applies when post_processor is empty"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-20T09:33:04Z"
  artifact_type: "plan"
