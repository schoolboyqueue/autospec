feature:
    branch: "068-cclean-executor-integration"
    created: "2025-12-20"
    status: "Completed"
    completed_at: 2025-12-20T09:55:31Z
    input: "Integrate cclean library into autospec executor for automatic stream-json output formatting. When Claude is invoked with --output-format stream-json, automatically parse and display output using cclean library. Add output_style config option (default|compact|minimal|plain|raw) and --output-style CLI flag."
user_stories:
    - id: "US-001"
      title: "Zero-configuration output formatting"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "Claude's stream-json output to be automatically formatted in a readable way"
      so_that: "I can see progress and results clearly without manual configuration"
      why_this_priority: "Core value proposition - eliminates manual post_processor setup and provides immediate usability"
      independent_test: "Run autospec implement with default config, verify output is formatted with box-drawing and colors"
      acceptance_scenarios:
        - given: "autospec is installed with default configuration"
          when: "I run 'autospec implement' with a Claude agent using stream-json output"
          then: "Output displays with box-drawing characters and colors (default style)"
        - given: "Claude command includes --output-format stream-json flag"
          when: "Command executes and produces JSONL output"
          then: "Each JSONL line is parsed and displayed in human-readable format"
    - id: "US-002"
      title: "Choose output formatting style"
      priority: "P2"
      as_a: "developer with specific output preferences"
      i_want: "to configure how Claude output is displayed"
      so_that: "I can adapt the output to my terminal, workflow, or logging requirements"
      why_this_priority: "Important for customization but default style works for most users"
      independent_test: "Configure each style option and verify distinct output appearance"
      acceptance_scenarios:
        - given: "output_style is set to 'compact' in config"
          when: "I run any workflow command"
          then: "Output displays as single-line summaries"
        - given: "output_style is set to 'plain' in config"
          when: "I run any workflow command"
          then: "Output displays without colors, suitable for piping to files"
        - given: "output_style is set to 'raw' in config"
          when: "I run any workflow command"
          then: "Raw stream-json JSONL is displayed without any formatting"
    - id: "US-003"
      title: "Override output style per command"
      priority: "P2"
      as_a: "developer running a specific command"
      i_want: "to override the global output style with a CLI flag"
      so_that: "I can use different formatting for different situations without changing config"
      why_this_priority: "Flexibility for ad-hoc usage, but global config covers most cases"
      independent_test: "Set global config to one style, run with --output-style flag for different style, verify flag wins"
      acceptance_scenarios:
        - given: "Global config has output_style: default"
          when: "I run 'autospec implement --output-style plain'"
          then: "Output displays in plain style (no colors), ignoring global config"
        - given: "No global output_style configured"
          when: "I run 'autospec run --output-style compact'"
          then: "Output displays in compact style"
    - id: "US-004"
      title: "Graceful fallback on parse errors"
      priority: "P1"
      as_a: "developer running autospec"
      i_want: "malformed output lines to be displayed as-is rather than lost"
      so_that: "I never lose visibility into what Claude is outputting"
      why_this_priority: "Critical for debugging and reliability - no data loss during execution"
      independent_test: "Inject malformed JSONL line, verify it appears in output as raw text"
      acceptance_scenarios:
        - given: "Claude outputs a line that is not valid JSON"
          when: "The executor processes this line"
          then: "The raw line is printed to output without causing an error"
        - given: "Stream includes a mix of valid and invalid JSON lines"
          when: "The executor processes the stream"
          then: "Valid lines are formatted, invalid lines are passed through raw"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST detect when Claude command includes '--output-format stream-json' or '-o stream-json' in arguments"
          testable: true
          acceptance_criteria: "Unit test confirms detection of both long and short flag forms in argument list"
        - id: "FR-002"
          description: "MUST only apply stream-json formatting when '-p' flag (headless mode) is present"
          testable: true
          acceptance_criteria: "Formatting skipped when -p flag absent, applied when present"
        - id: "FR-003"
          description: "MUST parse each JSONL line using cclean parser.StreamMessage"
          testable: true
          acceptance_criteria: "Unit test with sample JSONL lines verifies correct parsing"
        - id: "FR-004"
          description: "MUST display parsed messages using cclean display.DisplayMessage with configured style"
          testable: true
          acceptance_criteria: "Each of 5 styles produces visually distinct output"
        - id: "FR-005"
          description: "MUST strip system reminders from output using parser.StripSystemReminders"
          testable: true
          acceptance_criteria: "System reminder content not visible in formatted output"
        - id: "FR-006"
          description: "MUST add 'output_style' field to config schema with validation for: default, compact, minimal, plain, raw"
          testable: true
          acceptance_criteria: "Invalid style values rejected during config load"
        - id: "FR-007"
          description: "MUST add '--output-style' flag to workflow commands: implement, run, specify, plan, tasks, clarify, analyze, checklist, constitution, prep"
          testable: true
          acceptance_criteria: "Each command accepts --output-style flag, help text shows valid options"
        - id: "FR-008"
          description: "MUST prioritize CLI flag over config file value for output_style"
          testable: true
          acceptance_criteria: "Test confirms flag value used when both flag and config are set"
        - id: "FR-009"
          description: "MUST fall back to printing raw line when JSON parsing fails"
          testable: true
          acceptance_criteria: "Malformed input printed as-is, no error thrown"
        - id: "FR-010"
          description: "MUST pass output through unchanged for non-stream-json output modes"
          testable: true
          acceptance_criteria: "Output identical to current behavior when stream-json not detected"
        - id: "FR-011"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-002"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern with t.Parallel()"
          measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
        - id: "NFR-004"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
        - id: "NFR-005"
          category: "performance"
          description: "Line-by-line parsing must not introduce noticeable latency"
          measurable_target: "Per-line processing overhead under 1ms"
        - id: "NFR-006"
          category: "reliability"
          description: "No output data should be lost due to parsing or display errors"
          measurable_target: "100% of input lines appear in output (formatted or raw)"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Users see formatted output with zero additional configuration"
          metric: "Steps required for readable output after fresh install"
          target: "Zero steps - works automatically with default config"
        - id: "SC-002"
          description: "All five output styles produce visually distinct results"
          metric: "Visual inspection of output for each style"
          target: "Each style visually distinguishable from others"
        - id: "SC-003"
          description: "CLI flag successfully overrides global configuration"
          metric: "Output style when flag differs from config"
          target: "100% of commands respect flag over config"
        - id: "SC-004"
          description: "No output data lost during formatting"
          metric: "Lines captured vs lines displayed"
          target: "100% of lines appear in output (formatted or raw)"
key_entities:
    - name: "OutputStyle"
      description: "Configuration option controlling how stream-json output is formatted for display"
      attributes:
        - "Value: one of default, compact, minimal, plain, raw"
        - "Source: config file or CLI flag"
        - "Precedence: CLI flag overrides config"
    - name: "StreamMessage"
      description: "Parsed representation of a single JSONL line from Claude's stream-json output"
      attributes:
        - "Message type (text, tool use, tool result, etc.)"
        - "Content payload"
        - "Metadata (tokens, timing)"
    - name: "DisplayWrapper"
      description: "Component that routes stream output through cclean for formatting"
      attributes:
        - "Configured output style"
        - "Input: io.Reader for JSONL stream"
        - "Output: formatted text to stdout"
edge_cases:
    - scenario: "Claude outputs empty lines in stream-json"
      expected_behavior: "Empty lines are silently skipped, not passed to parser"
    - scenario: "Output contains non-UTF8 bytes"
      expected_behavior: "Invalid bytes handled gracefully, line printed as raw if parsing fails"
    - scenario: "Very long JSON lines (>64KB)"
      expected_behavior: "Lines are processed without truncation or memory issues"
    - scenario: "Claude crashes mid-stream"
      expected_behavior: "All lines received up to crash are displayed, partial final line printed as raw"
    - scenario: "User specifies invalid output_style in config"
      expected_behavior: "Config validation fails with clear error message listing valid options"
    - scenario: "Both -o and --output-format flags present with different values"
      expected_behavior: "Last flag wins (standard flag parsing behavior)"
    - scenario: "Stream-json mode without -p flag"
      expected_behavior: "No formatting applied, output passed through unchanged"
assumptions:
    - "cclean library v0.2.0 parser and display APIs are stable"
    - "Claude's stream-json output format follows documented JSONL schema"
    - "Users running autospec have terminals that support ANSI colors (fallback to plain available)"
    - "Default style (box-drawing, colors) is preferred by majority of users"
    - "Line-by-line parsing is sufficient for all stream-json message types"
constraints:
    - "Must use existing cclean library dependency (github.com/ariel-frischer/claude-clean)"
    - "Cannot break existing behavior for users with custom post_processor configurations"
    - "Must maintain backward compatibility with current config schema"
    - "CLI flag names must follow existing autospec conventions (--kebab-case)"
out_of_scope:
    - "Removing post_processor config option entirely (keep for custom use cases)"
    - "Adding new output styles beyond the five defined (default, compact, minimal, plain, raw)"
    - "Interactive output formatting (this is for headless/scripted execution)"
    - "Formatting non-stream-json output formats (text, json, etc.)"
    - "Customizing colors or box-drawing characters beyond predefined styles"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-20T09:31:34Z"
    artifact_type: "spec"
