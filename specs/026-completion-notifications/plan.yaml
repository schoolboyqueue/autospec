plan:
  branch: "026-completion-notifications"
  created: "2025-12-16"
  spec_path: "specs/026-completion-notifications/spec.yaml"

summary: |
  Implement a cross-platform notification system for autospec that alerts users when
  commands and workflow stages complete. The system uses only os/exec to call native
  OS tools (osascript/afplay on macOS, notify-send/paplay on Linux, PowerShell on Windows),
  ensuring zero external Go dependencies and CGO_ENABLED=0 compatibility.

  The implementation follows the existing config hierarchy pattern, adds notification
  hooks that integrate with the Executor's stage completion callbacks, and provides
  composable configuration for hook types (on_command_complete, on_stage_complete,
  on_error, on_long_running). Notifications are non-blocking and fail gracefully,
  ensuring they never impact command execution or exit codes.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "os/exec"
      version: "stdlib"
      purpose: "Execute native OS notification commands"
    - name: "runtime"
      version: "stdlib"
      purpose: "Detect operating system for platform-specific behavior"
    - name: "koanf"
      version: "v2.1.0"
      purpose: "Load notification config through existing hierarchical config system"
  storage: "None"
  testing:
    framework: "testing (stdlib)"
    approach: |
      Unit tests for notification config parsing and hook logic.
      Table-driven tests for platform detection and command building.
      Integration tests mock os/exec to verify notification dispatch.
      Manual testing on each platform for end-to-end verification.
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Notification dispatch <100ms, non-blocking execution"
  constraints:
    - "No external Go dependencies for notifications - os/exec only"
    - "No CGO required - must compile with CGO_ENABLED=0"
    - "Notifications must not block command execution"
    - "Notification failures must not affect exit codes"
    - "Must integrate with existing config hierarchy"
  scale_scope: "Single-user CLI tool, notifications are local to user session"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests will be written before implementation for notification package"
    - name: "Validation-First Workflow"
      status: "N/A"
      notes: "Feature does not introduce new workflow phases - hooks into existing stages"
    - name: "Performance Standards"
      status: "PASS"
      notes: "Notification dispatch <100ms requirement aligns with performance contract"
    - name: "Idempotency and Retry Logic"
      status: "PASS"
      notes: "Notifications are fire-and-forget, no state persistence needed"
    - name: "Standardized Exit Codes"
      status: "PASS"
      notes: "Notification failures will not affect command exit codes"
    - name: "YAML-First Artifacts"
      status: "PASS"
      notes: "Configuration uses existing YAML config system"
    - name: "Code Formatting"
      status: "PASS"
      notes: "All code will pass go fmt and go vet"
    - name: "Cross-Platform Compatibility"
      status: "PASS"
      notes: "Core feature requirement - Linux, macOS, Windows support"
    - name: "Explicit Dependencies"
      status: "PASS"
      notes: "No new external dependencies - stdlib only"
    - name: "Documentation Standards"
      status: "PASS"
      notes: "Public API will be documented, config options in docs/reference.md"

research_findings:
  decisions:
    - topic: "Notification library vs os/exec"
      decision: "Use os/exec to call native OS tools directly"
      rationale: |
        Spec constraint NFR-004 requires no external Go dependencies. Using os/exec
        with native tools (osascript, notify-send, PowerShell) provides reliable
        cross-platform support without adding dependencies or requiring CGO.
      alternatives_considered:
        - "github.com/gen2brain/beeep - Go notification library (rejected: external dependency)"
        - "github.com/0xAX/notificator - Cross-platform notifications (rejected: external dependency)"
        - "CGO bindings to native APIs (rejected: breaks CGO_ENABLED=0 requirement)"
    - topic: "Sound playback approach"
      decision: "Use native audio tools: afplay (macOS), paplay (Linux), PowerShell (Windows)"
      rationale: |
        These tools are standard on their respective platforms and support common
        audio formats. No bundled sounds - uses system sounds or user-provided paths.
      alternatives_considered:
        - "Go audio libraries (rejected: external dependencies, CGO often required)"
        - "ASCII bell character (rejected: unreliable, poor UX)"
    - topic: "Notification timing strategy"
      decision: "Fire notifications asynchronously with goroutine and timeout"
      rationale: |
        Notifications must not block command execution (NFR-001 <100ms).
        Using goroutines with context timeout ensures graceful degradation.
      alternatives_considered:
        - "Synchronous execution (rejected: could block command completion)"
        - "Background process (rejected: adds complexity, harder to test)"
    - topic: "Hook architecture"
      decision: "Integrate via callback interface in Executor.completeStageSuccess()"
      rationale: |
        The Executor already has a callback pattern with ProgressDisplay.
        Adding NotificationHandler follows the same pattern without changing interfaces.
      alternatives_considered:
        - "Event bus pattern (rejected: over-engineered for simple callbacks)"
        - "Channel-based pub/sub (rejected: unnecessary complexity)"
    - topic: "Configuration structure"
      decision: "Nested notification config under 'notifications' key in config"
      rationale: |
        Groups all notification settings logically. Supports env var overrides
        via AUTOSPEC_NOTIFICATIONS_* prefix.
      alternatives_considered:
        - "Flat config keys (rejected: harder to manage related settings)"
        - "Separate notification config file (rejected: fragments configuration)"

data_model:
  entities:
    - name: "NotificationConfig"
      description: "User preferences for notification behavior stored in config"
      fields:
        - name: "Enabled"
          type: "bool"
          description: "Master switch for all notifications"
          constraints: "Default: false (opt-in)"
        - name: "Type"
          type: "string"
          description: "Notification output type: sound, visual, both"
          constraints: "Enum: sound|visual|both. Default: both"
        - name: "SoundFile"
          type: "string"
          description: "Custom sound file path (optional)"
          constraints: "Must be valid audio file if set"
        - name: "OnCommandComplete"
          type: "bool"
          description: "Notify when any command finishes"
          constraints: "Default: true (when enabled)"
        - name: "OnStageComplete"
          type: "bool"
          description: "Notify after each workflow stage"
          constraints: "Default: false"
        - name: "OnError"
          type: "bool"
          description: "Notify on command/stage failure"
          constraints: "Default: true (when enabled)"
        - name: "OnLongRunning"
          type: "bool"
          description: "Notify only if duration exceeds threshold"
          constraints: "Default: false"
        - name: "LongRunningThreshold"
          type: "time.Duration"
          description: "Threshold for on_long_running hook"
          constraints: "Default: 30s. 0 or negative means always notify"
      relationships: []
    - name: "Notification"
      description: "A single notification event to dispatch"
      fields:
        - name: "Title"
          type: "string"
          description: "Notification title (e.g., 'autospec')"
          constraints: "Required, non-empty"
        - name: "Message"
          type: "string"
          description: "Notification body text"
          constraints: "Required, non-empty"
        - name: "NotificationType"
          type: "string"
          description: "Event type: success, failure, info"
          constraints: "Enum: success|failure|info"
      relationships: []
    - name: "NotificationSender"
      description: "Platform-specific notification dispatcher"
      fields:
        - name: "Platform"
          type: "string"
          description: "Detected OS platform"
          constraints: "Enum: darwin|linux|windows"
        - name: "VisualAvailable"
          type: "bool"
          description: "Whether visual notifications are supported"
          constraints: "Detected at runtime"
        - name: "SoundAvailable"
          type: "bool"
          description: "Whether sound notifications are supported"
          constraints: "Detected at runtime"
      relationships:
        - target: "NotificationConfig"
          type: "uses"
          description: "Reads config to determine notification behavior"
        - target: "Notification"
          type: "dispatches"
          description: "Sends notifications to OS"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/reference.md"
      description: "Update CLI reference with notification config options"
    - path: "docs/troubleshooting.md"
      description: "Add notification troubleshooting section"
  source_code:
    - path: "internal/notify/"
      description: "New notification package with platform-specific senders"
    - path: "internal/notify/notify.go"
      description: "Core notification types and interfaces"
    - path: "internal/notify/sender.go"
      description: "Platform detection and dispatch logic"
    - path: "internal/notify/darwin.go"
      description: "macOS notification implementation"
    - path: "internal/notify/linux.go"
      description: "Linux notification implementation"
    - path: "internal/notify/windows.go"
      description: "Windows notification implementation"
    - path: "internal/config/config.go"
      description: "Update to include NotificationConfig struct"
    - path: "internal/config/defaults.go"
      description: "Add notification defaults"
    - path: "internal/workflow/executor.go"
      description: "Add NotificationHandler callback to Executor"
  tests:
    - path: "internal/notify/notify_test.go"
      description: "Unit tests for notification types and config"
    - path: "internal/notify/sender_test.go"
      description: "Tests for platform detection and dispatch logic"
    - path: "internal/notify/darwin_test.go"
      description: "macOS-specific notification tests"
    - path: "internal/notify/linux_test.go"
      description: "Linux-specific notification tests"
    - path: "internal/notify/windows_test.go"
      description: "Windows-specific notification tests"

implementation_phases:
  - phase: 1
    name: "Core Notification Package"
    goal: "Create internal/notify package with types, interfaces, and platform detection"
    deliverables:
      - "NotificationConfig struct with YAML tags"
      - "Notification struct for individual notifications"
      - "NotificationSender interface definition"
      - "Platform detection using runtime.GOOS"
      - "Tool availability checks using exec.LookPath"
      - "Unit tests for all types and detection logic"
  - phase: 2
    name: "Platform-Specific Implementations"
    goal: "Implement notification senders for each operating system"
    dependencies:
      - "Phase 1"
    deliverables:
      - "macOS sender using osascript for visual and afplay for sound"
      - "Linux sender using notify-send for visual and paplay for sound"
      - "Windows sender using PowerShell for toast notifications and sound"
      - "Graceful fallback when tools unavailable"
      - "Platform-specific tests with mocked exec"
  - phase: 3
    name: "Configuration Integration"
    goal: "Integrate notification config with existing config hierarchy"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Add notifications section to Configuration struct"
      - "Add notification defaults to GetDefaults()"
      - "Environment variable support (AUTOSPEC_NOTIFICATIONS_*)"
      - "Config validation for notification settings"
      - "Tests for config loading and validation"
  - phase: 4
    name: "Executor Integration"
    goal: "Hook notifications into workflow executor callbacks"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "Add NotificationHandler to Executor struct"
      - "Call notifications from completeStageSuccess()"
      - "Call notifications from error handlers"
      - "Track command duration for on_long_running hook"
      - "Async dispatch with goroutine and timeout"
      - "Integration tests verifying hook behavior"
  - phase: 5
    name: "CLI Integration and Documentation"
    goal: "Wire everything together and document the feature"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Initialize NotificationHandler in CLI commands"
      - "Add notification config examples to reference docs"
      - "Add troubleshooting guidance for notification issues"
      - "End-to-end manual testing on all platforms"
      - "Update CLAUDE.md if needed"

risks:
  - risk: "Platform-specific tools missing on some systems"
    likelihood: "medium"
    impact: "low"
    mitigation: "Graceful degradation - notifications silently fail without affecting commands"
  - risk: "Sound playback fails on systems without audio"
    likelihood: "medium"
    impact: "low"
    mitigation: "Sound failures don't block; visual-only fallback when sound unavailable"
  - risk: "Notification blocking command completion"
    likelihood: "low"
    impact: "high"
    mitigation: "Async dispatch with context timeout ensures <100ms completion"
  - risk: "CI/CD environments triggering unwanted notifications"
    likelihood: "medium"
    impact: "low"
    mitigation: "Notifications disabled by default; TTY detection to skip in non-interactive"
  - risk: "Windows PowerShell execution policy blocking notifications"
    likelihood: "low"
    impact: "medium"
    mitigation: "Use -ExecutionPolicy Bypass for toast script; document workaround if needed"

open_questions:
  - question: "Should notifications be suppressed automatically in CI environments?"
    context: "Some CI systems have display variables set but no actual display"
    proposed_resolution: "Check for CI environment variables (CI, GITHUB_ACTIONS, etc.) and disable"
  - question: "What sound should be used as default?"
    context: "Spec says 'uses system sounds only' - no bundled sounds"
    proposed_resolution: |
      Use platform defaults: macOS system sound via afplay /System/Library/Sounds/Glass.aiff,
      Linux via paplay with freedesktop sound (if available), Windows via PowerShell beep

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T18:31:39Z"
  artifact_type: "plan"
