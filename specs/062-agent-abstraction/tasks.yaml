tasks:
    branch: "062-agent-abstraction"
    created: "2025-12-19"
    spec_path: "specs/062-agent-abstraction/spec.yaml"
    plan_path: "specs/062-agent-abstraction/plan.yaml"
summary:
    total_tasks: 32
    total_phases: 9
    parallel_opportunities: 12
    estimated_complexity: "high"
phases:
    - number: 1
      title: "Setup"
      purpose: "Create new internal/cliagent/ package structure"
      tasks:
        - id: "T001"
          title: "Create internal/cliagent/ package directory structure"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/cliagent/"
          dependencies: []
          acceptance_criteria:
            - "Directory internal/cliagent/ exists"
            - "Package compiles without errors"
    - number: 2
      title: "Foundational"
      purpose: "Core interfaces, types, and registry that MUST be complete before user stories"
      tasks:
        - id: "T002"
          title: "Implement Agent interface and core types in agent.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/cliagent/agent.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "Agent interface defines Name(), Version(), Validate(), BuildCommand(), Execute(), Capabilities() methods"
            - "Types compile correctly"
            - "Unit tests pass"
        - id: "T003"
          title: "Implement Caps struct and PromptDelivery in capabilities.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/cliagent/capabilities.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "Caps struct has Automatable, PromptDelivery, AutonomousFlag, AutonomousEnv, RequiredEnv, OptionalEnv fields"
            - "PromptDelivery struct has Method, Flag, PromptFlag fields"
            - "Method enum supports: arg, positional, subcommand, subcommand-arg, template"
        - id: "T004"
          title: "Implement ExecOptions and Result types in options.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/cliagent/options.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "ExecOptions has Autonomous, Timeout, WorkDir, ExtraArgs, Env, Stdout, Stderr fields"
            - "Result has ExitCode, Stdout, Stderr, Duration fields"
        - id: "T005"
          title: "Implement thread-safe Registry in registry.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/cliagent/registry.go"
          dependencies: ["T002", "T003", "T004"]
          acceptance_criteria:
            - "Registry uses sync.RWMutex for thread-safe access"
            - "Register(), Get(), List(), Available() methods implemented"
            - "Default global registry instance exported"
            - "go test -race passes for registry tests"
        - id: "T006"
          title: "Implement BaseAgent shared functionality in base.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/cliagent/base.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "BaseAgent embeds name, cmd, versionFlag, caps fields"
            - "Validate() checks CLI in PATH and required env vars"
            - "Version() executes CLI with version flag"
            - "Execute() builds command, runs it, captures output"
            - "BuildCommand() constructs exec.Cmd based on PromptDelivery method"
    - number: 3
      title: "User Story 1 - US-001: Switch between AI coding agents"
      purpose: "Enable users to switch between different CLI AI coding agents"
      story_reference: "US-001"
      independent_test: "Configure autospec to use each supported agent and verify it correctly invokes that agent's CLI"
      tasks:
        - id: "T007"
          title: "Implement Claude Code agent in claude.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/cliagent/claude.go"
          dependencies: ["T006"]
          acceptance_criteria:
            - "Uses 'claude' command with -p flag for prompt"
            - "Autonomous mode uses --dangerously-skip-permissions flag"
            - "RequiredEnv includes ANTHROPIC_API_KEY"
            - "BuildCommand produces correct CLI invocation"
        - id: "T008"
          title: "Implement Cline agent in cline.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/cliagent/cline.go"
          dependencies: ["T006"]
          acceptance_criteria:
            - "Uses 'cline' command with positional prompt"
            - "Autonomous mode uses --auto-approve flag"
            - "BuildCommand produces correct CLI invocation"
        - id: "T009"
          title: "Implement Gemini CLI agent in gemini.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/cliagent/gemini.go"
          dependencies: ["T006"]
          acceptance_criteria:
            - "Uses 'gemini' command with positional prompt"
            - "Autonomous mode uses --yolo flag or equivalent"
            - "RequiredEnv includes GEMINI_API_KEY"
            - "BuildCommand produces correct CLI invocation"
        - id: "T010"
          title: "Implement Codex CLI agent in codex.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/cliagent/codex.go"
          dependencies: ["T006"]
          acceptance_criteria:
            - "Uses 'codex' command with 'exec' subcommand"
            - "Prompt passed as positional after subcommand"
            - "Autonomous mode uses --auto-approve flag"
            - "BuildCommand produces correct CLI invocation"
        - id: "T011"
          title: "Implement OpenCode agent in opencode.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/cliagent/opencode.go"
          dependencies: ["T006"]
          acceptance_criteria:
            - "Uses 'opencode' command with appropriate prompt delivery"
            - "BuildCommand produces correct CLI invocation"
        - id: "T012"
          title: "Implement Goose agent in goose.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-001"
          file_path: "internal/cliagent/goose.go"
          dependencies: ["T006"]
          acceptance_criteria:
            - "Uses 'goose' command with 'run' subcommand and -t flag for prompt"
            - "PromptDelivery uses subcommand-arg method"
            - "BuildCommand produces correct CLI invocation"
        - id: "T013"
          title: "Implement agent registration in init.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cliagent/init.go"
          dependencies: ["T007", "T008", "T009", "T010", "T011", "T012"]
          acceptance_criteria:
            - "Package init() registers all 6 Tier 1 agents with Default registry"
            - "Agents registered by name: claude, cline, gemini, codex, opencode, goose"
        - id: "T014"
          title: "Implement interface conformance tests in conformance_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cliagent/conformance_test.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "All 6 agents pass interface conformance tests"
            - "BuildCommand tests verify correct CLI patterns per agent"
            - "Tests use map-based table-driven pattern with t.Parallel()"
    - number: 4
      title: "User Story 2 - US-002: Use custom agent via template"
      purpose: "Enable power users to define custom agent commands using {{PROMPT}} template"
      story_reference: "US-002"
      independent_test: "Configure a custom agent template and verify the prompt is correctly substituted and executed"
      tasks:
        - id: "T015"
          title: "Implement CustomAgent with {{PROMPT}} template expansion in custom.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cliagent/custom.go"
          dependencies: ["T006"]
          acceptance_criteria:
            - "NewCustomAgent validates template contains {{PROMPT}} placeholder"
            - "BuildCommand expands template with shell-safe prompt substitution"
            - "Uses google/shlex for parsing command template"
            - "Handles special characters, quotes, newlines in prompts"
            - "Returns validation error if {{PROMPT}} missing"
        - id: "T016"
          title: "Add unit tests for CustomAgent template expansion"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cliagent/custom_test.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "Tests cover: basic substitution, special chars, quotes, newlines"
            - "Tests validate error for missing {{PROMPT}}"
            - "Tests use map-based table-driven pattern with t.Parallel()"
    - number: 5
      title: "User Story 5 - US-005: Maintain backward compatibility"
      purpose: "Ensure existing claude_cmd and custom_claude_cmd configurations continue working"
      story_reference: "US-005"
      independent_test: "Use deprecated config fields and verify autospec still functions correctly"
      tasks:
        - id: "T017"
          title: "Add agent_preset and custom_agent_cmd fields to Config struct"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/config/config.go"
          dependencies: ["T013", "T015"]
          acceptance_criteria:
            - "agent_preset field added (string, optional)"
            - "custom_agent_cmd field added (string, optional)"
            - "Fields parsed from YAML config files"
            - "Fields can be set via environment variables"
        - id: "T018"
          title: "Implement GetAgent() method with priority order"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/config/config.go"
          dependencies: ["T017"]
          acceptance_criteria:
            - "Priority: custom_agent_cmd > agent_preset > legacy fields > default (claude)"
            - "Returns cliagent.Agent based on configuration"
            - "Handles all combinations of fields correctly"
        - id: "T019"
          title: "Implement deprecation warnings for legacy config fields"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/config/config.go"
          dependencies: ["T018"]
          acceptance_criteria:
            - "Deprecation warnings emitted to stderr (not stdout)"
            - "Warnings for claude_cmd, claude_args, custom_claude_cmd"
            - "Warnings include migration guidance"
            - "Legacy fields still function correctly"
        - id: "T020"
          title: "Add tests for config priority and backward compatibility"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-005"
          file_path: "internal/config/agent_test.go"
          dependencies: ["T019"]
          acceptance_criteria:
            - "Tests verify priority order: custom_agent_cmd > agent_preset > legacy > default"
            - "Tests verify legacy fields still work"
            - "Tests verify deprecation warnings appear on stderr"
            - "Tests use map-based table-driven pattern with t.Parallel()"
    - number: 6
      title: "User Story 4 - US-004: Override agent at runtime"
      purpose: "Allow developers to override configured agent for a single command using CLI flag"
      story_reference: "US-004"
      independent_test: "Run autospec with --agent flag and verify it uses the specified agent instead of configured default"
      tasks:
        - id: "T021"
          title: "Refactor workflow/claude.go to use Agent interface"
          status: "Completed"
          type: "refactor"
          parallel: false
          story_id: "US-004"
          file_path: "internal/workflow/claude.go"
          dependencies: ["T020"]
          acceptance_criteria:
            - "ClaudeExecutor accepts Agent interface instead of hardcoding Claude"
            - "Execute() delegates to agent.Execute()"
            - "Maintains existing streaming and timeout behavior"
            - "Existing tests pass after refactor"
        - id: "T022"
          title: "Add --agent flag to run command"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-004"
          file_path: "internal/cli/root.go"
          dependencies: ["T021"]
          acceptance_criteria:
            - "--agent flag added to run command"
            - "Flag overrides agent_preset for single execution"
            - "Unknown agent name shows error with available agents list"
        - id: "T023"
          title: "Add --agent flag to implement command"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-004"
          file_path: "internal/cli/stages/implement.go"
          dependencies: ["T021"]
          acceptance_criteria:
            - "--agent flag added to implement command"
            - "Flag overrides agent_preset for single execution"
        - id: "T024"
          title: "Add --agent flag to prep command"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-004"
          file_path: "internal/cli/stages/prep.go"
          dependencies: ["T021"]
          acceptance_criteria:
            - "--agent flag added to prep command"
            - "Flag overrides agent_preset for single execution"
        - id: "T025"
          title: "Add --agent flag to specify, plan, tasks commands"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-004"
          file_path: "internal/cli/stages/"
          dependencies: ["T021"]
          acceptance_criteria:
            - "--agent flag added to specify, plan, tasks commands"
            - "Flag overrides agent_preset for single execution"
            - "All 6 workflow commands support --agent flag"
    - number: 7
      title: "User Story 3 - US-003: Discover available agents"
      purpose: "Enable users to see which agents are installed and properly configured"
      story_reference: "US-003"
      independent_test: "Run doctor command and verify it reports status for all registered agents"
      tasks:
        - id: "T026"
          title: "Implement Registry.Doctor() method for agent diagnostics"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/cliagent/registry.go"
          dependencies: ["T014"]
          acceptance_criteria:
            - "Doctor() returns status for all registered agents"
            - "Shows installed status, version, validity, errors for each agent"
            - "Performance under 100ms per agent validation"
        - id: "T027"
          title: "Extend doctor command with agent status reporting"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/health/health.go"
          dependencies: ["T026"]
          acceptance_criteria:
            - "Doctor output includes agent section"
            - "Shows each registered agent with status"
            - "Indicates installed/not-installed, valid/invalid"
            - "Shows missing env vars for invalid agents"
        - id: "T028"
          title: "Add tests for doctor agent reporting"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-003"
          file_path: "internal/health/health_test.go"
          dependencies: ["T027"]
          acceptance_criteria:
            - "Tests verify agent status appears in doctor output"
            - "Tests verify error reporting for unavailable agents"
    - number: 8
      title: "Documentation"
      purpose: "Create user-facing documentation for agent configuration"
      tasks:
        - id: "T029"
          title: "Create docs/agents.md user guide"
          status: "Pending"
          type: "documentation"
          parallel: true
          story_id: null
          file_path: "docs/agents.md"
          dependencies: ["T025", "T027"]
          acceptance_criteria:
            - "Documents all 6 Tier 1 agents with examples"
            - "Explains agent_preset and custom_agent_cmd configuration"
            - "Shows migration from legacy claude_cmd/custom_claude_cmd"
            - "Documents --agent CLI flag usage"
        - id: "T030"
          title: "Update docs/reference.md with --agent flag"
          status: "Pending"
          type: "documentation"
          parallel: true
          story_id: null
          file_path: "docs/reference.md"
          dependencies: ["T025"]
          acceptance_criteria:
            - "--agent flag documented for all workflow commands"
            - "Shows available agent names"
    - number: 9
      title: "Polish & Quality Gates"
      purpose: "Ensure all quality gates pass and final cleanup"
      tasks:
        - id: "T031"
          title: "Run make fmt, make lint, make test, make build"
          status: "Pending"
          type: "refactor"
          parallel: false
          story_id: null
          file_path: "."
          dependencies: ["T028", "T029", "T030"]
          acceptance_criteria:
            - "make fmt produces no changes"
            - "make lint produces no errors"
            - "make test passes all tests"
            - "make build succeeds"
            - "go test -race passes for cliagent package"
        - id: "T032"
          title: "Verify backward compatibility with existing configs"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: null
          file_path: "."
          dependencies: ["T031"]
          acceptance_criteria:
            - "Legacy claude_cmd config works"
            - "Legacy custom_claude_cmd config works"
            - "Deprecation warnings visible on stderr"
            - "No breaking changes to existing functionality"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-002", "US-003", "US-004", "US-005"]
        - story_id: "US-002"
          depends_on: []
          blocks: ["US-005"]
        - story_id: "US-005"
          depends_on: ["US-001", "US-002"]
          blocks: ["US-004"]
        - story_id: "US-004"
          depends_on: ["US-005"]
          blocks: ["US-003"]
        - story_id: "US-003"
          depends_on: ["US-001"]
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2]
        - phase: 2
          blocks: [3, 4, 5]
        - phase: 3
          blocks: [6, 7]
        - phase: 4
          blocks: [5]
        - phase: 5
          blocks: [6]
        - phase: 6
          blocks: [7, 8]
        - phase: 7
          blocks: [8, 9]
        - phase: 8
          blocks: [9]
parallel_execution:
    - phase: 2
      parallel_groups:
        - tasks: ["T002", "T003", "T004"]
          rationale: "Independent type definitions, no dependencies between them"
    - phase: 3
      parallel_groups:
        - tasks: ["T007", "T008", "T009", "T010", "T011", "T012"]
          rationale: "Each agent is independent implementation, no dependencies between agents"
    - phase: 6
      parallel_groups:
        - tasks: ["T022", "T023", "T024", "T025"]
          rationale: "Each command is independent, can add --agent flag in parallel"
    - phase: 8
      parallel_groups:
        - tasks: ["T029", "T030"]
          rationale: "Documentation files are independent"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3, 4, 5]
        description: "Setup + Foundational + Agent Implementations + CustomAgent + Backward Compatibility"
        validation: "Run autospec with agent_preset: gemini and verify it invokes Gemini CLI correctly"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2]
          deliverable: "Agent interface and registry available for use"
        - milestone: "Agents Implemented"
          phases: [1, 2, 3, 4]
          deliverable: "All 6 Tier 1 agents + CustomAgent functional"
        - milestone: "Config Integration Complete"
          phases: [1, 2, 3, 4, 5]
          deliverable: "New config fields working with backward compatibility"
        - milestone: "CLI Flags Complete"
          phases: [1, 2, 3, 4, 5, 6]
          deliverable: "All workflow commands support --agent flag"
        - milestone: "Feature Complete"
          phases: [1, 2, 3, 4, 5, 6, 7, 8, 9]
          deliverable: "Full feature with docs and quality gates passed"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-19T20:39:33Z"
    artifact_type: "tasks"
