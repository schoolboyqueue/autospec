plan:
  branch: "067-agent-init-config"
  created: "2025-12-19"
  spec_path: "specs/067-agent-init-config/spec.yaml"

summary: |
  Implement agent-aware initialization for autospec that prompts users to select which AI coding
  agents (claude, cline, codex, gemini, goose, opencode) to configure during `autospec init`.

  The implementation adds a Configurator interface to internal/cliagent that agents can implement
  for project-level setup. Claude implements this interface to configure .claude/settings.local.json
  with required permissions (Bash(autospec:*), Write/Edit for .autospec/** and specs/**). Agent
  selections persist in config as default_agents for pre-selection on subsequent init runs.

  This approach replaces the current unconditional Claude auto-configuration with a user-driven
  multi-select prompt, improving flexibility for users of different AI coding agents while
  maintaining full Claude Code support.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI framework for command structure"
    - name: "github.com/knadh/koanf/v2"
      version: "v2.3.0"
      purpose: "Configuration management with hierarchy"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for config files"
    - name: "github.com/fatih/color"
      version: "v1.18.0"
      purpose: "Terminal colors for prompt output"
  storage: "YAML config files, JSON for Claude settings"
  testing:
    framework: "Go testing with testify"
    approach: "Table-driven unit tests with t.Parallel(); integration tests for init command"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Agent selection prompt completes in <5 seconds; validation <100ms"
  constraints:
    - "No new external dependencies for prompts - use stdlib terminal I/O"
    - "Backward compatible with existing autospec installations"
    - "Additive-only permission changes (non-destructive)"
    - "Must work offline after initial setup"
  scale_scope: "Single project initialization; 6 built-in agents"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests will be written first for Configurator interface, promptAgentSelection, and Claude.ConfigureProject"
    - name: "Validation-First Workflow"
      status: "PASS"
      notes: "Agent selection validates input; config persistence validates saved data"
    - name: "Performance Standards"
      status: "PASS"
      notes: "Interactive prompt is user-driven; validation remains <100ms"
    - name: "Idempotency and Retry Logic"
      status: "PASS"
      notes: "Configuration is idempotent; re-running init with same agents produces same result"
    - name: "Go Coding Standards"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, table-driven tests, interfaces in signatures"
    - name: "Code Formatting"
      status: "PASS"
      notes: "All code will pass gofmt and govet"
    - name: "Command Template Independence"
      status: "N/A"
      notes: "No command templates modified in this feature"

research_findings:
  decisions:
    - topic: "Multi-select prompt library"
      decision: "Use stdlib bufio/fmt for simple multi-select without new dependencies"
      rationale: |
        The spec requires keyboard navigation (arrow keys, space, enter). Rather than adding
        a dependency like bubbletea or survey, we can implement a simple numbered-list multi-select
        using stdin/stdout that works in all terminals including non-TTY with fallback.
      alternatives_considered:
        - "charmbracelet/bubbletea - Rich TUI but adds 2MB+ to binary"
        - "AlecAivazis/survey - Well-designed but maintenance status uncertain"
        - "manifoldco/promptui - Good API but adds dependency"
    - topic: "Configurator interface location"
      decision: "Add to internal/cliagent package alongside Agent interface"
      rationale: |
        The cliagent package already defines the Agent interface and all agent implementations.
        Configurator is an optional extension interface that agents may implement for project
        setup, keeping related abstractions together.
      alternatives_considered:
        - "New internal/configure package - Unnecessary indirection"
        - "Inline in init_cmd.go - Poor separation of concerns"
    - topic: "Permission generation strategy"
      decision: "Claude implements Configurator with specsDir parameter for dynamic paths"
      rationale: |
        FR-007 requires using the configured specs_dir, not hardcoded 'specs'. The Configurator
        interface passes specsDir as a parameter, and Claude's ConfigureProject builds permission
        strings dynamically.
      alternatives_considered:
        - "Template strings in config - Less type-safe"
        - "Hardcoded permission list - Fails FR-007"

data_model:
  entities:
    - name: "Configurator"
      description: "Interface for agents that need project-level setup"
      fields:
        - name: "ConfigureProject"
          type: "func(projectDir, specsDir string) (ConfigResult, error)"
          description: "Configures agent for the given project"
          constraints: "Must be idempotent"
      relationships: []
    - name: "ConfigResult"
      description: "Result of agent configuration"
      fields:
        - name: "PermissionsAdded"
          type: "[]string"
          description: "List of permissions that were added"
          constraints: "May be empty if already configured"
        - name: "AlreadyConfigured"
          type: "bool"
          description: "True if no changes were needed"
          constraints: "None"
        - name: "Warning"
          type: "string"
          description: "Optional warning message (e.g., deny list conflict)"
          constraints: "Empty if no warning"
      relationships:
        - target: "Configurator"
          type: "returned-by"
          description: "ConfigureProject returns ConfigResult"
    - name: "AgentOption"
      description: "Agent displayed in multi-select prompt"
      fields:
        - name: "Name"
          type: "string"
          description: "Agent identifier (e.g., 'claude')"
          constraints: "Must match registered agent name"
        - name: "DisplayName"
          type: "string"
          description: "Human-readable name for prompt"
          constraints: "None"
        - name: "Recommended"
          type: "bool"
          description: "Whether this is the recommended default"
          constraints: "Only claude is recommended"
        - name: "Selected"
          type: "bool"
          description: "Whether agent is currently selected"
          constraints: "Bound to user input"
      relationships:
        - target: "Agent"
          type: "represents"
          description: "AgentOption represents an Agent in the selection UI"
    - name: "DefaultAgents"
      description: "Persisted agent preferences in config"
      fields:
        - name: "agents"
          type: "[]string"
          description: "List of agent names to pre-select"
          constraints: "Only known agent names; unknown names ignored"
      relationships:
        - target: "Configuration"
          type: "field-of"
          description: "Added as DefaultAgents field to Configuration struct"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/init-agent-configuration.md"
      description: "User documentation for agent selection during init (optional, only if requested)"
  source_code:
    - path: "internal/cliagent/configurator.go"
      description: "Configurator interface and helper functions"
    - path: "internal/cliagent/claude.go"
      description: "Add ConfigureProject method to Claude agent"
    - path: "internal/cli/config/init_cmd.go"
      description: "Modify runInit to add agent selection prompt"
    - path: "internal/cli/config/agent_prompt.go"
      description: "Multi-select agent prompt implementation"
    - path: "internal/config/config.go"
      description: "Add DefaultAgents field to Configuration"
    - path: "internal/config/defaults.go"
      description: "Add default_agents to config template"
    - path: "internal/claude/settings.go"
      description: "Add AddPermissions method for batch permission adding"
  tests:
    - path: "internal/cliagent/configurator_test.go"
      description: "Tests for Configurator interface and Claude.ConfigureProject"
    - path: "internal/cli/config/agent_prompt_test.go"
      description: "Tests for agent selection prompt logic"
    - path: "internal/cli/config/init_test.go"
      description: "Integration tests for init with agent selection"

implementation_phases:
  - phase: 1
    name: "Core Interface & Data Model"
    goal: "Define Configurator interface and add DefaultAgents to config"
    deliverables:
      - "Configurator interface in internal/cliagent/configurator.go"
      - "ConfigResult struct for configuration outcomes"
      - "DefaultAgents field in Configuration struct"
      - "default_agents in config template"
      - "Unit tests for new types"
  - phase: 2
    name: "Claude Configurator Implementation"
    goal: "Implement ConfigureProject for Claude agent with permission management"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Claude.ConfigureProject method"
      - "AddPermissions helper in internal/claude/settings.go"
      - "Permission generation with dynamic specs_dir"
      - "Unit tests for Claude configuration"
  - phase: 3
    name: "Agent Selection Prompt"
    goal: "Implement interactive multi-select prompt for agent selection"
    dependencies:
      - "Phase 1"
    deliverables:
      - "agent_prompt.go with promptAgentSelection function"
      - "AgentOption type for prompt display"
      - "Keyboard-navigable numbered list selection"
      - "Non-interactive fallback for --no-agents"
      - "Unit tests for prompt logic"
  - phase: 4
    name: "Init Command Integration"
    goal: "Wire agent selection into init command flow"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "Modified runInit to call promptAgentSelection"
      - "--no-agents flag support"
      - "Agent configuration with feedback output"
      - "DefaultAgents persistence to config"
      - "Integration tests for complete init flow"
  - phase: 5
    name: "Polish & Validation"
    goal: "Ensure quality gates pass and edge cases handled"
    dependencies:
      - "Phase 4"
    deliverables:
      - "All edge cases from spec implemented"
      - "Idempotency verified"
      - "make test, make fmt, make lint, make build pass"
      - "Manual testing on Linux/macOS/Windows"

risks:
  - risk: "Terminal compatibility issues with multi-select prompt"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Implement simple numbered list selection; test on multiple terminals; provide --no-agents fallback"
  - risk: "Breaking existing init behavior for current users"
    likelihood: "low"
    impact: "high"
    mitigation: "Default to Claude pre-selected as before; backward compatible config; clear migration path"
  - risk: "Claude settings.local.json format changes in future Claude releases"
    likelihood: "low"
    impact: "medium"
    mitigation: "Preserve unknown fields during load/save; atomic writes prevent corruption"
  - risk: "Non-interactive environments hang on prompt"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Detect non-TTY and auto-skip with warning; --no-agents flag for CI"

open_questions:
  - question: "Should agents that don't implement Configurator show 'no configuration needed' or be silently skipped?"
    context: "FR-006 only requires Claude to have Configurator; other agents like gemini, cline have no config yet"
    proposed_resolution: "Show brief message 'agent_name: no configuration needed' for transparency"
  - question: "Should the prompt show only installed agents or all supported agents?"
    context: "User might want to configure Claude before installing it, or see what's available"
    proposed_resolution: "Show all supported agents; indicate which are installed with a marker"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-20T02:53:02Z"
  artifact_type: "plan"
