plan:
  branch: "024-rename-workflow-stages"
  created: "2025-12-16"
  spec_path: "specs/024-rename-workflow-stages/spec.yaml"

summary: |
  This implementation renames workflow-level "phases" to "stages" throughout the autospec codebase
  to eliminate terminology confusion with task-level "phases" in tasks.yaml. The refactoring creates
  a clear conceptual hierarchy: workflow STAGES (specify, plan, tasks, implement) contain implementation
  PHASES (task groupings within the implement stage).

  Key technical decisions include: preserving all CLI flags unchanged for backward compatibility,
  renaming internal types/constants/functions systematically across ~15 files, and updating all
  documentation to use consistent terminology. The approach prioritizes zero breaking changes to
  the user-facing interface while improving internal code clarity.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI command framework"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for artifacts"
    - name: "github.com/knadh/koanf"
      version: "v2.3.0"
      purpose: "Configuration management"
  storage: "File system (YAML artifacts, JSON retry state)"
  testing:
    framework: "Go testing package"
    approach: "Table-driven unit tests, integration tests in tests/integration/"
  target_platform: "Linux, macOS (Intel/Apple Silicon), Windows"
  project_type: "cli"
  performance_goals: "Validation functions <10ms, CLI startup <50ms"
  constraints:
    - "CLI flags must remain backward compatible (no flag renaming)"
    - "YAML artifact schemas remain unchanged"
    - "tasks.yaml continues to use 'phase' for task groupings"
    - "All existing tests must pass after refactoring"
  scale_scope: "Internal refactoring with ~15 files affected, ~200+ individual renames"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Existing tests will be updated to use new terminology; no new functionality requires new tests"
    - name: "Validation-First Workflow"
      status: "PASS"
      notes: "Refactoring preserves validation logic unchanged; only terminology changes"
    - name: "Performance Standards"
      status: "PASS"
      notes: "Pure renaming does not affect performance; validation functions remain <10ms"
    - name: "Idempotency and Retry Logic"
      status: "PASS"
      notes: "Retry state format may need migration; backward-compatible parsing considered"
    - name: "Standardized Exit Codes"
      status: "PASS"
      notes: "Exit codes unchanged; only terminology in messages affected"
    - name: "YAML-First Artifacts"
      status: "PASS"
      notes: "No changes to artifact schemas; only internal code terminology"
    - name: "Code Formatting"
      status: "PASS"
      notes: "make fmt will be run after all changes"
    - name: "Cross-Platform Compatibility"
      status: "N/A"
      notes: "Terminology changes do not affect platform compatibility"
    - name: "Explicit Dependencies"
      status: "N/A"
      notes: "No new dependencies required for this refactoring"
    - name: "Documentation Standards"
      status: "PASS"
      notes: "CLAUDE.md and README.md will be updated with clear stage/phase distinction"

research_findings:
  decisions:
    - topic: "Terminology hierarchy"
      decision: "Use 'stage' for workflow-level, 'phase' for task-level concepts"
      rationale: "Stage implies higher-level (stages of a rocket), phase implies subdivision within a stage"
      alternatives_considered:
        - "Use 'step' for workflow-level - rejected as too generic"
        - "Use 'milestone' for workflow-level - rejected as implies completion checkpoints"
        - "Keep 'phase' everywhere - rejected as it causes ongoing confusion"
    - topic: "CLI flag strategy"
      decision: "Keep all existing flags unchanged (--phases, --phase, --from-phase)"
      rationale: "Backward compatibility is critical; these flags already correctly refer to task phases"
      alternatives_considered:
        - "Add --stages alias - rejected as adds complexity without clear benefit"
        - "Rename flags - rejected as breaking change"
    - topic: "Retry state migration"
      decision: "Add backward-compatible parsing for old retry state format"
      rationale: "Existing retry state files contain 'phase' in keys; graceful migration preferred"
      alternatives_considered:
        - "Force state reset on upgrade - rejected as poor user experience"
        - "Leave retry state unchanged - rejected as inconsistent with internal terminology"
    - topic: "File renaming strategy"
      decision: "Rename phase_config.go to stage_config.go and similar"
      rationale: "File names should reflect content; phase_execution.go keeps name as it handles task phases"
      alternatives_considered:
        - "Keep all filenames - rejected as inconsistent and confusing"
        - "Rename all phase files - rejected as some files genuinely deal with task phases"

data_model:
  entities:
    - name: "Stage"
      description: "High-level workflow step in autospec (specify, plan, tasks, implement, constitution, clarify, checklist, analyze)"
      fields:
        - name: "name"
          type: "string"
          description: "Stage identifier (e.g., 'specify', 'plan')"
          constraints: "One of the 8 defined stage names"
        - name: "order"
          type: "int"
          description: "Canonical execution sequence position"
          constraints: "1-8 based on stage"
        - name: "artifacts"
          type: "[]string"
          description: "Files produced by this stage"
          constraints: "Valid file paths"
      relationships:
        - target: "ArtifactDependency"
          type: "one-to-one"
          description: "Each stage has artifact requirements"
    - name: "Phase"
      description: "Numbered grouping of tasks within the implement stage (unchanged)"
      fields:
        - name: "number"
          type: "int"
          description: "Sequential phase identifier"
          constraints: "Positive integer"
        - name: "title"
          type: "string"
          description: "Human-readable phase description"
          constraints: "Non-empty string"
        - name: "tasks"
          type: "[]TaskID"
          description: "List of task IDs in this phase"
          constraints: "Valid task IDs from tasks.yaml"
      relationships:
        - target: "Task"
          type: "one-to-many"
          description: "Phase contains multiple tasks"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "CLAUDE.md"
      description: "Primary developer documentation - update stage/phase terminology"
    - path: "README.md"
      description: "User-facing documentation - update terminology"
    - path: ".claude/commands/autospec.*.md"
      description: "Slash command documentation - update references"
  source_code:
    - path: "internal/workflow/executor.go"
      description: "Stage type and constants (currently Phase)"
    - path: "internal/workflow/stage_config.go"
      description: "Stage configuration (rename from phase_config.go)"
    - path: "internal/workflow/workflow.go"
      description: "Workflow orchestrator with stage execution"
    - path: "internal/workflow/preflight.go"
      description: "Preflight checks with stage dependencies"
    - path: "internal/workflow/phase_context.go"
      description: "Task phase context (keeps phase terminology)"
    - path: "internal/workflow/phase_execution.go"
      description: "Task phase execution options (keeps phase terminology)"
    - path: "internal/retry/retry.go"
      description: "Stage state tracking (rename Phase methods for workflow)"
    - path: "internal/cli/*.go"
      description: "CLI commands with updated help text"
    - path: "internal/progress/types.go"
      description: "Progress display types (may need Stage type)"
    - path: "internal/validation/tasks_yaml.go"
      description: "Task phase validation (keeps phase terminology)"
    - path: "internal/validation/phase_display.go"
      description: "Task phase display (keeps phase terminology)"
  tests:
    - path: "internal/workflow/*_test.go"
      description: "Workflow tests with stage terminology"
    - path: "internal/retry/*_test.go"
      description: "Retry tests with stage terminology"
    - path: "internal/cli/*_test.go"
      description: "CLI tests with updated expectations"
    - path: "tests/integration/"
      description: "Integration tests verifying behavior unchanged"

implementation_phases:
  - phase: 1
    name: "Core Type Renaming"
    goal: "Rename the fundamental Stage type and constants in executor.go"
    deliverables:
      - "Rename type Phase to Stage in executor.go"
      - "Rename PhaseSpecify/Plan/Tasks/Implement to StageSpecify/Plan/Tasks/Implement"
      - "Rename PhaseConstitution/Clarify/Checklist/Analyze to Stage equivalents"
      - "Update PhaseResult to StageResult"
      - "Update all references in executor.go"
      - "Run tests to identify cascading changes needed"

  - phase: 2
    name: "Configuration Renaming"
    goal: "Rename phase_config.go to stage_config.go and update all structs"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Rename phase_config.go to stage_config.go"
      - "Rename PhaseConfig to StageConfig"
      - "Update GetCanonicalOrder and related methods"
      - "Update ArtifactDependency to use Stage type"
      - "Update all importing files"

  - phase: 3
    name: "Workflow Orchestrator Updates"
    goal: "Update workflow.go to use Stage terminology consistently"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Update all method signatures using Phase to Stage"
      - "Update output messages from 'Phase X/Y' to 'Stage X/Y'"
      - "Preserve phase terminology in task-level execution methods"
      - "Update variable names (phaseCount to stageCount, etc.)"

  - phase: 4
    name: "Preflight and Retry Updates"
    goal: "Update preflight.go and retry.go with Stage terminology"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Update preflight.go artifact dependency messages"
      - "Rename PhaseExecutionState to StageExecutionState in retry.go"
      - "Add backward-compatible parsing for old retry state format"
      - "Update MarkPhaseComplete to MarkStageComplete"

  - phase: 5
    name: "Progress Display Updates"
    goal: "Update progress display types for Stage terminology"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Rename PhaseStatus to StageStatus in progress/types.go"
      - "Update PhaseInfo to StageInfo for workflow display"
      - "Preserve task PhaseInfo in validation/phase_display.go"

  - phase: 6
    name: "CLI Help Text Updates"
    goal: "Update all CLI command help text with stage/phase distinction"
    dependencies:
      - "Phase 5"
    deliverables:
      - "Update run.go help text to use 'stage' for workflow steps"
      - "Update all.go and prep.go help text"
      - "Preserve 'phase' terminology in implement.go for task phases"
      - "Update any status.go output referring to workflow phases"

  - phase: 7
    name: "Documentation Updates"
    goal: "Update all documentation with consistent terminology"
    dependencies:
      - "Phase 6"
    deliverables:
      - "Update CLAUDE.md with stage/phase distinction"
      - "Add hierarchy diagram to CLAUDE.md"
      - "Update README.md terminology"
      - "Update .claude/commands/*.md files"

  - phase: 8
    name: "Testing and Validation"
    goal: "Ensure all tests pass and validate terminology consistency"
    dependencies:
      - "Phase 7"
    deliverables:
      - "Run make test and fix any failures"
      - "Run make lint and fix formatting"
      - "Verify CLI commands work identically"
      - "Audit terminology for any missed instances"
      - "Test backward compatibility with existing retry state"

risks:
  - risk: "Large number of files affected increases merge conflict potential"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Complete refactoring in single focused PR; avoid concurrent changes to workflow files"

  - risk: "Missed rename in obscure location causes runtime error"
    likelihood: "medium"
    impact: "high"
    mitigation: "Thorough grep audit before completion; rely on Go compiler to catch type mismatches"

  - risk: "Retry state migration breaks existing workflows"
    likelihood: "low"
    impact: "high"
    mitigation: "Implement backward-compatible parsing; test with existing retry state files"

  - risk: "Documentation terminology inconsistency remains"
    likelihood: "medium"
    impact: "low"
    mitigation: "Systematic search-and-replace with manual review; add hierarchy diagram for clarity"

open_questions:
  - question: "Should internal/workflow/phase_context.go be renamed?"
    context: "File deals with task phase context for implementation, not workflow stages"
    proposed_resolution: "Keep as phase_context.go since it genuinely handles task phases"

  - question: "Should progress display PhaseStatus enum be renamed?"
    context: "Used for both workflow and task progress display"
    proposed_resolution: "Rename to StageStatus for workflow; task display uses different types"

  - question: "How to handle mixed terminology in output messages?"
    context: "Some messages like 'Phases 1-3 complete' refer to task phases"
    proposed_resolution: "Only rename messages that refer to workflow stages; preserve task phase messages"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T08:58:05Z"
  artifact_type: "plan"
