tasks:
    branch: "077-opencode-agent-preset"
    created: "2026-01-02"
    spec_path: "specs/077-opencode-agent-preset/spec.yaml"
    plan_path: "specs/077-opencode-agent-preset/plan.yaml"
summary:
    total_tasks: 22
    total_phases: 7
    parallel_opportunities: 8
    estimated_complexity: "medium"
phases:
    - number: 1
      title: "Setup"
      purpose: "Project initialization and preparation for OpenCode agent support"
      tasks:
        - id: "T001"
          title: "Create internal/opencode/ package directory"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/opencode/"
          dependencies: []
          acceptance_criteria:
            - "Directory internal/opencode/ exists"
            - "Package declaration is 'package opencode'"
    - number: 2
      title: "Foundational - Core Agent Infrastructure"
      purpose: "Add new prompt method type and update base agent configuration (MUST complete before user stories)"
      tasks:
        - id: "T002"
          title: "Add PromptMethodSubcommandWithFlag constant to internal/cliagent/capabilities.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/cliagent/capabilities.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "PromptMethodSubcommandWithFlag constant defined with value 'subcommand-with-flag'"
            - "Constant documented with usage pattern description"
        - id: "T003"
          title: "Add CommandFlag field to PromptDelivery struct in internal/cliagent/capabilities.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/cliagent/capabilities.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "CommandFlag string field added to PromptDelivery struct"
            - "Field documented for --command flag usage"
        - id: "T004"
          title: "Update BuildCommand() in internal/cliagent/base.go to handle PromptMethodSubcommandWithFlag"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/cliagent/base.go"
          dependencies: ["T002", "T003"]
          acceptance_criteria:
            - "BuildCommand() handles PromptMethodSubcommandWithFlag case"
            - "Command built as: <agent> <subcommand> <args> --command <command-name>"
            - "Existing prompt methods unchanged"
        - id: "T005"
          title: "Write tests for PromptMethodSubcommandWithFlag in internal/cliagent/base_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/cliagent/base_test.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "Table-driven tests for BuildCommand with PromptMethodSubcommandWithFlag"
            - "Tests verify command order: subcommand, args, --command flag"
            - "Tests use map[string]struct pattern"
    - number: 3
      title: "User Story 1 - Run OpenCode in non-interactive mode (US-001)"
      purpose: "Enable autospec to invoke OpenCode in non-interactive mode with auto-approved permissions"
      story_reference: "US-001"
      independent_test: "Run autospec specify with agent_preset=opencode and verify OpenCode executes without prompts"
      tasks:
        - id: "T006"
          title: "Update NewOpenCode() in internal/cliagent/opencode.go to use PromptMethodSubcommandWithFlag"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cliagent/opencode.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "NewOpenCode() sets PromptDelivery.Method to PromptMethodSubcommandWithFlag"
            - "PromptDelivery.Flag set to 'run' (subcommand)"
            - "PromptDelivery.CommandFlag set to '--command'"
            - "Builds: opencode run <args> --command <command-name>"
        - id: "T007"
          title: "Write tests for OpenCode command building in internal/cliagent/opencode_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/cliagent/opencode_test.go"
          dependencies: ["T006"]
          acceptance_criteria:
            - "Test verifies 'opencode run <prompt> --command autospec.<stage>' format"
            - "Test verifies prompt injection works for retries"
            - "Tests use map[string]struct pattern"
    - number: 4
      title: "User Story 4 - Configure OpenCode permissions (US-004)"
      purpose: "Configure OpenCode's permissions in opencode.json for non-interactive workflows"
      story_reference: "US-004"
      independent_test: "Run autospec init --ai opencode and verify ./opencode.json has 'autospec *': 'allow' permission"
      tasks:
        - id: "T008"
          title: "Create Settings struct in internal/opencode/settings.go for opencode.json structure"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/opencode/settings.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "Settings struct with Permission field"
            - "Permission struct with Bash map[string]string field"
            - "JSON tags for proper serialization"
        - id: "T009"
          title: "Implement Load() and Save() functions in internal/opencode/settings.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/opencode/settings.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "Load() parses opencode.json from project root"
            - "Load() returns empty Settings if file missing (not error)"
            - "Save() writes JSON with proper indentation"
            - "Save() preserves unknown fields (use json.RawMessage if needed)"
        - id: "T010"
          title: "Implement AddBashPermission() and CheckBashPermission() in internal/opencode/settings.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/opencode/settings.go"
          dependencies: ["T009"]
          acceptance_criteria:
            - "AddBashPermission(pattern, level) adds permission rule"
            - "CheckBashPermission(pattern) returns current level or empty string"
            - "Functions are idempotent (safe to call multiple times)"
        - id: "T011"
          title: "Write tests for internal/opencode/settings_test.go"
          status: "InProgress"
          type: "test"
          parallel: false
          story_id: "US-004"
          file_path: "internal/opencode/settings_test.go"
          dependencies: ["T010"]
          acceptance_criteria:
            - "Tests for Load() with existing file, missing file, invalid JSON"
            - "Tests for Save() preserving existing fields"
            - "Tests for AddBashPermission() idempotency"
            - "All tests use map[string]struct pattern"
    - number: 5
      title: "User Story 3 - Single source command templates (US-003)"
      purpose: "Ensure command templates work for both Claude Code and OpenCode"
      story_reference: "US-003"
      independent_test: "Verify internal/commands/*.md files contain no agent-specific references"
      tasks:
        - id: "T012"
          title: "Update CLAUDE.md references to AGENTS.md pattern in internal/commands/*.md"
          status: "Pending"
          type: "refactor"
          parallel: true
          story_id: "US-003"
          file_path: "internal/commands/"
          dependencies: ["T005"]
          acceptance_criteria:
            - "Templates reference 'AGENTS.md (primary) or CLAUDE.md (fallback)'"
            - "No direct Claude Code tool references"
            - "No OpenCode-specific syntax"
        - id: "T013"
          title: "Add GetCommandsDir(agentName) function to internal/commands/templates.go"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-003"
          file_path: "internal/commands/templates.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "GetCommandsDir('claude') returns '.claude/commands/'"
            - "GetCommandsDir('opencode') returns '.opencode/command/'"
            - "Handles unknown agents with sensible default or error"
        - id: "T014"
          title: "Update InstallTemplates() to accept agent name parameter"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/commands/templates.go"
          dependencies: ["T013"]
          acceptance_criteria:
            - "InstallTemplates(agentName, projectDir) uses GetCommandsDir()"
            - "Installs to correct directory based on agent"
            - "Backward compatible (default to claude if empty)"
        - id: "T015"
          title: "Write tests for agent-specific command directory logic in internal/commands/templates_test.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-003"
          file_path: "internal/commands/templates_test.go"
          dependencies: ["T014"]
          acceptance_criteria:
            - "Tests for GetCommandsDir() with claude, opencode, unknown"
            - "Tests for InstallTemplates() installing to correct directories"
            - "All tests use map[string]struct pattern"
    - number: 6
      title: "User Story 2 - Install OpenCode slash commands (US-002)"
      purpose: "Install command templates to .opencode/command/ during autospec init"
      story_reference: "US-002"
      independent_test: "Run autospec init --ai opencode and verify .opencode/command/autospec.*.md files exist"
      tasks:
        - id: "T016"
          title: "Implement Configurator interface (ConfigureProject) on OpenCode struct"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cliagent/opencode.go"
          dependencies: ["T011", "T015"]
          acceptance_criteria:
            - "OpenCode implements cliagent.Configurator interface"
            - "ConfigureProject() installs commands to .opencode/command/"
            - "ConfigureProject() adds 'autospec *': 'allow' to ./opencode.json"
            - "Idempotent (safe to call multiple times)"
        - id: "T017"
          title: "Write tests for OpenCode ConfigureProject() in internal/cliagent/opencode_test.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cliagent/opencode_test.go"
          dependencies: ["T016"]
          acceptance_criteria:
            - "Test verifies .opencode/command/ directory created"
            - "Test verifies autospec.*.md files installed"
            - "Test verifies opencode.json permission added"
            - "Test verifies existing non-autospec commands preserved"
        - id: "T018"
          title: "Add ProductionAgents() to internal/build/version.go"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-002"
          file_path: "internal/build/version.go"
          dependencies: ["T005"]
          acceptance_criteria:
            - "ProductionAgents() returns []string{'claude', 'opencode'}"
            - "Function documented for production vs dev agent filtering"
            - "Works with existing MultiAgentEnabled() flag"
        - id: "T019"
          title: "Add --ai flag to init command in internal/cli/config/init_cmd.go"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/config/init_cmd.go"
          dependencies: ["T016", "T018"]
          acceptance_criteria:
            - "--ai flag accepts comma-separated agent list"
            - "--ai claude,opencode configures both agents"
            - "Without --ai flag, shows interactive multi-select checklist"
            - "Production builds filter agents by ProductionAgents()"
        - id: "T020"
          title: "Write tests for --ai flag in internal/cli/config/init_cmd_test.go"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/config/init_cmd_test.go"
          dependencies: ["T019"]
          acceptance_criteria:
            - "Test --ai claude configures only Claude"
            - "Test --ai opencode configures only OpenCode"
            - "Test --ai claude,opencode configures both"
            - "Test invalid agent name produces error"
            - "All tests use map[string]struct pattern"
    - number: 7
      title: "Polish & Cross-Cutting Concerns"
      purpose: "Documentation updates, feature parity verification, and final quality checks"
      tasks:
        - id: "T021"
          title: "Update docs/internal/agents.md with OpenCode configuration details"
          status: "Pending"
          type: "documentation"
          parallel: true
          story_id: null
          file_path: "docs/internal/agents.md"
          dependencies: ["T020"]
          acceptance_criteria:
            - "OpenCode agent configuration documented"
            - "Command directory difference (.opencode/command/ vs .claude/commands/) noted"
            - "Permission configuration (opencode.json) documented"
            - "Invocation pattern (opencode run <args> --command <name>) documented"
        - id: "T022"
          title: "Run full quality gates and verify feature parity"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: null
          file_path: "Makefile"
          dependencies: ["T021"]
          acceptance_criteria:
            - "make test passes"
            - "make fmt produces no changes"
            - "make lint passes"
            - "make build succeeds"
            - "Verify retry prompt injection works with OpenCode"
            - "Verify timeout configuration works with OpenCode"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-002"]
        - story_id: "US-004"
          depends_on: []
          blocks: ["US-002"]
        - story_id: "US-003"
          depends_on: []
          blocks: ["US-002"]
        - story_id: "US-002"
          depends_on: ["US-001", "US-003", "US-004"]
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2]
        - phase: 2
          blocks: [3, 4, 5]
        - phase: 3
          blocks: [6]
        - phase: 4
          blocks: [6]
        - phase: 5
          blocks: [6]
        - phase: 6
          blocks: [7]
parallel_execution:
    - phase: 2
      parallel_groups:
        - tasks: ["T002", "T003"]
          rationale: "Independent additions to capabilities.go - different struct/constant"
    - phase: 5
      parallel_groups:
        - tasks: ["T012", "T013"]
          rationale: "Template updates and new function are independent changes"
    - phase: 6
      parallel_groups:
        - tasks: ["T018"]
          rationale: "ProductionAgents() in build package independent of opencode work"
    - phase: 7
      parallel_groups:
        - tasks: ["T021"]
          rationale: "Documentation can be written in parallel with other polish tasks"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3]
        description: "Setup + Foundational + US-001 (non-interactive OpenCode execution)"
        validation: "OpenCode agent can execute commands via 'opencode run <args> --command <name>'"
    incremental_delivery:
        - milestone: "Foundation Ready"
          phases: [1, 2]
          deliverable: "New PromptMethodSubcommandWithFlag available for agents"
        - milestone: "OpenCode Agent Works"
          phases: [1, 2, 3]
          deliverable: "autospec specify works with agent_preset=opencode"
        - milestone: "Permissions Configured"
          phases: [1, 2, 3, 4]
          deliverable: "OpenCode runs without permission prompts"
        - milestone: "Init Support Complete"
          phases: [1, 2, 3, 4, 5, 6]
          deliverable: "autospec init --ai opencode fully functional"
        - milestone: "Feature Complete"
          phases: [1, 2, 3, 4, 5, 6, 7]
          deliverable: "Full OpenCode parity with Claude, documented"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2026-01-02T01:36:36Z"
    artifact_type: "tasks"
