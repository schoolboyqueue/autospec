feature:
  branch: "077-opencode-agent-preset"
  created: "2026-01-02"
  status: "Draft"
  input: |
    Just like we have 1st integration support for claude code and claude args - we should also
    now try to support preset commands for opencode specifically running it in like yolo mode/
    non-interactive mode by default. Figure out if opencode cli supports slash commands like
    claude code - if not we should figure out the best way to set up opencode for spec based
    development without slash commands. I see this new specify init created these commands:
    .opencode/command/*.md files for opencode specifically - for .claude/commands/* it did
    something similar -> so I think autospec init should also maybe need to do this for opencode
    if user specifies that agent perhaps with 'autospec init --ai opencode' or something similar.
    Speckit's commands are meant for markdown spec generation but see our own internal/commands/*.md
    files they ask for yaml instead. I need you to first validate our internal commands made for
    claude code should still work for opencode if not we need separate folder of autospec commands
    for opencode specifically? but prefer one source if possible.

user_stories:
  - id: "US-001"
    title: "Run OpenCode in non-interactive mode for spec workflows"
    priority: "P1"
    as_a: "developer using OpenCode as their AI agent"
    i_want: "autospec to invoke OpenCode in non-interactive mode with auto-approved permissions"
    so_that: "I can run automated spec-based development workflows without manual intervention"
    why_this_priority: "Core functionality required for OpenCode to work as an autospec agent"
    independent_test: "Run autospec specify with agent_preset=opencode and verify OpenCode executes the command without prompts"
    acceptance_scenarios:
      - given: "OpenCode is installed and agent_preset is set to 'opencode'"
        when: "I run 'autospec specify \"Add feature X\"'"
        then: "OpenCode is invoked via 'opencode run <prompt>' and the command runs to completion without user interaction"

  - id: "US-002"
    title: "Install OpenCode slash commands during init"
    priority: "P1"
    as_a: "developer setting up autospec with OpenCode"
    i_want: "autospec init to install command templates to .opencode/command/"
    so_that: "OpenCode can use /autospec.* slash commands just like Claude Code"
    why_this_priority: "Essential for OpenCode to have equivalent functionality to Claude Code"
    independent_test: "Run autospec init --ai opencode and verify .opencode/command/autospec.*.md files are created"
    acceptance_scenarios:
      - given: "A project without OpenCode commands configured"
        when: "I run 'autospec init --ai opencode'"
        then: "Command templates are installed to .opencode/command/ directory"
      - given: "OpenCode commands already exist"
        when: "I run 'autospec init --ai opencode'"
        then: "Commands are updated if newer versions are available"

  - id: "US-003"
    title: "Use single source of command templates"
    priority: "P1"
    as_a: "maintainer of autospec"
    i_want: "a single source of command templates that works for both Claude Code and OpenCode"
    so_that: "I don't have to maintain duplicate command files for different agents"
    why_this_priority: "Reduces maintenance burden and ensures consistency across agents"
    independent_test: "Verify internal/commands/*.md files contain only agent-agnostic instructions"
    acceptance_scenarios:
      - given: "The internal/commands/*.md template files"
        when: "Reviewed for agent-specific syntax or tool references"
        then: "No Claude Code-specific or OpenCode-specific elements are present"
      - given: "Command templates installed for Claude Code and OpenCode"
        when: "Compared side by side"
        then: "Content is identical, only installation paths differ"

  - id: "US-004"
    title: "Configure OpenCode project settings and permissions"
    priority: "P1"
    as_a: "developer using OpenCode"
    i_want: "autospec init to configure OpenCode's permissions in opencode.json"
    so_that: "OpenCode can run autospec commands without prompting for approval"
    why_this_priority: "Required for non-interactive workflow execution"
    independent_test: "Run autospec init --ai opencode and verify ./opencode.json has 'autospec *': 'allow' permission"
    acceptance_scenarios:
      - given: "A project without opencode.json at root"
        when: "I run 'autospec init --ai opencode'"
        then: "./opencode.json is created with permission.bash['autospec *'] = 'allow'"
      - given: "A project with existing opencode.json at root"
        when: "I run 'autospec init --ai opencode'"
        then: "permission.bash['autospec *'] = 'allow' is added/updated without overwriting other settings"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST invoke OpenCode using 'opencode run <args> --command <command-name>' for slash commands"
      testable: true
      acceptance_criteria: "OpenCode agent builds command line with 'opencode run <args> --command autospec.<stage>' format"

    - id: "FR-002"
      description: "MUST install command templates to .opencode/command/ (singular, not plural) when OpenCode is selected"
      testable: true
      acceptance_criteria: "autospec init --ai opencode creates .opencode/command/autospec.*.md files (note: singular 'command')"

    - id: "FR-003"
      description: "MUST use the same internal/commands/*.md templates for all agents after updating CLAUDE.md references to AGENTS.md"
      testable: true
      acceptance_criteria: "Templates reference AGENTS.md as primary constitution with fallback to CLAUDE.md; no agent-specific template directories"

    - id: "FR-004"
      description: "MUST add '--ai' flag to autospec init supporting multiple agents"
      testable: true
      acceptance_criteria: "autospec init --ai claude,opencode configures both agents; supports comma-separated list"

    - id: "FR-005"
      description: "MUST update OpenCode agent to pass --command flag via ExtraArgs or new PromptMethod"
      testable: true
      acceptance_criteria: "OpenCode agent produces 'opencode run <prompt> --command <name>' for slash commands; can use existing ExtraArgs mechanism"

    - id: "FR-006"
      description: "MUST implement Configurator interface for OpenCode to install commands and configure permissions"
      testable: true
      acceptance_criteria: "OpenCode.ConfigureProject() installs commands to .opencode/command/ AND adds 'autospec *': 'allow' to ./opencode.json (project root)"

    - id: "FR-007"
      description: "MUST limit production builds to Claude + OpenCode agents only"
      testable: true
      acceptance_criteria: "Production builds only show/allow Claude and OpenCode; dev builds show all agents"

    - id: "FR-008"
      description: "MUST enable existing interactive agent checklist UI in autospec init"
      testable: true
      acceptance_criteria: "autospec init (without --ai flag) shows existing multi-select checklist for agent selection; locate and enable existing code"

    - id: "FR-009"
      description: "MUST support retry prompt injection identically to Claude agent"
      testable: true
      acceptance_criteria: "Retry system injects validation errors into OpenCode prompts the same way as Claude"

    - id: "FR-010"
      description: "MUST ensure all autospec args work identically across Claude and OpenCode agents"
      testable: true
      acceptance_criteria: "timeout, max_retries, specs_dir, and other config options work the same for both agents"

    - id: "FR-011"
      description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
      testable: true
      acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"

  non_functional:
    - id: "NFR-001"
      category: "code_quality"
      description: "All functions must be under 40 lines; extract helpers for complex logic"
      measurable_target: "No function exceeds 40 lines excluding comments"

    - id: "NFR-002"
      category: "code_quality"
      description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
      measurable_target: "Zero bare 'return err' statements in new code"

    - id: "NFR-003"
      category: "code_quality"
      description: "Tests must use map-based table-driven pattern"
      measurable_target: "All new test functions use map[string]struct pattern"

    - id: "NFR-004"
      category: "code_quality"
      description: "Accept interfaces, return concrete types"
      measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"

    - id: "NFR-005"
      category: "maintainability"
      description: "Command templates must remain agent-agnostic for single-source maintenance"
      measurable_target: "Zero agent-specific references in internal/commands/*.md files"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can run complete spec workflows using OpenCode as their agent"
      metric: "End-to-end test completion"
      target: "autospec run -a 'feature' completes successfully with agent_preset=opencode"

    - id: "SC-002"
      description: "OpenCode slash commands work identically to Claude Code commands"
      metric: "Command execution parity"
      target: "/autospec.specify produces equivalent spec.yaml output on both agents"

    - id: "SC-003"
      description: "Command template maintenance effort stays constant as new agents are added"
      metric: "Number of command template sources"
      target: "1 source (internal/commands/) for all agents"

    - id: "SC-004"
      description: "All autospec features work identically on OpenCode as on Claude"
      metric: "Feature parity"
      target: "Retry, validation, prompt injection, timeout, all config options behave identically"

key_entities:
  - name: "OpenCode Agent"
    description: "CLI agent configuration for the OpenCode AI coding tool"
    attributes:
      - "Base command: opencode run"
      - "Slash command invocation: opencode run <args> --command <command-name>"
      - "Non-interactive mode: inherent with run subcommand"
      - "Command directory: .opencode/command/ (singular, vs Claude's .claude/commands/ plural)"
      - "Additional flags: --model, --agent, --file"
      - "Key difference from Claude: command name via --command flag, not embedded in prompt"
      - "Constitution file: AGENTS.md (primary) or OPENCODE.md (agent-specific)"

  - name: "Command Template"
    description: "Markdown file defining a slash command's behavior"
    attributes:
      - "YAML frontmatter with description and version"
      - "Agent-agnostic instructions"
      - "Installed to agent-specific directories"

  - name: "Agent Configurator"
    description: "Interface for agent-specific project configuration"
    attributes:
      - "ConfigureProject() method"
      - "Installs commands to agent's directory"
      - "Sets up permissions if applicable"

  - name: "PromptMethodSubcommandWithFlag"
    description: "New prompt method type for agents that use subcommand + flag pattern"
    attributes:
      - "Subcommand: 'run' (positional args for message)"
      - "Flag: '--command' (specifies slash command name)"
      - "Pattern: '<agent> run <args> --command <command-name>'"
      - "Used by: OpenCode agent"
      - "Distinct from: PromptMethodArg (Claude's -p pattern)"

  - name: "OpenCode Permissions"
    description: "Permission configuration for OpenCode in opencode.json at project root"
    attributes:
      - "Config file: ./opencode.json (project root, not .opencode/)"
      - "Permission path: permission.bash"
      - "Required rule: 'autospec *': 'allow'"
      - "Supports glob patterns (* matches any)"
      - "Approval levels: allow, ask, deny"
      - "Note: .opencode/ is for agents/modes/commands, config stays at root"

edge_cases:
  - scenario: "OpenCode not installed"
    expected_behavior: "autospec doctor shows OpenCode as unavailable; workflows fail with clear error message"

  - scenario: "Both Claude and OpenCode configured"
    expected_behavior: "agent_preset config value determines which agent is used"

  - scenario: "OpenCode command directory already has non-autospec commands"
    expected_behavior: "Only autospec.*.md files are created/updated; existing commands preserved"

  - scenario: "User runs autospec init without --ai flag"
    expected_behavior: "Shows existing interactive multi-select checklist for agent selection (enable existing disabled code)"

  - scenario: "Internal command templates contain agent-specific syntax"
    expected_behavior: "Audit and refactor templates to be agent-agnostic before implementing"

  - scenario: "Project has AGENTS.md but no CLAUDE.md or OPENCODE.md"
    expected_behavior: "Templates use AGENTS.md as constitution source for all agents"

  - scenario: "Project has AGENTS.md and agent-specific file (CLAUDE.md/OPENCODE.md)"
    expected_behavior: "AGENTS.md is primary; agent-specific file is NOT used (AGENTS.md takes precedence)"

  - scenario: "Project has CLAUDE.md but no AGENTS.md, user inits for Claude"
    expected_behavior: "Templates use CLAUDE.md as fallback constitution source"

  - scenario: "Project has neither AGENTS.md nor agent-specific files"
    expected_behavior: "Templates proceed without constitution; warn user to create AGENTS.md"

assumptions:
  - "OpenCode supports custom slash commands via .opencode/command/*.md files (singular 'command')"
  - "OpenCode's 'run' subcommand executes prompts non-interactively and exits on completion"
  - "Internal/commands/*.md templates need CLAUDE.md references updated to AGENTS.md (with fallback)"
  - "OpenCode uses the same markdown frontmatter format for command metadata"
  - "OpenCode is available as 'opencode' command in PATH"
  - "OpenCode run supports --command flag for slash command invocation"
  - "AGENTS.md serves as universal agent instructions file; agent-specific files override if present"

constraints:
  - "Must maintain backward compatibility - Claude Code remains the default agent"
  - "Cannot introduce agent-specific logic into internal/commands/*.md templates"
  - "Production builds: only Claude + OpenCode agents available"
  - "Dev builds: all agents available via existing build.MultiAgentEnabled()"
  - "Must not break existing Claude Code workflows or configuration"

out_of_scope:
  - "OpenCode sandbox configuration (OpenCode does NOT support sandboxing - no SandboxConfigurator implementation needed)"
  - "OpenCode DefaultArgs/output format (default output works fine, no --format flag needed)"
  - "GUI/TUI configuration for OpenCode (focus on CLI automation only)"
  - "Support for OpenCode's deprecated 'mode' configuration (use agent-based config)"
  - "OpenCode MCP server configuration"
  - "Integration testing against live OpenCode API (unit tests only)"
  - "Advanced OpenCode permissions beyond 'autospec *' (e.g., git, npm)"

clarifications:
  - date: "2026-01-02"
    question: "What is the correct CLI syntax for invoking OpenCode in non-interactive mode?"
    answer: "Use 'opencode run <prompt>' subcommand format (not -p flag)"
    applied_to: "FR-001, FR-005, US-001, key_entities, assumptions"

  - date: "2026-01-02"
    question: "How does OpenCode invoke slash commands compared to Claude Code?"
    answer: "OpenCode uses 'opencode run <args> --command <command-name>' vs Claude's 'claude -p /<command> <args>'"
    applied_to: "FR-001, FR-005, key_entities, assumptions"

  - date: "2026-01-02"
    question: "Are internal/commands/*.md templates agent-agnostic?"
    answer: "No - templates reference CLAUDE.md for constitution. Use AGENTS.md as primary with fallback to agent-specific files."
    applied_to: "FR-003, NFR-005, assumptions"

  - date: "2026-01-02"
    question: "What is the correct OpenCode command directory path?"
    answer: ".opencode/command/ (singular) vs .claude/commands/ (plural)"
    applied_to: "FR-002, FR-006, key_entities"

  - date: "2026-01-02"
    question: "Which agents should be supported in production vs dev builds?"
    answer: "Prod: Claude + OpenCode only. Dev: all agents via existing multi-agent flag."
    applied_to: "constraints, FR-004"

  - date: "2026-01-02"
    question: "What is the constitution file fallback order?"
    answer: "AGENTS.md (primary) â†’ agent-specific file (CLAUDE.md/OPENCODE.md) if AGENTS.md missing"
    applied_to: "FR-003, edge_cases, assumptions"

  - date: "2026-01-02"
    question: "How should OpenCode's command invocation pattern be modeled in the agent interface?"
    answer: "Add new PromptMethodSubcommandWithFlag type for 'run <args> --command <name>' pattern"
    applied_to: "FR-005, key_entities"

  - date: "2026-01-02"
    question: "Should retry prompt injection and other autospec args work identically for OpenCode?"
    answer: "Yes - all autospec functionality (retry, prompt injection, validation) must work identically across agents"
    applied_to: "FR-010, success_criteria"

  - date: "2026-01-02"
    question: "Does OpenCode need permissions configured for autospec commands?"
    answer: "Yes - add 'autospec *': 'allow' to ./opencode.json (project root) permission.bash section during init"
    applied_to: "FR-006, US-004, out_of_scope (removed permission exclusion)"

  - date: "2026-01-02"
    question: "Should --ai flag support multiple agents and what happens without it?"
    answer: "Yes - --ai accepts comma-separated list (e.g., --ai claude,opencode). Without flag, show existing interactive multi-select checklist."
    applied_to: "FR-004, FR-008, edge_cases"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2026-01-02T00:40:57Z"
  artifact_type: "spec"
