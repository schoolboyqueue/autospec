plan:
  branch: "031-event-driven-notifications"
  created: "2025-12-16"
  spec_path: "specs/031-event-driven-notifications/spec.yaml"

summary: |
  Implement an event-driven notification architecture using kelindar/event to replace
  duplicated notification boilerplate across 11 CLI commands. The architecture introduces
  three new packages: internal/events for event types and global dispatcher,
  internal/lifecycle for command execution wrapping, and updates to internal/notify
  to use the subscriber pattern. This refactor eliminates ~100 lines of duplicated code,
  improves testability, and enables future extensibility for metrics and telemetry.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/kelindar/event"
      version: "latest"
      purpose: "High-performance in-process event dispatcher with zero dependencies and type-safe generics"
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI framework (existing)"
    - name: "github.com/stretchr/testify"
      version: "v1.11.1"
      purpose: "Testing assertions (existing, test-only)"
  storage: "None"
  testing:
    framework: "go test with testify assertions"
    approach: "Unit tests with map-based table-driven patterns; race detector validation; integration tests for event flow"
  target_platform: "Linux, macOS, Windows (cross-platform)"
  project_type: "cli"
  performance_goals: "Event dispatch <1ms; zero measurable latency added to command execution"
  constraints:
    - "Must maintain backward compatibility - existing notification behavior unchanged"
    - "Must use github.com/kelindar/event for event bus implementation"
    - "Must not break existing tests"
    - "Functions must be under 40 lines"
    - "Errors must be wrapped with context"
    - "Tests must use map-based table-driven pattern with t.Parallel()"
  scale_scope: "In-process event handling for single CLI session"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Plan includes test-first approach with tests written before implementation for all new packages"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "This feature does not introduce new workflow phases; existing validation remains intact"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "kelindar/event provides sub-millisecond dispatch; no user-facing performance impact"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "N/A"
      notes: "Event system is fire-and-forget; retry logic not applicable to notifications"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Event system does not affect exit codes; errors still propagate normally"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "N/A"
      notes: "No new YAML artifacts introduced; existing artifacts unchanged"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All code will pass go fmt, go vet, and lint checks"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, error wrapping, table-driven tests with t.Parallel()"
    - name: "Cross-Platform Compatibility (PRIN-008)"
      status: "PASS"
      notes: "kelindar/event has zero platform-specific code; pure Go implementation"
    - name: "Explicit Dependencies (PRIN-009)"
      status: "PASS"
      notes: "kelindar/event is zero-dependency, MIT licensed, and will be documented in go.mod"
    - name: "Documentation Standards (PRIN-010)"
      status: "PASS"
      notes: "docs/events.md already exists with comprehensive documentation"

research_findings:
  decisions:
    - topic: "Event bus library selection"
      decision: "Use github.com/kelindar/event"
      rationale: "Zero dependencies, 4-10x faster than channels, type-safe generics, goroutine-per-subscriber async dispatch"
      alternatives_considered:
        - "Custom channel-based implementation"
        - "github.com/asaskevich/EventBus"
        - "github.com/mustafaturan/bus"
    - topic: "Global vs injected event bus"
      decision: "Use global dispatcher instance with package-level functions"
      rationale: "Simplifies API; avoids threading bus through all command contexts; acceptable for single-process CLI"
      alternatives_considered:
        - "Dependency injection via context"
        - "Per-command dispatcher instances"
    - topic: "Notification handler refactoring approach"
      decision: "Convert to subscriber pattern while maintaining backward-compatible methods"
      rationale: "Enables gradual migration; existing direct calls continue to work during transition"
      alternatives_considered:
        - "Complete replacement (breaking change)"
        - "Wrapper layer only"
    - topic: "Lifecycle manager location"
      decision: "Create new internal/lifecycle package"
      rationale: "Clean separation of concerns; single-purpose package for command wrapping"
      alternatives_considered:
        - "Add to internal/cli package"
        - "Add to internal/workflow package"

data_model:
  entities:
    - name: "CommandCompleteEvent"
      description: "Event emitted when a CLI command finishes execution"
      fields:
        - name: "Name"
          type: "string"
          description: "Command name (e.g., 'specify', 'plan')"
          constraints: "Non-empty"
        - name: "Success"
          type: "bool"
          description: "Whether command succeeded"
          constraints: "None"
        - name: "Duration"
          type: "time.Duration"
          description: "Execution time"
          constraints: "Non-negative"
        - name: "Error"
          type: "error"
          description: "Error if failed, nil otherwise"
          constraints: "None"
      relationships: []
    - name: "StageCompleteEvent"
      description: "Event emitted when a workflow stage finishes"
      fields:
        - name: "Name"
          type: "string"
          description: "Stage name"
          constraints: "Non-empty"
        - name: "Success"
          type: "bool"
          description: "Whether stage succeeded"
          constraints: "None"
        - name: "Duration"
          type: "time.Duration"
          description: "Execution time"
          constraints: "Non-negative"
      relationships: []

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/events.md"
      description: "Comprehensive event system documentation (already exists)"
  source_code:
    - path: "internal/events/"
      description: "Event types, constants, and global dispatcher"
    - path: "internal/events/types.go"
      description: "Event struct definitions and Type() methods"
    - path: "internal/events/bus.go"
      description: "Global dispatcher instance and Subscribe/Publish helpers"
    - path: "internal/events/doc.go"
      description: "Package documentation"
    - path: "internal/lifecycle/"
      description: "Command lifecycle management"
    - path: "internal/lifecycle/run.go"
      description: "Run() and RunWithContext() functions"
    - path: "internal/lifecycle/doc.go"
      description: "Package documentation"
    - path: "internal/notify/subscriber.go"
      description: "Event subscription logic for notification handler"
  tests:
    - path: "internal/events/*_test.go"
      description: "Event bus and types unit tests"
    - path: "internal/lifecycle/*_test.go"
      description: "Lifecycle manager unit tests"
    - path: "internal/notify/subscriber_test.go"
      description: "Subscriber pattern tests"

implementation_phases:
  - phase: 1
    name: "Event System Foundation"
    goal: "Create internal/events package with event types and global dispatcher"
    deliverables:
      - "internal/events/types.go with CommandCompleteEvent and StageCompleteEvent"
      - "internal/events/bus.go with global dispatcher and Subscribe/Publish functions"
      - "internal/events/bus_test.go with comprehensive tests including race detection"
      - "internal/events/doc.go with package documentation"
      - "go.mod updated with kelindar/event dependency"
  - phase: 2
    name: "Lifecycle Manager"
    goal: "Create internal/lifecycle package for command execution wrapping"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/lifecycle/run.go with Run() and RunWithContext() functions"
      - "internal/lifecycle/run_test.go with unit tests"
      - "internal/lifecycle/doc.go with package documentation"
  - phase: 3
    name: "Notification Subscriber"
    goal: "Convert notification handler to event subscriber pattern"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/notify/subscriber.go with Subscribe() method"
      - "internal/notify/subscriber_test.go with tests"
      - "internal/notify/handler.go updated with event handler methods"
  - phase: 4
    name: "CLI Command Migration"
    goal: "Migrate all 11 workflow commands to use lifecycle wrapper"
    dependencies:
      - "Phase 2"
      - "Phase 3"
    deliverables:
      - "internal/cli/specify.go migrated"
      - "internal/cli/plan.go migrated"
      - "internal/cli/tasks.go migrated"
      - "internal/cli/clarify.go migrated"
      - "internal/cli/analyze.go migrated"
      - "internal/cli/checklist.go migrated"
      - "internal/cli/constitution.go migrated"
      - "internal/cli/implement.go migrated"
      - "internal/cli/run.go migrated"
      - "internal/cli/prep.go migrated"
      - "internal/cli/all.go migrated"
  - phase: 5
    name: "Executor Events"
    goal: "Update executor to emit stage events instead of direct notification calls"
    dependencies:
      - "Phase 1"
      - "Phase 3"
    deliverables:
      - "internal/workflow/executor.go updated to use events.Publish()"
      - "NotificationHandler field removed from Executor struct"
  - phase: 6
    name: "Testing and Cleanup"
    goal: "Update regression tests and remove dead code"
    dependencies:
      - "Phase 4"
      - "Phase 5"
    deliverables:
      - "internal/cli/specify_test.go updated with lifecycle verification"
      - "Dead notification boilerplate removed from all commands"
      - "Integration tests for end-to-end event flow"
      - "All quality gates pass: make test, make fmt, make lint, make build"

risks:
  - risk: "Event dispatch failures could silently hide notification issues"
    likelihood: "low"
    impact: "low"
    mitigation: "Add logging in subscriber error handlers; notifications are non-critical"
  - risk: "Race conditions in concurrent event handling"
    likelihood: "low"
    impact: "high"
    mitigation: "kelindar/event is thread-safe; run all tests with -race flag"
  - risk: "Breaking existing notification behavior during migration"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Maintain backward-compatible methods; test each command individually"
  - risk: "Increased complexity for simple notification logic"
    likelihood: "low"
    impact: "low"
    mitigation: "Event system is optional; direct calls still work; complexity pays off in extensibility"

open_questions:
  - question: "Should we add EventCommandStart in addition to EventCommandComplete?"
    context: "Start events could enable progress tracking, but add complexity"
    proposed_resolution: "Defer to Phase 2 or future extension; focus on complete events first"
  - question: "Should lifecycle.Run require config parameter or use global config?"
    context: "Current design passes config for notification settings"
    proposed_resolution: "Initialize global notification subscriber at startup; lifecycle.Run does not need config"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-17T00:12:47Z"
  artifact_type: "plan"
