tasks:
  branch: "031-event-driven-notifications"
  created: "2025-12-17"
  spec_path: "specs/031-event-driven-notifications/spec.yaml"
  plan_path: "specs/031-event-driven-notifications/plan.yaml"

summary:
  total_tasks: 26
  total_phases: 6
  parallel_opportunities: 8
  estimated_complexity: "medium"

phases:
  - number: 1
    title: "Setup"
    purpose: "Add dependency and create package structure"
    tasks:
      - id: "T001"
        title: "Add kelindar/event dependency to go.mod"
        status: "Pending"
        type: "setup"
        parallel: false
        story_id: null
        file_path: "go.mod"
        dependencies: []
        acceptance_criteria:
          - "go.mod includes github.com/kelindar/event"
          - "go mod tidy succeeds without errors"
          - "go build succeeds"

      - id: "T002"
        title: "Create internal/events/ package directory structure"
        status: "Pending"
        type: "setup"
        parallel: false
        story_id: null
        file_path: "internal/events/"
        dependencies: ["T001"]
        acceptance_criteria:
          - "Directory internal/events/ exists"

      - id: "T003"
        title: "Create internal/lifecycle/ package directory structure"
        status: "Pending"
        type: "setup"
        parallel: true
        story_id: null
        file_path: "internal/lifecycle/"
        dependencies: ["T001"]
        acceptance_criteria:
          - "Directory internal/lifecycle/ exists"

  - number: 2
    title: "Foundational - Event System"
    purpose: "Core event infrastructure that MUST be complete before user stories"
    tasks:
      - id: "T004"
        title: "Create internal/events/doc.go with package documentation"
        status: "Pending"
        type: "documentation"
        parallel: false
        story_id: null
        file_path: "internal/events/doc.go"
        dependencies: ["T002"]
        acceptance_criteria:
          - "Package doc comment explains event system purpose"
          - "References docs/events.md for detailed documentation"
          - "go doc github.com/your-org/autospec/internal/events shows documentation"

      - id: "T005"
        title: "Create internal/events/types.go with event struct definitions"
        status: "Pending"
        type: "implementation"
        parallel: false
        story_id: null
        file_path: "internal/events/types.go"
        dependencies: ["T004"]
        acceptance_criteria:
          - "TypeCommandComplete and TypeStageComplete uint32 constants defined"
          - "CommandCompleteEvent struct with Name, Success, Duration, Error fields"
          - "StageCompleteEvent struct with Name, Success, Duration fields"
          - "Both structs implement Type() uint32 method"
          - "Fields have doc comments explaining their purpose"

      - id: "T006"
        title: "Create internal/events/bus.go with global dispatcher and helpers"
        status: "Pending"
        type: "implementation"
        parallel: false
        story_id: null
        file_path: "internal/events/bus.go"
        dependencies: ["T005"]
        acceptance_criteria:
          - "Global bus variable initialized with event.NewDispatcher()"
          - "Subscribe[T event.Event](handler func(T)) func() implemented"
          - "Publish[T event.Event](e T) implemented"
          - "Functions are type-safe using generics"
          - "Doc comments explain usage patterns"

      - id: "T007"
        title: "Create internal/events/bus_test.go with comprehensive tests"
        status: "Pending"
        type: "test"
        parallel: false
        story_id: null
        file_path: "internal/events/bus_test.go"
        dependencies: ["T006"]
        acceptance_criteria:
          - "TestSubscribe verifies handler registration and callback"
          - "TestPublish verifies event delivery to subscribers"
          - "TestUnsubscribe verifies handler removal"
          - "TestMultipleSubscribers verifies all subscribers receive events"
          - "Tests use map-based table-driven pattern with t.Parallel()"
          - "Tests pass with go test -race ./internal/events/..."

  - number: 3
    title: "User Story 1 - Command Lifecycle Automation (US-001)"
    purpose: "Wrap command execution in lifecycle manager that handles timing, events, and notifications automatically"
    story_reference: "US-001"
    independent_test: "Create a test command that uses lifecycle.Run() and verify events are emitted without manual notification code"
    tasks:
      - id: "T008"
        title: "Create internal/lifecycle/doc.go with package documentation"
        status: "Pending"
        type: "documentation"
        parallel: false
        story_id: "US-001"
        file_path: "internal/lifecycle/doc.go"
        dependencies: ["T003", "T006"]
        acceptance_criteria:
          - "Package doc comment explains lifecycle manager purpose"
          - "Documents Run() and RunWithContext() usage"
          - "References events package for event types"

      - id: "T009"
        title: "Create internal/lifecycle/run.go with Run() function"
        status: "Pending"
        type: "implementation"
        parallel: false
        story_id: "US-001"
        file_path: "internal/lifecycle/run.go"
        dependencies: ["T008"]
        acceptance_criteria:
          - "Run(name string, fn func() error) error signature"
          - "Captures start time before fn execution"
          - "Publishes CommandCompleteEvent with name, success, duration, error"
          - "Returns error from fn unchanged"
          - "Function under 40 lines"

      - id: "T010"
        title: "Add RunWithContext() for cancellation support"
        status: "Pending"
        type: "implementation"
        parallel: false
        story_id: "US-001"
        file_path: "internal/lifecycle/run.go"
        dependencies: ["T009"]
        acceptance_criteria:
          - "RunWithContext(ctx context.Context, name string, fn func() error) error signature"
          - "Checks context cancellation before and after fn"
          - "Emits event with Error=context.Canceled, Success=false on cancellation"
          - "Function under 40 lines"

      - id: "T011"
        title: "Create internal/lifecycle/run_test.go with unit tests"
        status: "Pending"
        type: "test"
        parallel: false
        story_id: "US-001"
        file_path: "internal/lifecycle/run_test.go"
        dependencies: ["T010"]
        acceptance_criteria:
          - "TestRun_Success verifies event emission on success"
          - "TestRun_Failure verifies event emission with error"
          - "TestRunWithContext_Cancelled verifies cancellation handling"
          - "TestRunWithContext_Success verifies normal execution"
          - "Tests use map-based table-driven pattern with t.Parallel()"
          - "Tests pass with go test -race ./internal/lifecycle/..."

  - number: 4
    title: "User Story 2 & 3 - Event Subscription and Thread Safety (US-002, US-003)"
    purpose: "Enable notification system to subscribe to events via event bus with thread-safe operations"
    story_reference: "US-002"
    independent_test: "Subscribe a mock handler to the event bus, publish an event, verify handler receives it; run with -race flag"
    tasks:
      - id: "T012"
        title: "Create internal/notify/subscriber.go with Subscribe() method"
        status: "Pending"
        type: "implementation"
        parallel: false
        story_id: "US-002"
        file_path: "internal/notify/subscriber.go"
        dependencies: ["T007"]
        acceptance_criteria:
          - "Subscribe() func() method on Handler struct"
          - "Registers handler for CommandCompleteEvent using events.Subscribe()"
          - "Registers handler for StageCompleteEvent using events.Subscribe()"
          - "Returns composite unsubscribe function"
          - "Doc comments explain usage pattern"

      - id: "T013"
        title: "Add onCommandComplete handler method to notify.Handler"
        status: "Pending"
        type: "implementation"
        parallel: false
        story_id: "US-002"
        file_path: "internal/notify/subscriber.go"
        dependencies: ["T012"]
        acceptance_criteria:
          - "onCommandComplete(e events.CommandCompleteEvent) method"
          - "Extracts name, success, duration from event"
          - "Calls existing notification logic (sound, visual)"
          - "Includes defer/recover for panic safety"
          - "Function under 40 lines"

      - id: "T014"
        title: "Add onStageComplete handler method to notify.Handler"
        status: "Pending"
        type: "implementation"
        parallel: true
        story_id: "US-002"
        file_path: "internal/notify/subscriber.go"
        dependencies: ["T012"]
        acceptance_criteria:
          - "onStageComplete(e events.StageCompleteEvent) method"
          - "Extracts name, success, duration from event"
          - "Calls existing stage notification logic"
          - "Includes defer/recover for panic safety"
          - "Function under 40 lines"

      - id: "T015"
        title: "Create internal/notify/subscriber_test.go with tests"
        status: "Pending"
        type: "test"
        parallel: false
        story_id: "US-002"
        file_path: "internal/notify/subscriber_test.go"
        dependencies: ["T013", "T014"]
        acceptance_criteria:
          - "TestSubscribe verifies handler registration"
          - "TestOnCommandComplete_Success verifies notification on success"
          - "TestOnCommandComplete_Failure verifies notification on failure"
          - "TestOnStageComplete verifies stage notification"
          - "TestSubscriberPanicRecovery verifies panic handling"
          - "Tests use map-based table-driven pattern with t.Parallel()"
          - "Tests pass with go test -race ./internal/notify/..."

      - id: "T016"
        title: "Add concurrent event handling tests to bus_test.go"
        status: "Pending"
        type: "test"
        parallel: false
        story_id: "US-003"
        file_path: "internal/events/bus_test.go"
        dependencies: ["T007"]
        acceptance_criteria:
          - "TestConcurrentPublish verifies multiple goroutines can publish simultaneously"
          - "TestConcurrentSubscribe verifies subscribers can be added during dispatch"
          - "Tests use sync.WaitGroup for coordination"
          - "Tests pass with go test -race ./internal/events/..."

  - number: 5
    title: "User Story 5 - Migrate CLI Commands (US-005)"
    purpose: "Migrate all 11 workflow commands to use lifecycle wrapper"
    story_reference: "US-005"
    independent_test: "Run each command and verify it still sends notifications on completion"
    tasks:
      - id: "T017"
        title: "Initialize notification subscriber in root command"
        status: "Pending"
        type: "implementation"
        parallel: false
        story_id: "US-005"
        file_path: "internal/cli/root.go"
        dependencies: ["T015"]
        acceptance_criteria:
          - "Create notification handler with config"
          - "Call notifHandler.Subscribe() in root PersistentPreRunE"
          - "Store unsubscribe function for cleanup"
          - "Existing behavior unchanged"

      - id: "T018"
        title: "Migrate specify command to lifecycle.Run()"
        status: "Pending"
        type: "refactor"
        parallel: true
        story_id: "US-005"
        file_path: "internal/cli/specify.go"
        dependencies: ["T017"]
        acceptance_criteria:
          - "Wrap command execution in lifecycle.Run('specify', ...)"
          - "Remove manual notification boilerplate (startTime, duration, OnCommandComplete)"
          - "Command behavior unchanged"
          - "Existing tests pass"

      - id: "T019"
        title: "Migrate plan command to lifecycle.Run()"
        status: "Pending"
        type: "refactor"
        parallel: true
        story_id: "US-005"
        file_path: "internal/cli/plan.go"
        dependencies: ["T017"]
        acceptance_criteria:
          - "Wrap command execution in lifecycle.Run('plan', ...)"
          - "Remove manual notification boilerplate"
          - "Command behavior unchanged"
          - "Existing tests pass"

      - id: "T020"
        title: "Migrate remaining 9 commands to lifecycle.Run()"
        status: "Pending"
        type: "refactor"
        parallel: false
        story_id: "US-005"
        file_path: "internal/cli/"
        dependencies: ["T018", "T019"]
        acceptance_criteria:
          - "tasks.go uses lifecycle.Run('tasks', ...)"
          - "clarify.go uses lifecycle.Run('clarify', ...)"
          - "analyze.go uses lifecycle.Run('analyze', ...)"
          - "checklist.go uses lifecycle.Run('checklist', ...)"
          - "constitution.go uses lifecycle.Run('constitution', ...)"
          - "implement.go uses lifecycle.Run('implement', ...)"
          - "run.go uses lifecycle.Run('run', ...)"
          - "prep.go uses lifecycle.Run('prep', ...)"
          - "all.go uses lifecycle.Run('all', ...)"
          - "All notification boilerplate removed"
          - "All existing tests pass"

  - number: 6
    title: "User Story 6 & Polish - Executor Events and Cleanup (US-006)"
    purpose: "Update executor to emit stage events and clean up dead code"
    story_reference: "US-006"
    independent_test: "Execute a stage, verify EventStageComplete is published"
    tasks:
      - id: "T021"
        title: "Update executor to publish StageCompleteEvent"
        status: "Pending"
        type: "refactor"
        parallel: false
        story_id: "US-006"
        file_path: "internal/workflow/executor.go"
        dependencies: ["T015"]
        acceptance_criteria:
          - "Stage completion publishes events.StageCompleteEvent"
          - "Includes stage name, success status, duration"
          - "Direct notification handler calls removed"

      - id: "T022"
        title: "Remove NotificationHandler field from Executor struct"
        status: "Pending"
        type: "refactor"
        parallel: false
        story_id: "US-006"
        file_path: "internal/workflow/executor.go"
        dependencies: ["T021"]
        acceptance_criteria:
          - "NotificationHandler field removed from Executor struct"
          - "All references to NotificationHandler field removed"
          - "Executor tests updated"

      - id: "T023"
        title: "Update TestAllCommandsHaveNotificationSupport regression test"
        status: "Pending"
        type: "test"
        parallel: false
        story_id: "US-005"
        file_path: "internal/cli/specify_test.go"
        dependencies: ["T020"]
        acceptance_criteria:
          - "Test verifies commands use lifecycle.Run() wrapper"
          - "Test no longer checks for direct notification handler usage"
          - "Test passes for all 11 commands"

      - id: "T024"
        title: "Remove dead notification boilerplate from CLI commands"
        status: "Pending"
        type: "refactor"
        parallel: true
        story_id: null
        file_path: "internal/cli/"
        dependencies: ["T020", "T022"]
        acceptance_criteria:
          - "No startTime/duration/OnCommandComplete patterns remain"
          - "No manual notifHandler setup in individual commands"
          - "Code is cleaner and more maintainable"

      - id: "T025"
        title: "Create integration test for end-to-end event flow"
        status: "Pending"
        type: "test"
        parallel: true
        story_id: null
        file_path: "internal/events/integration_test.go"
        dependencies: ["T020", "T021"]
        acceptance_criteria:
          - "Test verifies full flow: command → lifecycle → event → subscriber"
          - "Test uses mock subscriber to capture events"
          - "Test passes with go test -race"

      - id: "T026"
        title: "Run all quality gates: make test, make fmt, make lint, make build"
        status: "Pending"
        type: "test"
        parallel: false
        story_id: null
        file_path: null
        dependencies: ["T023", "T024", "T025"]
        acceptance_criteria:
          - "make test exits 0 with no failures"
          - "make fmt exits 0 with no changes needed"
          - "make lint exits 0 with no errors"
          - "make build exits 0 successfully"

dependencies:
  user_story_order:
    - story_id: "US-001"
      depends_on: []
      blocks: ["US-005"]
    - story_id: "US-002"
      depends_on: []
      blocks: ["US-005", "US-006"]
    - story_id: "US-003"
      depends_on: []
      blocks: []
    - story_id: "US-004"
      depends_on: []
      blocks: []
      note: "Provided by kelindar/event library default behavior"
    - story_id: "US-005"
      depends_on: ["US-001", "US-002"]
      blocks: ["US-006"]
    - story_id: "US-006"
      depends_on: ["US-002", "US-005"]
      blocks: []

  phase_order:
    - phase: 1
      blocks: [2, 3]
    - phase: 2
      blocks: [3, 4, 5]
    - phase: 3
      blocks: [5]
    - phase: 4
      blocks: [5, 6]
    - phase: 5
      blocks: [6]

parallel_execution:
  - phase: 1
    parallel_groups:
      - tasks: ["T002", "T003"]
        rationale: "Different package directories, no dependencies between them"
  - phase: 4
    parallel_groups:
      - tasks: ["T013", "T014"]
        rationale: "Different handler methods, same file but independent implementations"
  - phase: 5
    parallel_groups:
      - tasks: ["T018", "T019"]
        rationale: "Different command files, same pattern, can be done in parallel"
  - phase: 6
    parallel_groups:
      - tasks: ["T024", "T025"]
        rationale: "Cleanup and integration test are independent tasks"

implementation_strategy:
  mvp_scope:
    phases: [1, 2, 3]
    description: "Setup + Event System + Lifecycle Manager - enables one command to use events"
    validation: "Single command (specify) can use lifecycle.Run() and emit events"
  incremental_delivery:
    - milestone: "Event Foundation Ready"
      phases: [1, 2]
      deliverable: "Event bus functional with Subscribe/Publish; can be tested independently"
    - milestone: "Lifecycle Manager Ready"
      phases: [1, 2, 3]
      deliverable: "lifecycle.Run() works; one command can be migrated"
    - milestone: "Subscriber Pattern Ready"
      phases: [1, 2, 3, 4]
      deliverable: "Notification handler uses event subscription; decoupling complete"
    - milestone: "Full Migration Complete"
      phases: [1, 2, 3, 4, 5]
      deliverable: "All 11 commands use lifecycle wrapper; boilerplate eliminated"
    - milestone: "Feature Complete"
      phases: [1, 2, 3, 4, 5, 6]
      deliverable: "Executor uses events; all tests pass; quality gates pass"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-17T00:15:33Z"
  artifact_type: "tasks"
