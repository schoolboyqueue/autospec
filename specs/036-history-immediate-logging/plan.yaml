plan:
  branch: "036-history-immediate-logging"
  created: "2025-12-17"
  spec_path: "specs/036-history-immediate-logging/spec.yaml"

summary: |
  Implement immediate history logging by writing entries when commands START (with "running" status)
  and updating them when commands COMPLETE. This requires extending the HistoryEntry structure with
  new fields (id, status, created_at, completed_at), creating an ID generator with adjective_noun_timestamp
  format, and modifying the lifecycle wrapper functions to perform two-phase logging: WriteStart before
  command execution and UpdateComplete after. The history CLI will be enhanced to display status with
  color coding and support filtering by status via --status flag.

technical_context:
  language: "Go"
  framework: "Cobra (CLI framework)"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML marshaling for history file storage"
    - name: "github.com/fatih/color"
      version: "v1.16.0"
      purpose: "Color-coded terminal output for status display"
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework"
  storage: "YAML file (~/.autospec/state/history.yaml)"
  testing:
    framework: "Go testing package with testify assertions"
    approach: "Map-based table-driven tests with t.Parallel() for all test functions"
  target_platform: "Cross-platform (Linux, macOS, Windows)"
  project_type: "cli"
  performance_goals: "History write operations must add <50ms latency to command startup"
  constraints:
    - "Must integrate with existing lifecycle wrapper pattern in internal/lifecycle/"
    - "Must not break existing history command functionality"
    - "Must work with existing HistoryLogger interface consumers"
    - "Backward compatibility with old entries lacking new fields"
    - "All functions <40 lines per Go coding standards"
    - "All errors wrapped with context using fmt.Errorf"
  scale_scope: "Local single-user CLI tool with file-based storage"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Tests will be written before implementation for all new functions"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "This feature adds history logging, not workflow phase transitions"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "History writes target <50ms added latency; validation functions remain <10ms"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "History updates are idempotent (same ID can be updated multiple times safely)"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "N/A"
      notes: "No new exit codes introduced; uses existing patterns"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "History entries stored in YAML format with new fields"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All code will pass go fmt, go vet; make fmt before commit"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, wrapped errors, map-based tests, interface-in/concrete-out"

research_findings:
  decisions:
    - topic: "ID format for unique entry identification"
      decision: "Use adjective_noun_YYYYMMDD_HHMMSS format (e.g., brave_fox_20251216_180816)"
      rationale: "Memorable for humans, timestamp provides chronological ordering, word combinations prevent collisions within same second"
      alternatives_considered:
        - "UUID - not memorable, overkill for local use"
        - "Sequential integer - requires state tracking, boring"
        - "Timestamp only - collisions within same second"

    - topic: "Two-phase logging integration point"
      decision: "Extend HistoryLogger interface with WriteStart() and UpdateComplete() methods"
      rationale: "Preserves existing LogCommand() for backward compatibility while adding new two-phase capability"
      alternatives_considered:
        - "Replace LogCommand entirely - breaks existing consumers"
        - "Separate interface - more complex, unnecessary"

    - topic: "Status values for history entries"
      decision: "Use string enum: running, completed, failed, cancelled"
      rationale: "Clear semantic meaning, maps to user stories, distinguishes abnormal terminations"
      alternatives_considered:
        - "Boolean completed flag - loses information about failure vs cancellation"
        - "Numeric status codes - less readable"

    - topic: "Backward compatibility approach"
      decision: "New fields use omitempty; old entries display with defaults (empty ID, status shown as '-')"
      rationale: "No migration needed; gradual adoption as new entries created"
      alternatives_considered:
        - "Migration script - unnecessary complexity"
        - "Separate history file - data fragmentation"

    - topic: "Entry update mechanism"
      decision: "Load history, find entry by ID, update in place, save atomically"
      rationale: "Simple, uses existing atomic write pattern, works with current file format"
      alternatives_considered:
        - "Append-only log with compaction - complex for local use"
        - "SQLite - adds dependency, overkill"

data_model:
  entities:
    - name: "HistoryEntry"
      description: "A record of a single command execution (enhanced from existing)"
      fields:
        - name: "ID"
          type: "string"
          description: "Unique identifier in adjective_noun_YYYYMMDD_HHMMSS format"
          constraints: "Optional for backward compatibility (omitempty)"
        - name: "Timestamp"
          type: "time.Time"
          description: "When command started (RFC3339 in YAML) - kept for backward compat"
          constraints: "Required"
        - name: "Command"
          type: "string"
          description: "Name of autospec command (specify, plan, implement, etc.)"
          constraints: "Required, non-empty"
        - name: "Spec"
          type: "string"
          description: "Spec name or branch being operated on"
          constraints: "Optional (omitempty)"
        - name: "Status"
          type: "string"
          description: "Current state: running, completed, failed, cancelled"
          constraints: "Optional for backward compatibility (omitempty)"
        - name: "CreatedAt"
          type: "time.Time"
          description: "When command started (new field, more explicit name)"
          constraints: "Optional for backward compatibility (omitempty)"
        - name: "CompletedAt"
          type: "*time.Time"
          description: "When command finished (nil if still running)"
          constraints: "Optional, pointer for nullable semantics"
        - name: "ExitCode"
          type: "int"
          description: "Process exit code (0=success)"
          constraints: "Required"
        - name: "Duration"
          type: "string"
          description: "Execution duration in Go format (2m15.123s)"
          constraints: "Required"
      relationships:
        - target: "WordList"
          type: "uses"
          description: "ID generation uses adjective and noun word lists"

    - name: "WordList"
      description: "Embedded word collections for memorable ID generation"
      fields:
        - name: "adjectives"
          type: "[]string"
          description: "List of ~50 descriptive words (brave, calm, swift, etc.)"
          constraints: "Compile-time constant"
        - name: "nouns"
          type: "[]string"
          description: "List of ~50 concrete nouns (fox, river, falcon, etc.)"
          constraints: "Compile-time constant"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/reference.md"
      description: "Update history command documentation with new --status flag"
  source_code:
    - path: "internal/history/history.go"
      description: "Enhanced HistoryEntry struct with ID, Status, CreatedAt, CompletedAt fields"
    - path: "internal/history/idgen.go"
      description: "New file for ID generation with word lists and GenerateID function"
    - path: "internal/history/writer.go"
      description: "Extended Writer with WriteStart and UpdateComplete methods"
    - path: "internal/lifecycle/handler.go"
      description: "Extended HistoryLogger interface with new methods"
    - path: "internal/lifecycle/lifecycle.go"
      description: "Modified RunWithHistory/RunWithHistoryContext for two-phase logging"
    - path: "internal/cli/history.go"
      description: "Enhanced display with status column and --status filter flag"
  tests:
    - path: "internal/history/history_test.go"
      description: "Tests for enhanced HistoryEntry serialization and backward compatibility"
    - path: "internal/history/idgen_test.go"
      description: "Tests for ID generation uniqueness and format validation"
    - path: "internal/history/writer_test.go"
      description: "Tests for WriteStart, UpdateComplete, and two-phase logging"
    - path: "internal/lifecycle/lifecycle_test.go"
      description: "Tests for modified lifecycle wrappers with two-phase logging"
    - path: "internal/cli/history_test.go"
      description: "Tests for status display and --status filter functionality"

implementation_phases:
  - phase: 1
    name: "Core Data Model & ID Generation"
    goal: "Establish enhanced HistoryEntry structure and unique ID generation"
    deliverables:
      - "Enhanced HistoryEntry struct with new fields (ID, Status, CreatedAt, CompletedAt)"
      - "Word lists for ID generation (adjectives, nouns)"
      - "GenerateID() function producing adjective_noun_YYYYMMDD_HHMMSS format"
      - "Unit tests for ID uniqueness and format validation"
      - "Backward compatibility tests for old entries without new fields"

  - phase: 2
    name: "Two-Phase Writer Implementation"
    goal: "Implement WriteStart and UpdateComplete methods in history.Writer"
    dependencies:
      - "Phase 1"
    deliverables:
      - "WriteStart(command, spec) method returning entry ID"
      - "UpdateComplete(id, exitCode, status, duration) method"
      - "Entry lookup by ID helper function"
      - "Tests for two-phase write workflow"
      - "Tests for crash/interrupt scenarios (entry remains with running status)"

  - phase: 3
    name: "Lifecycle Integration"
    goal: "Modify lifecycle wrappers to perform two-phase history logging"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Extended HistoryLogger interface with WriteStart and UpdateComplete"
      - "Modified RunWithHistory to call WriteStart before fn(), UpdateComplete after"
      - "Modified RunWithHistoryContext with same two-phase pattern"
      - "Status determination logic (completed/failed/cancelled)"
      - "Tests for lifecycle wrapper with two-phase logging"

  - phase: 4
    name: "CLI Enhancements"
    goal: "Add status display and filtering to history command"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Status column in history output with color coding (green/yellow/red)"
      - "ID column in history output"
      - "--status flag for filtering by status value"
      - "Backward-compatible display of old entries without new fields"
      - "Tests for status display and filtering"
      - "Updated documentation in docs/reference.md"

  - phase: 5
    name: "Quality Assurance"
    goal: "Ensure all quality gates pass and feature is production-ready"
    dependencies:
      - "Phase 4"
    deliverables:
      - "All tests pass (make test)"
      - "Code formatted (make fmt)"
      - "No lint errors (make lint)"
      - "Successful build (make build)"
      - "Manual testing of end-to-end workflow"

risks:
  - risk: "ID collisions within same second"
    likelihood: "low"
    impact: "low"
    mitigation: "Word combination permutations (50x50=2500) make same-second collisions unlikely; application typically runs one command at a time"

  - risk: "Performance impact from additional file write on command start"
    likelihood: "medium"
    impact: "low"
    mitigation: "Atomic write pattern already used; YAML file is small; target <50ms latency is achievable"

  - risk: "Breaking existing HistoryLogger consumers"
    likelihood: "low"
    impact: "medium"
    mitigation: "Add new methods to interface rather than changing existing; existing LogCommand() remains unchanged"

  - risk: "Corrupted history file after crash during update"
    likelihood: "low"
    impact: "medium"
    mitigation: "Existing atomic write pattern (write to .tmp, then rename) protects against partial writes"

open_questions:
  - question: "Should we add a 'stale' status for running entries older than a threshold?"
    context: "If a command crashes without cleanup, entries remain 'running' forever"
    proposed_resolution: "Out of scope for this feature; could be addressed in future cleanup command"

  - question: "Should ID be displayed in full or truncated format?"
    context: "Full ID (brave_fox_20251216_180816) is 26+ characters"
    proposed_resolution: "Display full ID; it's designed to be memorable and useful for reference"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-17T02:20:22Z"
  artifact_type: "plan"
