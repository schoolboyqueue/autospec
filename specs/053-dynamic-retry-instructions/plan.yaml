plan:
  branch: "053-dynamic-retry-instructions"
  created: "2025-12-18"
  spec_path: "specs/053-dynamic-retry-instructions/spec.yaml"

summary: |
  This implementation refactors the retry context handling to dynamically inject retry instructions
  only when actual retries occur, rather than statically including ~50 lines of retry documentation
  in every command template. The solution centers on modifying FormatRetryContext in executor.go
  to append shared retry handling instructions alongside the error data, while simultaneously
  removing the "## Retry Context" sections from the three command templates (specify.md, plan.md,
  tasks.md). The instructions will be stored as an embedded Go constant, ensuring a single source
  of truth and eliminating duplication across templates.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML artifact parsing and validation"
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI command framework"
  storage: "None"
  testing:
    framework: "go test"
    approach: "Table-driven unit tests with t.Parallel(); integration tests for retry workflow"
  target_platform: "linux, darwin, windows (cross-platform)"
  project_type: "cli"
  performance_goals: "First-run prompts reduced by ~1500-2000 characters"
  constraints:
    - "Must maintain backward compatibility with existing retry state files"
    - "Cannot change RETRY X/Y format relied upon by tooling"
    - "Command templates must remain valid markdown after changes"
    - "Functions must be under 40 lines"
    - "All errors must be wrapped with context"
  scale_scope: "Single codebase refactoring; affects 3 command templates and 1 Go file"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Tests will be written for new FormatRetryContext behavior before implementation"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "This change is internal to retry handling, not workflow phase transitions"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Reduces first-run prompt size; FormatRetryContext is already <10ms"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Retry behavior remains functionally identical; only documentation delivery changes"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions kept under 40 lines; errors wrapped; table-driven tests used"
    - name: "Command Template Independence (PRIN-012)"
      status: "PASS"
      notes: "Retry instructions move to Go code; templates become simpler and more project-agnostic"

research_findings:
  decisions:
    - topic: "Storage location for shared retry instructions"
      decision: "Embedded Go constant in executor.go"
      rationale: "Keeps retry logic self-contained in the workflow package; no external file dependencies; easy to test"
      alternatives_considered:
        - "Separate .md file loaded at runtime - adds file I/O and potential failure modes"
        - "go:embed directive for a separate file - adds complexity without benefit for ~50 lines"
    - topic: "Injection point for retry instructions"
      decision: "Append to FormatRetryContext output"
      rationale: "FormatRetryContext is only called during actual retries, making it the natural place; BuildRetryCommand remains unchanged"
      alternatives_considered:
        - "Modify BuildRetryCommand instead - FormatRetryContext is more semantically appropriate"
        - "Create new function - adds complexity; FormatRetryContext already handles retry context formatting"
    - topic: "Instructions content scope"
      decision: "Generic retry instructions covering common schema errors across all artifact types"
      rationale: "Spec/plan/tasks have overlapping error patterns; generic instructions reduce maintenance"
      alternatives_considered:
        - "Per-artifact-type instructions - would require stage parameter and increase complexity"

data_model:
  entities:
    - name: "RetryInstructions"
      description: "Shared documentation content explaining how to parse and handle retry context"
      fields:
        - name: "Content"
          type: "const string"
          description: "Markdown-formatted retry handling instructions"
          constraints: "Static embedded constant; ~50 lines"
      relationships: []
    - name: "RetryContext"
      description: "Formatted string containing retry attempt info and validation errors (existing entity, modified)"
      fields:
        - name: "AttemptInfo"
          type: "string"
          description: "RETRY X/Y format line"
          constraints: "Always present in retry context"
        - name: "ValidationErrors"
          type: "[]string"
          description: "List of schema validation errors"
          constraints: "May be empty for non-validation retries"
        - name: "Instructions"
          type: "string"
          description: "Handling instructions (NEW - dynamically appended)"
          constraints: "Only present when validation errors exist"
      relationships:
        - target: "RetryInstructions"
          type: "includes"
          description: "RetryContext includes RetryInstructions content when validation errors are present"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "internal/commands/autospec.specify.md"
      description: "Specify command template - removing ~50 line Retry Context section"
    - path: "internal/commands/autospec.plan.md"
      description: "Plan command template - removing ~50 line Retry Context section"
    - path: "internal/commands/autospec.tasks.md"
      description: "Tasks command template - removing ~50 line Retry Context section"
  source_code:
    - path: "internal/workflow/executor.go"
      description: "Add retryInstructions constant; modify FormatRetryContext to append instructions"
  tests:
    - path: "internal/workflow/executor_test.go"
      description: "Update TestFormatRetryContext to verify instructions are appended; add new test cases"

implementation_phases:
  - phase: 1
    name: "Add Shared Retry Instructions"
    goal: "Create single source of truth for retry handling instructions in Go code"
    deliverables:
      - "Add retryInstructions const to executor.go with generic retry handling documentation"
      - "Write tests verifying the constant content covers key scenarios"
  - phase: 2
    name: "Modify FormatRetryContext"
    goal: "Dynamically inject retry instructions when formatting retry context with errors"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Update FormatRetryContext to append retryInstructions when validationErrors is non-empty"
      - "Update existing TestFormatRetryContext cases to expect instructions in output"
      - "Add test cases for edge cases: empty errors, execution errors"
  - phase: 3
    name: "Remove Static Retry Sections"
    goal: "Clean up command templates by removing duplicated retry documentation"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Remove '## Retry Context' section from autospec.specify.md"
      - "Remove '## Retry Context' section from autospec.plan.md"
      - "Remove '## Retry Context' section from autospec.tasks.md"
      - "Verify templates remain valid markdown"
  - phase: 4
    name: "Validation and Quality Gates"
    goal: "Ensure all changes pass quality checks and retry functionality works correctly"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Run make test and verify all tests pass"
      - "Run make fmt and verify no formatting changes"
      - "Run make lint and verify no lint errors"
      - "Run make build and verify successful compilation"
      - "Manual verification: first-run prompt size reduced"

risks:
  - risk: "Retry instructions may need artifact-specific content"
    likelihood: "low"
    impact: "medium"
    mitigation: "Current instructions are generic enough to cover all artifact types; can add artifact-specific sections if needed later"
  - risk: "Changing FormatRetryContext output may break existing retry state parsing"
    likelihood: "low"
    impact: "low"
    mitigation: "Instructions are appended after error list; RETRY X/Y header format unchanged"
  - risk: "Removed template sections may contain nuances not captured in shared instructions"
    likelihood: "medium"
    impact: "low"
    mitigation: "Review all three removed sections to ensure shared instructions cover all documented patterns"

open_questions:
  - question: "Should retry instructions be included when there are no validation errors (e.g., execution timeout)?"
    context: "FormatRetryContext currently returns just 'RETRY X/Y' when errors list is empty"
    proposed_resolution: "Only include instructions when validation errors are present; execution errors don't need schema fix guidance"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-18T20:47:21Z"
  artifact_type: "plan"
