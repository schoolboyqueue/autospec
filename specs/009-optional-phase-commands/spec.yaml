_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "dev"
  created: "2025-12-14T09:00:00Z"
  artifact_type: "spec"

feature:
  branch: "009-optional-phase-commands"
  created: "2025-12-14"
  status: "Draft"
  input: "Add standalone CLI commands and run command flags for the optional SpecKit phases: analyze, constitution, clarify, and checklist"

user_stories:
  - id: "US-001"
    title: "Standalone Optional Commands"
    priority: "P1"
    as_a: "developer using autospec"
    i_want: "to run optional phases directly from the command line (autospec checklist, autospec analyze, etc.)"
    so_that: "I can use them without invoking Claude Code slash commands manually"
    why_this_priority: "Core feature requirement - without standalone commands, users cannot access optional phases via CLI"
    independent_test: "Run each standalone command individually and verify it executes the corresponding slash command"
    acceptance_scenarios:
      - given: "I have a valid spec.yaml in the current spec directory"
        when: "I run 'autospec checklist'"
        then: "The /autospec.checklist slash command is executed"
      - given: "I have a valid spec.yaml in the current spec directory"
        when: "I run 'autospec analyze'"
        then: "The /autospec.analyze slash command is executed"
      - given: "I have a valid spec.yaml in the current spec directory"
        when: "I run 'autospec clarify'"
        then: "The /autospec.clarify slash command is executed"
      - given: "I am in a project directory"
        when: "I run 'autospec constitution'"
        then: "The /autospec.constitution slash command is executed"
      - given: "I want to guide the command execution"
        when: "I run 'autospec checklist \"Focus on security\"'"
        then: "The prompt argument is passed to the slash command"

  - id: "US-002"
    title: "Run Command Integration"
    priority: "P1"
    as_a: "developer using flexible phase workflows"
    i_want: "to include optional phases in my autospec run combinations"
    so_that: "I can run complete workflows with validation in a single command"
    why_this_priority: "Enables full workflow flexibility - essential for combining optional and core phases"
    independent_test: "Use run command with optional phase flags and verify phases execute in correct order"
    acceptance_scenarios:
      - given: "I want to run checklist as part of a workflow"
        when: "I run 'autospec run -c' or 'autospec run --checklist'"
        then: "The checklist phase is included in the execution"
      - given: "I want to run analyze as part of a workflow"
        when: "I run 'autospec run -z' or 'autospec run --analyze'"
        then: "The analyze phase is included in the execution"
      - given: "I want to run clarify as part of a workflow"
        when: "I run 'autospec run -r' or 'autospec run --clarify'"
        then: "The clarify phase is included in the execution"
      - given: "I want to run constitution as part of a workflow"
        when: "I run 'autospec run -n' or 'autospec run --constitution'"
        then: "The constitution phase is included in the execution"
      - given: "I want to combine multiple phases"
        when: "I run 'autospec run -sptic'"
        then: "Specify, plan, tasks, implement, and checklist phases run in canonical order"

  - id: "US-003"
    title: "Canonical Execution Order"
    priority: "P1"
    as_a: "developer running combined workflows"
    i_want: "optional phases to execute at sensible points in the workflow"
    so_that: "validations happen at the right time and dependencies are satisfied"
    why_this_priority: "Incorrect ordering would cause failures or produce invalid results"
    independent_test: "Run a workflow with all phases and verify execution order matches canonical order"
    acceptance_scenarios:
      - given: "I run a workflow including constitution"
        when: "I run 'autospec run -ns'"
        then: "Constitution runs before specify"
      - given: "I run a workflow including clarify"
        when: "I run 'autospec run -srp'"
        then: "Clarify runs after specify and before plan"
      - given: "I run a workflow including checklist and analyze"
        when: "I run 'autospec run -tczi'"
        then: "Checklist runs after tasks, analyze runs after checklist, implement runs last"
      - given: "I specify phases in any order"
        when: "I run 'autospec run -icts'"
        then: "Phases execute in canonical order: specify, tasks, checklist, implement (regardless of flag order)"

requirements:
  functional:
    - id: "FR-001"
      description: "System MUST provide 'autospec checklist [prompt]' command that executes /autospec.checklist"
      testable: true
      acceptance_criteria: "Running 'autospec checklist' invokes Claude with /autospec.checklist command"
    - id: "FR-002"
      description: "System MUST provide 'autospec analyze [prompt]' command that executes /autospec.analyze"
      testable: true
      acceptance_criteria: "Running 'autospec analyze' invokes Claude with /autospec.analyze command"
    - id: "FR-003"
      description: "System MUST provide 'autospec clarify [prompt]' command that executes /autospec.clarify"
      testable: true
      acceptance_criteria: "Running 'autospec clarify' invokes Claude with /autospec.clarify command"
    - id: "FR-004"
      description: "System MUST provide 'autospec constitution [prompt]' command that executes /autospec.constitution"
      testable: true
      acceptance_criteria: "Running 'autospec constitution' invokes Claude with /autospec.constitution command"
    - id: "FR-005"
      description: "System MUST support -c/--checklist flag in run command"
      testable: true
      acceptance_criteria: "Flag is recognized and includes checklist phase in workflow"
    - id: "FR-006"
      description: "System MUST support -z/--analyze flag in run command"
      testable: true
      acceptance_criteria: "Flag is recognized and includes analyze phase in workflow"
    - id: "FR-007"
      description: "System MUST support -r/--clarify flag in run command"
      testable: true
      acceptance_criteria: "Flag is recognized and includes clarify phase in workflow"
    - id: "FR-008"
      description: "System MUST support -n/--constitution flag in run command"
      testable: true
      acceptance_criteria: "Flag is recognized and includes constitution phase in workflow"
    - id: "FR-009"
      description: "System MUST execute phases in canonical order when combined: constitution, specify, clarify, plan, tasks, checklist, analyze, implement"
      testable: true
      acceptance_criteria: "Regardless of flag order, phases execute in canonical order"
    - id: "FR-010"
      description: "System MUST validate prerequisites for optional phases before execution"
      testable: true
      acceptance_criteria: "Clarify requires spec.yaml; checklist requires spec.yaml; analyze requires spec.yaml, plan.yaml, tasks.yaml"
  non_functional:
    - id: "NFR-001"
      category: "usability"
      description: "Short flag mnemonics MUST be memorable and avoid conflicts with existing flags"
      measurable_target: "-c (checklist), -z (analyze), -r (clarify), -n (constitution)"
    - id: "NFR-002"
      category: "reliability"
      description: "Invalid phase combinations MUST produce clear error messages"
      measurable_target: "Error message specifies which prerequisites are missing"
    - id: "NFR-003"
      category: "performance"
      description: "Phase configuration and ordering MUST complete in under 10ms"
      measurable_target: "Phase setup adds negligible overhead to command execution"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "All four standalone optional commands are accessible via CLI"
      metric: "Number of commands available"
      target: "4 commands: checklist, analyze, clarify, constitution"
    - id: "SC-002"
      description: "All four optional phase flags work with run command"
      metric: "Number of flags recognized"
      target: "4 flags: -c/-z/-r/-n with long alternatives"
    - id: "SC-003"
      description: "Combined workflows execute in correct order"
      metric: "Phase execution order matches canonical order"
      target: "100% adherence to canonical order for all flag combinations"
    - id: "SC-004"
      description: "Prerequisites are validated before phase execution"
      metric: "Percentage of invalid states caught before execution"
      target: "100% of missing prerequisites detected and reported"

key_entities:
  - name: "Phase"
    description: "A distinct step in the autospec workflow that can be executed standalone or combined"
    attributes:
      - "name (string): Phase identifier"
      - "short_flag (string): Single-character flag for run command"
      - "long_flag (string): Full flag name for run command"
      - "slash_command (string): Corresponding Claude Code slash command"
      - "required_artifacts (list): Artifacts that must exist before execution"
      - "produced_artifacts (list): Artifacts created by this phase"
  - name: "PhaseConfig"
    description: "Configuration specifying which phases to execute in a workflow"
    attributes:
      - "selected_phases (list): Phases selected for execution"
      - "canonical_order (list): Fixed execution order for all phases"
      - "external_dependencies (list): Artifacts required from outside selected phases"

edge_cases:
  - scenario: "User runs clarify without a spec.yaml"
    expected_behavior: "System displays error message indicating spec.yaml is required and exits with code 4 (missing dependency)"
  - scenario: "User runs analyze without all required artifacts"
    expected_behavior: "System displays error listing which of spec.yaml, plan.yaml, tasks.yaml are missing"
  - scenario: "User specifies conflicting flags (none)"
    expected_behavior: "Not applicable - optional phases do not conflict with each other or core phases"
  - scenario: "User runs constitution in a project without existing constitution"
    expected_behavior: "Constitution command creates a new constitution file"
  - scenario: "User combines -a (all) with optional phase flags"
    expected_behavior: "Both core phases (-spti) and specified optional phases execute in canonical order"
  - scenario: "User runs optional phase standalone without spec context"
    expected_behavior: "System attempts spec detection; if detection fails, displays error asking for spec name"

assumptions:
  - "The existing /autospec.* slash commands are functional and available"
  - "The run command infrastructure from 008-flexible-phase-workflow is complete"
  - "Users understand the difference between core and optional phases"
  - "Optional phases can be run independently of core workflow phases"
  - "Phase detection logic applies to optional phases the same way as core phases"

constraints:
  - "Short flags must not conflict with existing run command flags (-s, -p, -t, -i, -a, -y)"
  - "Canonical order is fixed and cannot be changed by users"
  - "Optional phases do not modify the behavior of autospec all command"
  - "Phase execution follows same retry and validation patterns as core phases"

out_of_scope:
  - "Adding optional phases to autospec all command (keeps existing 4-phase behavior)"
  - "Creating new slash commands (already exist as /autospec.*)"
  - "Modifying the YAML artifact schemas"
  - "Adding configuration options to change canonical phase order"
  - "Inter-phase data passing or result chaining"
  - "Parallel phase execution"
