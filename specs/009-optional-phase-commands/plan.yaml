_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "dev"
  created: "2025-12-14T09:30:00Z"
  artifact_type: "plan"

plan:
  branch: "009-optional-phase-commands"
  created: "2025-12-14"
  spec_path: "specs/009-optional-phase-commands/spec.yaml"

summary: |
  This feature extends the autospec CLI by adding four new standalone commands (checklist, analyze,
  clarify, constitution) and integrating four corresponding phase flags (-c, -z, -r, -n) into the
  existing run command infrastructure. The implementation leverages the existing PhaseConfig and
  Executor patterns, extending them to support optional phases that execute at specific points in the
  canonical workflow order: constitution -> specify -> clarify -> plan -> tasks -> checklist ->
  analyze -> implement. Each optional phase maps to an existing /autospec.* slash command and
  follows the same retry, validation, and prompt injection patterns as core phases.

technical_context:
  language: "Go"
  framework: "Cobra CLI (v1.10.1)"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI command framework"
    - name: "github.com/knadh/koanf"
      version: "v2.3.0"
      purpose: "Configuration management"
  storage: "File system (YAML artifacts in specs/*/ directories)"
  testing:
    framework: "Go testing package + testify"
    approach: "Unit tests for phase config, integration tests for command execution"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Phase configuration and ordering complete in <10ms (NFR-003)"
  constraints:
    - "Short flags must not conflict with existing: -s, -p, -t, -i, -a, -y, -r (max-retries)"
    - "Canonical order is fixed and enforced by PhaseConfig"
    - "Optional phases do not modify autospec all command behavior"
    - "Phase execution uses same retry/validation patterns as core phases"
  scale_scope: "Single-user CLI tool with local file system operations"

constitution_check:
  constitution_path: ".specify/memory/constitution.md"
  gates:
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests for new phase config fields and CLI commands will be written before implementation"
    - name: "Validation-First"
      status: "PASS"
      notes: "Artifact dependency checks already exist; will be extended for optional phases"
    - name: "Performance Standards"
      status: "PASS"
      notes: "Phase configuration is <10ms; no new validation bottlenecks introduced"
    - name: "Idempotency & Retry Logic"
      status: "PASS"
      notes: "Optional phases use existing ExecutePhase pattern with retry support"

research_findings:
  decisions:
    - topic: "Short flag selection for optional phases"
      decision: "Use -c (checklist), -z (analyze), -r (clarify), -n (constitution)"
      rationale: "-c is intuitive for checklist; -z avoids -a conflict; -r repurposed from max-retries (now long-only); -n for coNstitution"
      alternatives_considered:
        - "-l for checklist (conflicts with potential logging flag)"
        - "-a for analyze (conflicts with --all)"
        - "-y for clarify (conflicts with --yes)"
    - topic: "Phase constant naming convention"
      decision: "Add PhaseChecklist, PhaseAnalyze, PhaseClarify, PhaseConstitution to executor.go"
      rationale: "Follows existing naming pattern (PhaseSpecify, PhasePlan, etc.)"
      alternatives_considered:
        - "Use separate type for optional phases (adds complexity)"
    - topic: "Canonical order placement of optional phases"
      decision: "constitution -> specify -> clarify -> plan -> tasks -> checklist -> analyze -> implement"
      rationale: "Constitution sets project principles before specify; clarify refines spec before planning; checklist/analyze validate artifacts before implementation"
      alternatives_considered:
        - "Group all optional phases at end"
        - "Allow user-defined ordering (violates spec constraint)"
    - topic: "Flag conflict resolution for -r"
      decision: "Move max-retries from -r to long-only flag, use -r for clarify"
      rationale: "-r is more intuitive for claRify than max-retries; max-retries is rarely used interactively"
      alternatives_considered:
        - "Use -f for clarify (less intuitive)"
        - "Use -q for clarify (less intuitive)"

data_model:
  entities:
    - name: "Phase"
      description: "Enumerated constant representing a workflow phase"
      fields:
        - name: "PhaseConstitution"
          type: "Phase constant"
          description: "Constitution phase identifier"
          constraints: "Value: 'constitution'"
        - name: "PhaseClarify"
          type: "Phase constant"
          description: "Clarify phase identifier"
          constraints: "Value: 'clarify'"
        - name: "PhaseChecklist"
          type: "Phase constant"
          description: "Checklist phase identifier"
          constraints: "Value: 'checklist'"
        - name: "PhaseAnalyze"
          type: "Phase constant"
          description: "Analyze phase identifier"
          constraints: "Value: 'analyze'"
      relationships: []
    - name: "PhaseConfig"
      description: "Configuration specifying which phases to execute"
      fields:
        - name: "Constitution"
          type: "bool"
          description: "Include constitution phase"
          constraints: "Default: false"
        - name: "Clarify"
          type: "bool"
          description: "Include clarify phase"
          constraints: "Default: false"
        - name: "Checklist"
          type: "bool"
          description: "Include checklist phase"
          constraints: "Default: false"
        - name: "Analyze"
          type: "bool"
          description: "Include analyze phase"
          constraints: "Default: false"
      relationships:
        - target: "Phase"
          type: "composition"
          description: "PhaseConfig uses Phase constants for ordering"
    - name: "ArtifactDependency"
      description: "Dependency map for optional phases"
      fields:
        - name: "PhaseClarify requires"
          type: "[]string"
          description: "Artifacts needed before clarify"
          constraints: "[spec.yaml]"
        - name: "PhaseChecklist requires"
          type: "[]string"
          description: "Artifacts needed before checklist"
          constraints: "[spec.yaml]"
        - name: "PhaseAnalyze requires"
          type: "[]string"
          description: "Artifacts needed before analyze"
          constraints: "[spec.yaml, plan.yaml, tasks.yaml]"
        - name: "PhaseConstitution requires"
          type: "[]string"
          description: "Artifacts needed before constitution"
          constraints: "[] (no prerequisites)"
      relationships:
        - target: "Phase"
          type: "mapping"
          description: "Maps each phase to its required/produced artifacts"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "CLAUDE.md"
      description: "Update CLI section with new commands and flags"
    - path: "README.md"
      description: "Update usage examples if applicable"
  source_code:
    - path: "internal/cli/checklist.go"
      description: "Standalone checklist command"
    - path: "internal/cli/analyze.go"
      description: "Standalone analyze command"
    - path: "internal/cli/clarify.go"
      description: "Standalone clarify command"
    - path: "internal/cli/constitution.go"
      description: "Standalone constitution command"
    - path: "internal/cli/run.go"
      description: "Add optional phase flags and update execution logic"
    - path: "internal/workflow/phase_config.go"
      description: "Add optional phase fields and update canonical order"
    - path: "internal/workflow/executor.go"
      description: "Add optional phase constants"
    - path: "internal/workflow/workflow.go"
      description: "Add Execute* methods for optional phases"
  tests:
    - path: "internal/workflow/phase_config_test.go"
      description: "Tests for extended PhaseConfig with optional phases"
    - path: "internal/cli/run_test.go"
      description: "Tests for run command with optional phase flags"

implementation_phases:
  - phase: 1
    name: "Extend Phase Constants and Config"
    goal: "Add optional phase constants and update PhaseConfig struct"
    deliverables:
      - "Add PhaseConstitution, PhaseClarify, PhaseChecklist, PhaseAnalyze constants to executor.go"
      - "Add Constitution, Clarify, Checklist, Analyze fields to PhaseConfig"
      - "Update GetSelectedPhases/GetCanonicalOrder to include optional phases in correct order"
      - "Update HasAnyPhase and Count methods"
      - "Add artifact dependencies for optional phases"
      - "Unit tests for all new PhaseConfig functionality"
  - phase: 2
    name: "Implement Workflow Methods"
    goal: "Add Execute* methods for optional phases in workflow orchestrator"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Add ExecuteConstitution method to WorkflowOrchestrator"
      - "Add ExecuteClarify method to WorkflowOrchestrator"
      - "Add ExecuteChecklist method to WorkflowOrchestrator"
      - "Add ExecuteAnalyze method to WorkflowOrchestrator"
      - "Implement validation functions for optional phases (file existence checks)"
  - phase: 3
    name: "Create Standalone Commands"
    goal: "Add CLI commands for each optional phase"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Create internal/cli/constitution.go with constitution command"
      - "Create internal/cli/clarify.go with clarify command"
      - "Create internal/cli/checklist.go with checklist command"
      - "Create internal/cli/analyze.go with analyze command"
      - "Each command supports optional prompt argument"
      - "Register all commands in init() functions"
  - phase: 4
    name: "Integrate with Run Command"
    goal: "Add optional phase flags to run command"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Add -c/--checklist flag to run command"
      - "Add -z/--analyze flag to run command"
      - "Add -r/--clarify flag to run command (move max-retries to long-only)"
      - "Add -n/--constitution flag to run command"
      - "Update executePhases to handle optional phases"
      - "Update artifact dependency checking for optional phases"
  - phase: 5
    name: "Documentation and Testing"
    goal: "Complete documentation and integration tests"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Update CLAUDE.md with new commands and flags"
      - "Update README.md usage examples"
      - "Integration tests for run command with optional phases"
      - "Test canonical ordering with various flag combinations"

risks:
  - risk: "Flag conflict with -r for max-retries"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Move max-retries to long-only flag; document breaking change clearly"
  - risk: "Canonical order confusion for users"
    likelihood: "low"
    impact: "low"
    mitigation: "Clear documentation and help text showing execution order"
  - risk: "Missing artifact validation for analyze phase (requires 3 artifacts)"
    likelihood: "low"
    impact: "medium"
    mitigation: "Reuse existing CheckArtifactDependencies infrastructure"

open_questions:
  - question: "Should -a (all) include optional phases?"
    context: "Spec says 'Optional phases do not modify autospec all command behavior' but -a with optional flags is allowed"
    proposed_resolution: "-a continues to mean -spti only; optional phases must be explicitly added (e.g., -ac for all + checklist)"
  - question: "Validation behavior for optional phases"
    context: "Analyze/checklist/clarify produce YAML but constitution may modify .specify/memory/constitution.md"
    proposed_resolution: "Each phase has appropriate validation: checklist.yaml for checklist, analysis output for analyze, constitution.md for constitution"
