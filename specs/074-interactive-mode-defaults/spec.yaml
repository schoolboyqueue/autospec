feature:
    branch: "074-interactive-mode-defaults"
    created: "2025-12-21"
    status: "Completed"
    completed_at: 2025-12-22T01:34:52Z
    input: "The autospec default claude arguments using (-p flag) (and also rm --output-format + verbose) make no sense for the 'clarify' AND the 'analyze' arguments (and any other workflow commands that dont create or change any specs/ file. they dont make sense because they recommend a change to the user then exit. interactive mode should be the defualt mode for those commands. i think interactive mode should work if u just remove those flags. You must handle this flow in not just the 'analyze' and 'clarify' cli commands but also if they use the 'run' command with analyze and clarify built in. it will be really smart to utilize our notification system here to notify the user we are starting an interactive claude session! before thta stage begins (ONLY for the run command - AND ONLY if other 'automated' commands run before it! this will remind the user to do the interactive session when it starts."
user_stories:
    - id: "US-001"
      title: "Interactive Mode for Non-Modifying Commands"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "clarify and analyze commands to run in interactive Claude mode by default"
      so_that: "I can engage in a conversation about recommendations instead of receiving one-shot automated output that exits"
      why_this_priority: "Core behavior change that fixes the fundamental UX issue with recommendation-based commands"
      independent_test: "Run 'autospec clarify' or 'autospec analyze' and verify Claude launches in interactive mode (no -p flag, no --output-format stream-json)"
      acceptance_scenarios:
        - given: "I have a valid spec with constitution, spec.yaml, plan.yaml, and tasks.yaml"
          when: "I run 'autospec analyze'"
          then: "Claude launches in interactive mode where I can ask follow-up questions about the analysis"
        - given: "I have a valid spec with constitution and spec.yaml"
          when: "I run 'autospec clarify'"
          then: "Claude launches in interactive mode where I can have a conversation about clarifications"
    - id: "US-002"
      title: "Automated Mode for File-Modifying Commands"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "specify, plan, tasks, implement, constitution, and checklist to continue using automated mode"
      so_that: "these commands can run unattended with retry logic and validation"
      why_this_priority: "Ensures existing automated workflow functionality is preserved"
      independent_test: "Run 'autospec specify \"test feature\"' and verify it uses -p flag with stream-json output"
      acceptance_scenarios:
        - given: "I run any file-modifying command (specify, plan, tasks, implement, constitution, checklist)"
          when: "the command executes"
          then: "Claude is invoked with -p flag and --output-format stream-json for automated processing"
    - id: "US-003"
      title: "Interactive Mode via Run Command"
      priority: "P1"
      as_a: "developer running multi-stage workflows"
      i_want: "analyze and clarify stages within the run command to also use interactive mode"
      so_that: "the same behavior applies whether I use individual commands or the orchestrated run command"
      why_this_priority: "Consistency across all command invocation paths is essential for predictable behavior"
      independent_test: "Run 'autospec run --clarify --plan' and verify clarify uses interactive mode while plan uses automated mode"
      acceptance_scenarios:
        - given: "I run 'autospec run --specify --clarify --plan'"
          when: "the workflow reaches the clarify stage"
          then: "Claude switches to interactive mode for clarify, requiring my input"
        - given: "I run 'autospec run --plan --analyze'"
          when: "the workflow reaches the analyze stage"
          then: "Claude switches to interactive mode for analyze after plan completes"
    - id: "US-004"
      title: "Interactive Session Notification"
      priority: "P2"
      as_a: "developer running multi-stage workflows with the run command"
      i_want: "to be notified when the workflow transitions to an interactive session"
      so_that: "I know when I need to engage with Claude after automated stages complete"
      why_this_priority: "User may step away during automated stages; notification brings them back at the right time"
      independent_test: "Run 'autospec run --specify --clarify' with notifications enabled and verify notification appears before clarify starts"
      acceptance_scenarios:
        - given: "I run 'autospec run --specify --clarify' with notifications enabled"
          when: "specify (automated) completes and clarify (interactive) is about to start"
          then: "I receive a notification indicating an interactive session is starting"
        - given: "I run 'autospec run --clarify' (only interactive command)"
          when: "the command starts"
          then: "no notification is sent because there were no preceding automated stages"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST remove -p flag and --output-format stream-json from DefaultArgs for analyze and clarify stages"
          testable: true
          acceptance_criteria: "Commands invoked without -p flag run in interactive mode; user can send multiple messages"
        - id: "FR-002"
          description: "MUST identify all non-modifying stages that should use interactive mode"
          testable: true
          acceptance_criteria: "analyze stage confirmed as only pure non-modifying stage; clarify modifies spec.yaml but is recommendation-focused"
        - id: "FR-003"
          description: "MUST support stage-specific agent execution options in the workflow layer"
          testable: true
          acceptance_criteria: "StageExecutor can invoke agent with different options per stage (interactive vs automated)"
        - id: "FR-004"
          description: "MUST handle interactive stages correctly in the run command orchestration"
          testable: true
          acceptance_criteria: "run command correctly switches between automated and interactive modes based on stage"
        - id: "FR-005"
          description: "SHOULD add OnInteractiveSessionStart notification hook to the notify.Handler"
          testable: true
          acceptance_criteria: "Handler has method that sends notification when interactive session is about to begin"
        - id: "FR-006"
          description: "SHOULD only send interactive session notification when automated stages preceded it in run command"
          testable: true
          acceptance_criteria: "No notification when running only interactive stages; notification when automated then interactive"
        - id: "FR-007"
          description: "MUST maintain backwards compatibility with existing config options"
          testable: true
          acceptance_criteria: "Existing configs without new options continue to work with default interactive mode for analyze/clarify"
        - id: "FR-008"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-002"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern with t.Parallel()"
          measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
        - id: "NFR-004"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
        - id: "NFR-005"
          category: "usability"
          description: "Interactive mode transition should be seamless with no additional user action required"
          measurable_target: "User sees Claude prompt immediately when interactive stage begins"
        - id: "NFR-006"
          category: "maintainability"
          description: "Stage mode configuration should be centralized and easily extensible for future stages"
          measurable_target: "Adding a new stage with specific mode requires changing only one configuration point"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Non-modifying commands launch Claude in conversation mode"
          metric: "User can send follow-up messages after initial command"
          target: "100% of analyze and clarify invocations support multi-turn conversation"
        - id: "SC-002"
          description: "Users receive timely notification for interactive session transitions"
          metric: "Notification appears within 1 second of automated stage completion"
          target: "Notification delivered before interactive session prompt appears"
        - id: "SC-003"
          description: "No regression in automated workflow functionality"
          metric: "All existing tests pass; specify/plan/tasks/implement/constitution/checklist use automated mode"
          target: "Zero test failures; automated stages maintain current behavior"
key_entities:
    - name: "Stage Mode"
      description: "Classification of whether a stage runs in interactive or automated mode"
      attributes:
        - "Interactive: analyze, clarify"
        - "Automated: specify, plan, tasks, implement, constitution, checklist"
    - name: "ExecOptions"
      description: "Execution options passed to the agent, controlling mode-specific flags"
      attributes:
        - "Autonomous flag (--dangerously-skip-permissions)"
        - "DefaultArgs (currently -p, --verbose, --output-format stream-json)"
        - "Interactive flag (new, omits -p and output-format)"
    - name: "Notification Hook"
      description: "Handler method for sending notifications at specific workflow events"
      attributes:
        - "OnInteractiveSessionStart (new)"
        - "OnCommandComplete (existing)"
        - "OnStageComplete (existing)"
edge_cases:
    - scenario: "User runs 'autospec run --clarify' with only interactive stage"
      expected_behavior: "No interactive session notification sent; command runs in interactive mode directly"
    - scenario: "User runs 'autospec run --specify --plan --tasks --implement' with no interactive stages"
      expected_behavior: "No interactive session notification; all stages use automated mode as before"
    - scenario: "User interrupts automated stage before reaching interactive stage"
      expected_behavior: "No notification sent; workflow terminates gracefully at interruption point"
    - scenario: "analyze command run when prerequisites (plan.yaml, tasks.yaml) are missing"
      expected_behavior: "Preflight check fails with clear error message before any mode logic executes"
    - scenario: "clarify command modifies spec.yaml during interactive session"
      expected_behavior: "Changes are saved correctly; validation still runs after session ends"
    - scenario: "User has notifications disabled in config"
      expected_behavior: "No interactive session notification sent; interactive mode still works"
assumptions:
    - "The -p flag in Claude Code triggers non-interactive/headless mode; removing it enables interactive conversation"
    - "Stream-json output format is only useful for automated processing; interactive mode uses default output"
    - "The existing notification system (sound/visual) can support new hook types without architecture changes"
    - "Retry logic is not applicable to interactive stages since validation happens during conversation"
    - "Users understand that interactive stages require their attention and automated stages can run unattended"
constraints:
    - "Must not break existing automated workflows that depend on -p flag behavior"
    - "Notification hook must follow existing asynchronous dispatch pattern with 5-second timeout"
    - "Interactive mode must work with existing Claude Code CLI without version requirements"
    - "Configuration changes must be backwards compatible (existing configs work without modification)"
out_of_scope:
    - "GUI or web-based notification mechanisms (stick to existing sound/visual notifications)"
    - "User-configurable per-command mode overrides (e.g., --force-automated flag for clarify)"
    - "Changes to the Claude Code CLI itself (work within current CLI capabilities)"
    - "Multi-user or collaborative session support"
    - "Timeout handling for interactive sessions (user controls when session ends)"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec v0.6.1"
    created: "2025-12-22T00:42:23Z"
    artifact_type: "spec"
