# Implementation Plan for Interactive Mode Defaults
# Feature: 074-interactive-mode-defaults
# Generated: 2025-12-22

design:
  overview: |
    This plan introduces stage-aware execution modes to autospec, enabling non-modifying
    stages (analyze, clarify) to run in interactive Claude mode while preserving automated
    mode for file-modifying stages (specify, plan, tasks, implement, constitution, checklist).

    The key insight is that the current architecture already supports this through the
    cliagent.ExecOptions structure - we just need to make the agent invocation path
    stage-aware so that DefaultArgs (which include -p and --output-format stream-json)
    can be conditionally applied.

  architecture_decisions:
    - decision: "Add IsInteractive field to Stage enum or create StageMode lookup"
      rationale: |
        Centralizing stage mode configuration enables easy extension for future stages
        and ensures consistent behavior across all execution paths (CLI commands, run command).
      alternatives_considered:
        - "Hardcode in each stage handler - rejected due to duplication"
        - "Config file option per stage - rejected as too complex for initial implementation"

    - decision: "Modify PromptDelivery pattern to support optional flags"
      rationale: |
        The current BaseAgent.buildArgs() unconditionally appends DefaultArgs. For interactive
        mode, we need to skip the -p flag (PromptDelivery.Flag) and --output-format stream-json.
        This requires extending ExecOptions with an Interactive flag that bypasses prompt delivery.
      alternatives_considered:
        - "Create separate InteractiveAgent type - rejected as too much duplication"
        - "Remove DefaultArgs entirely - rejected as it breaks automated stages"

    - decision: "Add OnInteractiveSessionStart hook to notification system"
      rationale: |
        Users running multi-stage workflows with automated stages before interactive stages
        need to be notified when the interactive session begins so they can return to the terminal.
        Follows existing notification pattern with async dispatch and 5-second timeout.

    - decision: "Track 'hadAutomatedStages' state in run command context"
      rationale: |
        The interactive session notification should only fire when automated stages preceded
        the interactive stage. This requires tracking state as stages execute in the run command.

  components:
    - name: "StageMode Configuration"
      description: "Centralized stage mode lookup"
      location: "internal/workflow/stage_mode.go (new file)"
      responsibilities:
        - "Define StageMode enum (Interactive, Automated)"
        - "Provide IsInteractive(stage Stage) function"
        - "Document which stages use which mode"

    - name: "Agent Interactive Mode Support"
      description: "ExecOptions extension for interactive execution"
      location: "internal/cliagent/options.go"
      responsibilities:
        - "Add Interactive bool field to ExecOptions"
        - "Document behavior when Interactive is true"

    - name: "BaseAgent Interactive Handling"
      description: "Skip headless flags when Interactive mode requested"
      location: "internal/cliagent/base.go"
      responsibilities:
        - "Modify buildArgs to check opts.Interactive"
        - "Skip PromptDelivery flag (-p) when Interactive is true"
        - "Skip DefaultArgs when Interactive is true"
        - "Preserve WorkDir, Env, ExtraArgs, Timeout, UseSubscription"

    - name: "Executor Stage-Aware Mode"
      description: "Pass Interactive flag based on stage"
      location: "internal/workflow/executor.go, internal/workflow/stage_executor.go"
      responsibilities:
        - "StageExecutor methods call IsInteractive() to determine mode"
        - "Pass mode through executor chain to ClaudeExecutor"

    - name: "ClaudeExecutor Interactive Support"
      description: "Propagate Interactive flag to Agent"
      location: "internal/workflow/claude.go"
      responsibilities:
        - "Add method to execute with interactive flag"
        - "Ensure output formatting is skipped in interactive mode"

    - name: "Interactive Session Notification"
      description: "Notify when interactive session starts"
      location: "internal/notify/handler.go"
      responsibilities:
        - "Add OnInteractiveSessionStart method"
        - "Send notification with info about interactive mode"

    - name: "Run Command Interactive Integration"
      description: "Handle mode transitions in multi-stage workflows"
      location: "internal/cli/run.go"
      responsibilities:
        - "Track whether automated stages have run"
        - "Notify before interactive stage starts (if automated stages preceded)"
        - "Pass stage mode to orchestrator"

  data_flow: |
    1. CLI Command (clarify/analyze/run)
       ↓
    2. StageExecutor.ExecuteClarify/ExecuteAnalyze
       ↓
    3. IsInteractive(stage) → true for clarify/analyze
       ↓
    4. Executor.ExecuteStage with Interactive=true in ExecOptions
       ↓
    5. ClaudeExecutor.executeWithAgent with opts.Interactive=true
       ↓
    6. Agent.Execute with Interactive=true
       ↓
    7. BaseAgent.buildArgs skips -p and DefaultArgs
       ↓
    8. Claude launches in interactive mode (no -p flag)

  file_changes:
    new_files:
      - path: "internal/workflow/stage_mode.go"
        purpose: "Centralized stage mode configuration"
        estimated_lines: 40

    modified_files:
      - path: "internal/cliagent/options.go"
        changes: "Add Interactive field to ExecOptions"
        estimated_lines_changed: 10

      - path: "internal/cliagent/base.go"
        changes: "Modify buildArgs to skip -p and DefaultArgs when Interactive=true"
        estimated_lines_changed: 20

      - path: "internal/workflow/stage_executor.go"
        changes: "Use IsInteractive() and pass mode to executor"
        estimated_lines_changed: 30

      - path: "internal/workflow/executor.go"
        changes: "Add mode parameter to ExecuteStage"
        estimated_lines_changed: 20

      - path: "internal/workflow/claude.go"
        changes: "Propagate Interactive flag to agent, skip formatting"
        estimated_lines_changed: 15

      - path: "internal/workflow/interfaces.go"
        changes: "Update ClaudeRunner interface if needed"
        estimated_lines_changed: 5

      - path: "internal/notify/handler.go"
        changes: "Add OnInteractiveSessionStart method"
        estimated_lines_changed: 25

      - path: "internal/notify/notify.go"
        changes: "Add OnInteractiveSession hook to config"
        estimated_lines_changed: 5

      - path: "internal/cli/run.go"
        changes: "Track automated stage execution, call notification"
        estimated_lines_changed: 25

      - path: "internal/cli/stages/clarify.go"
        changes: "Ensure interactive mode is used (may be automatic)"
        estimated_lines_changed: 5

      - path: "internal/cli/stages/analyze.go"
        changes: "Ensure interactive mode is used (may be automatic)"
        estimated_lines_changed: 5

phases:
  - phase: 1
    name: "Core Stage Mode Infrastructure"
    description: |
      Establish the foundation for stage-specific execution modes by creating the
      StageMode configuration and extending ExecOptions with Interactive flag.
    tasks:
      - id: "T1.1"
        description: "Create internal/workflow/stage_mode.go with IsInteractive function"
        acceptance_criteria:
          - "StageMode type defined with Interactive and Automated values"
          - "IsInteractive(stage Stage) returns true for analyze/clarify, false otherwise"
          - "Clear documentation for each stage's mode"
        dependencies: []

      - id: "T1.2"
        description: "Add Interactive field to ExecOptions in internal/cliagent/options.go"
        acceptance_criteria:
          - "Interactive bool field added with documentation"
          - "Behavior documented in struct comment"
        dependencies: []

      - id: "T1.3"
        description: "Modify BaseAgent.buildArgs to respect Interactive flag"
        acceptance_criteria:
          - "When Interactive=true, -p flag is NOT added"
          - "When Interactive=true, DefaultArgs are NOT appended"
          - "Other options (WorkDir, Env, ExtraArgs, Timeout) still work"
          - "When Interactive=false, behavior is unchanged"
        dependencies:
          - "T1.2"

      - id: "T1.4"
        description: "Add unit tests for interactive mode in cliagent"
        acceptance_criteria:
          - "Test buildArgs with Interactive=true skips -p and DefaultArgs"
          - "Test buildArgs with Interactive=false includes all flags"
          - "Map-based table tests with t.Parallel()"
        dependencies:
          - "T1.3"

  - phase: 2
    name: "Executor Chain Integration"
    description: |
      Thread the interactive mode flag through the executor chain from StageExecutor
      to ClaudeExecutor to BaseAgent.
    tasks:
      - id: "T2.1"
        description: "Add Interactive field to workflow execution context"
        acceptance_criteria:
          - "stageExecutionContext includes Interactive flag"
          - "Flag is set based on IsInteractive(stage) for each stage"
        dependencies:
          - "T1.1"

      - id: "T2.2"
        description: "Modify ExecuteStage to accept and propagate Interactive mode"
        acceptance_criteria:
          - "ExecuteStage signature updated or mode passed via context"
          - "Interactive flag reaches ClaudeExecutor.Execute"
        dependencies:
          - "T2.1"

      - id: "T2.3"
        description: "Update ClaudeExecutor to pass Interactive to agent"
        acceptance_criteria:
          - "executeWithAgent sets opts.Interactive correctly"
          - "Output formatting skipped when Interactive=true"
        dependencies:
          - "T2.2"

      - id: "T2.4"
        description: "Update StageExecutor.ExecuteAnalyze and ExecuteClarify"
        acceptance_criteria:
          - "Both methods pass Interactive=true to executor"
          - "Existing behavior unchanged for other stages"
        dependencies:
          - "T2.2"

      - id: "T2.5"
        description: "Add integration tests for interactive stage execution"
        acceptance_criteria:
          - "Test verifies analyze stage uses interactive mode"
          - "Test verifies clarify stage uses interactive mode"
          - "Test verifies plan stage still uses automated mode"
        dependencies:
          - "T2.4"

  - phase: 3
    name: "Run Command Integration"
    description: |
      Integrate interactive mode handling into the run command, including notification
      for interactive session transitions.
    tasks:
      - id: "T3.1"
        description: "Add hadAutomatedStage tracking to stageExecutionContext in run.go"
        acceptance_criteria:
          - "Boolean flag tracks if any automated stage has executed"
          - "Flag is set true after specify/plan/tasks/implement/constitution/checklist"
        dependencies: []

      - id: "T3.2"
        description: "Add OnInteractiveSessionStart to notification handler"
        acceptance_criteria:
          - "Method exists on notify.Handler"
          - "Sends notification with interactive session message"
          - "Follows async dispatch pattern with 5-second timeout"
        dependencies: []

      - id: "T3.3"
        description: "Add on_interactive_session hook to NotificationConfig"
        acceptance_criteria:
          - "Field exists in NotificationConfig struct"
          - "Default value is true when notifications enabled"
          - "Documented in config"
        dependencies:
          - "T3.2"

      - id: "T3.4"
        description: "Call OnInteractiveSessionStart before interactive stages in run"
        acceptance_criteria:
          - "Notification sent only if hadAutomatedStage is true"
          - "Notification sent before executeClarify/executeAnalyze"
          - "No notification if only running interactive stages"
        dependencies:
          - "T3.1"
          - "T3.3"

      - id: "T3.5"
        description: "Add tests for run command interactive mode handling"
        acceptance_criteria:
          - "Test notification sent when automated→interactive transition"
          - "Test no notification when only interactive stages"
          - "Test stages execute in correct mode"
        dependencies:
          - "T3.4"

  - phase: 4
    name: "CLI Command Updates and Validation"
    description: |
      Ensure individual CLI commands for clarify and analyze work correctly
      with interactive mode, and run full validation.
    tasks:
      - id: "T4.1"
        description: "Verify clarify CLI command uses interactive mode"
        acceptance_criteria:
          - "autospec clarify launches Claude without -p flag"
          - "User can have multi-turn conversation"
          - "Validation still runs after session ends"
        dependencies:
          - "T2.4"

      - id: "T4.2"
        description: "Verify analyze CLI command uses interactive mode"
        acceptance_criteria:
          - "autospec analyze launches Claude without -p flag"
          - "User can have multi-turn conversation"
          - "No file changes expected (pure analysis)"
        dependencies:
          - "T2.4"

      - id: "T4.3"
        description: "Run make fmt, make lint, make test, make build"
        acceptance_criteria:
          - "All quality gates pass with exit code 0"
          - "No test failures"
          - "No lint errors"
          - "Binary builds successfully"
        dependencies:
          - "T4.1"
          - "T4.2"
          - "T3.5"

      - id: "T4.4"
        description: "Manual testing of all scenarios"
        acceptance_criteria:
          - "autospec clarify → interactive mode"
          - "autospec analyze → interactive mode"
          - "autospec run --specify --clarify → notification before clarify"
          - "autospec run --clarify → no notification (no preceding automated)"
          - "autospec specify → automated mode (unchanged)"
        dependencies:
          - "T4.3"

risks:
  - id: "R1"
    description: "Interactive mode may not work correctly with retry logic"
    likelihood: "medium"
    impact: "medium"
    mitigation: |
      Interactive stages should not use retry logic since validation happens during
      the conversation. Ensure ExecuteStage detects interactive mode and skips retry
      logic, or clarify/analyze return immediately after Claude session ends.

  - id: "R2"
    description: "Output formatting may interfere with interactive mode"
    likelihood: "low"
    impact: "low"
    mitigation: |
      The getFormattedStdout function already checks for hasHeadlessFlag before
      applying formatting. Since interactive mode won't have -p flag, formatting
      should be automatically skipped.

  - id: "R3"
    description: "Breaking changes to ClaudeRunner interface"
    likelihood: "low"
    impact: "medium"
    mitigation: |
      If interface changes are needed, use optional pattern (add method with default
      behavior) or extend with a new interface that ClaudeExecutor implements.

  - id: "R4"
    description: "Notification timing may not be visible before Claude starts"
    likelihood: "medium"
    impact: "low"
    mitigation: |
      Send notification synchronously (blocking) or add small delay before launching
      interactive session to ensure notification is delivered first.

dependencies:
  external:
    - name: "Claude Code CLI"
      version: "Any version supporting interactive mode (without -p flag)"
      required_for: "Interactive session execution"

  internal:
    - name: "cliagent package"
      required_for: "Agent execution abstraction"
    - name: "notify package"
      required_for: "Notification hooks"
    - name: "workflow package"
      required_for: "Stage execution"

testing_strategy:
  unit_tests:
    - "TestIsInteractive - stage mode lookup"
    - "TestBuildArgsInteractive - agent args in interactive mode"
    - "TestBuildArgsAutomated - agent args in automated mode"
    - "TestExecuteStageInteractive - stage execution with interactive mode"
    - "TestOnInteractiveSessionStart - notification dispatch"

  integration_tests:
    - "TestClarifyInteractiveMode - end-to-end clarify"
    - "TestAnalyzeInteractiveMode - end-to-end analyze"
    - "TestRunCommandModeTransition - automated→interactive transition"

  manual_tests:
    - "Run autospec clarify and verify interactive Claude session"
    - "Run autospec analyze and verify interactive Claude session"
    - "Run autospec run --specify --clarify and verify notification appears"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.6.1"
  created: "2025-12-22T00:50:00Z"
  artifact_type: "plan"
