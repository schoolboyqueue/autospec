_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "dev"
  created: "2025-12-13T14:00:00Z"
  artifact_type: "plan"

plan:
  branch: "008-flexible-phase-workflow"
  created: "2025-12-13"
  spec_path: "specs/008-flexible-phase-workflow/spec.yaml"

summary: |
  This implementation adds flexible phase workflow capabilities to the autospec CLI,
  allowing users to run any combination of phases (specify, plan, tasks, implement)
  via individual flags (-s/-p/-t/-i) or run all phases with a single flag (-a).
  The key architectural change is adding persistent flags to the root command and
  creating a new `run` subcommand that acts as the phase executor, with the existing
  `full` command being renamed to `all`.

  The design prioritizes backward compatibility while enabling power-user workflows.
  Safety warnings with confirmation prompts protect users from missing prerequisites,
  while the -y/--yes flag and AUTOSPEC_YES environment variable enable non-interactive
  automation. Spec detection remains automatic via git branch but can be overridden
  with --spec.

technical_context:
  language: "Go"
  framework: "Cobra CLI (v1.10.1)"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.10.1"
      purpose: "CLI framework with flag parsing and command hierarchy"
    - name: "github.com/knadh/koanf"
      version: "v2.3.0"
      purpose: "Hierarchical configuration management"
    - name: "github.com/go-playground/validator"
      version: "v10.28.0"
      purpose: "Configuration validation"
    - name: "golang.org/x/term"
      version: "v0.25.0+"
      purpose: "Terminal detection for interactive prompts"
  storage: "File system (config in ~/.autospec/, state in ~/.autospec/state/)"
  testing:
    framework: "Go testing + table-driven tests"
    approach: "Unit tests for new components, integration tests for CLI behavior"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: |
    - Prerequisite checking and warning display: <1 second
    - Validation functions: <10ms
    - Overall phase execution: bounded by Claude CLI response time
  constraints:
    - "Must maintain backward compatibility with existing subcommands"
    - "Phase execution order is fixed: specify -> plan -> tasks -> implement"
    - "Cannot break existing workflows or CI/CD integrations"
  scale_scope: "Single-user CLI tool, local filesystem operations"

constitution_check:
  constitution_path: ".specify/memory/constitution.md"
  gates:
    - name: "Validation-First"
      status: "PASS"
      notes: "Prerequisite checking validates artifacts before phase execution"
    - name: "Test-First Development"
      status: "PASS"
      notes: "Tests will be written before implementation per NON-NEGOTIABLE policy"
    - name: "Performance Standards"
      status: "PASS"
      notes: "Prerequisite checking designed for <1s; validation functions <10ms"
    - name: "Idempotency & Retry Logic"
      status: "PASS"
      notes: "Existing retry infrastructure will be used for phase execution"

research_findings:
  decisions:
    - topic: "Flag combinability (-spi vs -s -p -i)"
      decision: "Support both combined and separate flags"
      rationale: |
        Cobra's Flags() system supports shorthand combinations automatically when
        using BoolP. Users familiar with tar/git will expect -spi to work like -s -p -i.
      alternatives_considered:
        - "Only support separate flags"
        - "Use positional arguments for phase selection"

    - topic: "Command structure for phase selection"
      decision: "Add phase flags to root command's run subcommand"
      rationale: |
        Creating a new `run` subcommand keeps the existing subcommands (specify, plan,
        tasks, implement, full, workflow) functional while adding the flexible interface.
        The root command shows help when no subcommand is given.
      alternatives_considered:
        - "Add flags directly to root command"
        - "Replace all existing subcommands"

    - topic: "Confirmation prompt implementation"
      decision: "Use golang.org/x/term for terminal detection, fmt.Scanf for input"
      rationale: |
        The existing codebase uses golang.org/x/term for terminal detection in
        progress.go. fmt.Scanf is sufficient for simple y/N input without external
        dependencies.
      alternatives_considered:
        - "Use bufio.NewReader for input"
        - "Use promptui library"

    - topic: "Skip confirmation configuration hierarchy"
      decision: "Flag (-y) > Environment (AUTOSPEC_YES) > Config (skip_confirmations)"
      rationale: |
        Follows existing configuration precedence pattern. Flag provides immediate
        override, env var enables script automation, config sets persistent default.
      alternatives_considered:
        - "Only support flag-based skip"
        - "Only support environment variable"

    - topic: "Rename 'full' to 'all'"
      decision: "Create 'all' as alias to 'full', mark 'full' as deprecated"
      rationale: |
        Maintains backward compatibility while encouraging new naming. Deprecation
        warning guides users to new command without breaking existing scripts.
      alternatives_considered:
        - "Hard rename with immediate removal"
        - "Keep both names without deprecation"

data_model:
  entities:
    - name: "PhaseConfig"
      description: "Configuration for which phases to execute in a workflow run"
      fields:
        - name: "Specify"
          type: "bool"
          description: "Include specify phase"
          constraints: "Default false"
        - name: "Plan"
          type: "bool"
          description: "Include plan phase"
          constraints: "Default false"
        - name: "Tasks"
          type: "bool"
          description: "Include tasks phase"
          constraints: "Default false"
        - name: "Implement"
          type: "bool"
          description: "Include implement phase"
          constraints: "Default false"
      relationships:
        - target: "PreflightResult"
          type: "one-to-one"
          description: "PhaseConfig determines what prerequisites to check"

    - name: "PreflightResult"
      description: "Results from prerequisite checking before phase execution"
      fields:
        - name: "DetectedSpec"
          type: "string"
          description: "Auto-detected or user-specified spec name"
          constraints: "Required unless specify phase included"
        - name: "MissingArtifacts"
          type: "[]string"
          description: "List of missing prerequisite files"
          constraints: "Empty array if all present"
        - name: "Warnings"
          type: "[]string"
          description: "Warning messages for user"
          constraints: "Empty array if no warnings"
        - name: "RequiresConfirmation"
          type: "bool"
          description: "Whether user confirmation is needed"
          constraints: "True if MissingArtifacts not empty"
        - name: "CanProceed"
          type: "bool"
          description: "Whether execution can proceed"
          constraints: "False if critical errors"
      relationships: []

    - name: "ArtifactDependency"
      description: "Mapping of phases to their required and produced artifacts"
      fields:
        - name: "Phase"
          type: "Phase"
          description: "The workflow phase"
          constraints: "One of: specify, plan, tasks, implement"
        - name: "Requires"
          type: "[]string"
          description: "Artifacts required before this phase can run"
          constraints: "File paths relative to spec directory"
        - name: "Produces"
          type: "[]string"
          description: "Artifacts created by this phase"
          constraints: "File paths relative to spec directory"
      relationships:
        - target: "Phase"
          type: "one-to-one"
          description: "Each phase has one dependency definition"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "README.md"
      description: "Update CLI usage documentation with new flags"
    - path: "CLAUDE.md"
      description: "Update architecture documentation for new commands"
  source_code:
    - path: "internal/cli/run.go"
      description: "New run subcommand with phase flag handling"
    - path: "internal/cli/root.go"
      description: "Update to show help on no args, add global -y flag"
    - path: "internal/cli/full.go"
      description: "Rename to all.go, add deprecation for full"
    - path: "internal/workflow/preflight.go"
      description: "Extended with artifact dependency checking"
    - path: "internal/workflow/phase_config.go"
      description: "New file for PhaseConfig and dependency logic"
    - path: "internal/config/config.go"
      description: "Add skip_confirmations field"
    - path: "internal/config/defaults.go"
      description: "Add skip_confirmations default"
  tests:
    - path: "internal/cli/run_test.go"
      description: "Tests for new run command flag parsing"
    - path: "internal/workflow/phase_config_test.go"
      description: "Tests for phase configuration and dependencies"
    - path: "internal/workflow/preflight_test.go"
      description: "Extended tests for prerequisite checking"

implementation_phases:
  - phase: 1
    name: "Phase Configuration Infrastructure"
    goal: "Create core data structures for flexible phase selection"
    deliverables:
      - "internal/workflow/phase_config.go with PhaseConfig and ArtifactDependency structs"
      - "Tests for phase ordering and dependency resolution"
      - "Method to determine canonical execution order from flags"

  - phase: 2
    name: "Enhanced Prerequisite Checking"
    goal: "Extend preflight checks to validate artifact dependencies"
    dependencies:
      - "Phase 1"
    deliverables:
      - "PreflightResult struct with warning and confirmation fields"
      - "Artifact existence checking per phase"
      - "Tests for various artifact presence/absence scenarios"

  - phase: 3
    name: "Confirmation Prompt System"
    goal: "Implement user confirmation with skip options"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Confirmation prompt function with y/N handling"
      - "Configuration support for skip_confirmations"
      - "Environment variable AUTOSPEC_YES support"
      - "-y/--yes flag support"
      - "Tests for interactive and non-interactive modes"

  - phase: 4
    name: "Run Command Implementation"
    goal: "Create the new run subcommand with phase flags"
    dependencies:
      - "Phase 3"
    deliverables:
      - "internal/cli/run.go with -s/-p/-t/-i/-a flags"
      - "--spec flag for explicit spec selection"
      - "Integration with WorkflowOrchestrator for phase execution"
      - "Tests for flag parsing and phase selection"

  - phase: 5
    name: "Command Renaming and Compatibility"
    goal: "Rename full to all, maintain backward compatibility"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Rename internal/cli/full.go to all.go"
      - "Add 'all' subcommand as primary name"
      - "Keep 'full' as deprecated alias with warning"
      - "Update help text across all commands"
      - "Tests for both command names"

  - phase: 6
    name: "Documentation and Integration"
    goal: "Complete documentation and final integration testing"
    dependencies:
      - "Phase 5"
    deliverables:
      - "Updated README.md with new CLI usage"
      - "Updated CLAUDE.md architecture documentation"
      - "End-to-end integration tests"
      - "Make build verification"

risks:
  - risk: "Flag conflicts with existing commands"
    likelihood: "low"
    impact: "medium"
    mitigation: "Careful review of existing flag usage; run subcommand isolates new flags"

  - risk: "Breaking existing CI/CD scripts"
    likelihood: "low"
    impact: "high"
    mitigation: "Maintain full backward compatibility; deprecate rather than remove"

  - risk: "Terminal detection issues on Windows"
    likelihood: "medium"
    impact: "low"
    mitigation: "Gracefully degrade to non-interactive mode if terminal detection fails"

  - risk: "Cobra flag combination behavior differs from expectations"
    likelihood: "low"
    impact: "medium"
    mitigation: "Comprehensive flag combination testing"

open_questions:
  - question: "Should the -a flag on run be equivalent to -spti or should it require no other flags?"
    context: "Determines if 'run -a -i' means 'all phases' or 'all plus explicitly implement'"
    proposed_resolution: "Treat -a as alias for -spti; if other flags present, -a has no additional effect"

  - question: "Should spec detection failure with -p/-t/-i be a hard error or soft warning?"
    context: "User running 'run -pi' on main branch with no --spec flag"
    proposed_resolution: "Hard error with actionable message: 'No spec detected. Use --spec or checkout spec branch'"
