feature:
    branch: "030-worktree-management"
    created: "2025-12-16"
    status: "Draft"
    input: "lets create a specification for a way to help manage git worktrees before any specify command or workflow is triggered, this will create a worktree with any (gitignored) files/folders (repo specific issue - maybe ask claude to make a script for this first for every users repo - like project specific worktree creation script that outputs the path of the created repo). This helps users develop and iterate quickly without having to manage worktrees everytime a new spec wants to be developed. this is useful because each specify command triggers a new git branch. if u specify and are working on that branch, then specify a new feature - everything breaks/gets jumbled up / confused due to the user not knowing he/she should have made a new worktree then cd into that worktree first (to prevent conflicts/issues).sometimes its fine to specify in a branch that has another specification as long as other autospec workflows arent running there. better overall to have some autospec worktree command that helps us easily generate a new worktree, then cd into it, then can safely do some spec. BUT all the worktrees will need some consolidated method of figuring out the spec/ prefix numbering for multiple worktrees created. otherwise when we merge them all later down the line there will be specs/016-feature-1 AND specs/016-feature-2 --- we need correct incremental global numbering regardless of all worktrees if possible."

user_stories:
    - id: "US-001"
      title: "Create worktree for new feature development"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "to easily create a new git worktree when starting a new feature"
      so_that: "I can work on multiple features in parallel without branch conflicts"
      why_this_priority: "Core functionality - without this, users cannot isolate feature development"
      independent_test: "Run worktree creation command and verify new worktree is created with correct branch"
      acceptance_scenarios:
        - given: "I am in the main worktree on any branch"
          when: "I run 'autospec worktree new my-feature'"
          then: "A new worktree is created with a unique branch and I see the path to cd into"
        - given: "I am working on feature A in a worktree"
          when: "I want to start feature B"
          then: "I can create a new worktree without affecting feature A's worktree"
        - given: "A worktree is created"
          when: "I cd into the new worktree path"
          then: "I am in a clean working directory ready for autospec workflows"

    - id: "US-002"
      title: "Global spec numbering across all worktrees"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "spec directory numbering to be globally unique across all worktrees"
      so_that: "when I merge multiple features, there are no spec number collisions"
      why_this_priority: "Critical for avoiding merge conflicts - duplicate spec numbers cause major issues"
      independent_test: "Create specs in two different worktrees and verify they get different numbers"
      acceptance_scenarios:
        - given: "worktree A creates spec 030"
          when: "worktree B creates a new spec"
          then: "worktree B gets spec 031, not 030"
        - given: "multiple worktrees exist with active specs"
          when: "I run autospec specify in any worktree"
          then: "the new spec number is globally unique and sequential"
        - given: "specs 030, 031, 032 exist across worktrees"
          when: "I merge all worktrees to main"
          then: "specs directory has no duplicate numbers"

    - id: "US-003"
      title: "Copy gitignored files to new worktree"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "project-specific gitignored files copied to new worktrees"
      so_that: "my local configuration and dependencies are available in the new worktree"
      why_this_priority: "Worktrees without gitignored files are often broken or require manual setup"
      independent_test: "Create worktree with gitignored files and verify they are copied"
      acceptance_scenarios:
        - given: "project has a .worktree-include file listing gitignored paths to copy"
          when: "I create a new worktree"
          then: "those paths are copied from main worktree to new worktree"
        - given: "no .worktree-include file exists"
          when: "I create a new worktree"
          then: "autospec prompts to create one or proceeds with default behavior"
        - given: ".worktree-include lists 'node_modules' and '.env.local'"
          when: "I create a new worktree"
          then: "both directories/files are copied to the new worktree"

    - id: "US-004"
      title: "List and manage existing worktrees"
      priority: "P2"
      as_a: "developer using autospec"
      i_want: "to see all my active worktrees and their spec status"
      so_that: "I can track what I'm working on and clean up completed worktrees"
      why_this_priority: "Important for organization but not blocking core workflow"
      independent_test: "Create multiple worktrees and verify list command shows them all"
      acceptance_scenarios:
        - given: "I have 3 active worktrees"
          when: "I run 'autospec worktree list'"
          then: "I see all 3 worktrees with their paths, branches, and spec status"
        - given: "I have completed work in a worktree and merged"
          when: "I run 'autospec worktree remove <path>'"
          then: "the worktree is removed and cleaned up"

    - id: "US-005"
      title: "Generate project-specific worktree setup script"
      priority: "P2"
      as_a: "developer using autospec"
      i_want: "autospec to help me create a project-specific worktree setup script"
      so_that: "I can customize what gets copied or run when creating worktrees"
      why_this_priority: "Useful for complex projects but not required for basic workflow"
      independent_test: "Run script generation and verify it produces valid executable script"
      acceptance_scenarios:
        - given: "I run 'autospec worktree init'"
          when: "I provide answers to setup prompts"
          then: "a .autospec/worktree-setup.sh script is created"
        - given: "a worktree-setup.sh script exists"
          when: "I create a new worktree"
          then: "the script is executed in the new worktree after creation"

    - id: "US-006"
      title: "Warn when specifying in active worktree branch"
      priority: "P2"
      as_a: "developer using autospec"
      i_want: "to be warned if I run specify while already on a spec branch"
      so_that: "I don't accidentally create conflicts or confusion"
      why_this_priority: "Prevents common mistake but user can override if intentional"
      independent_test: "Run specify on existing spec branch and verify warning is shown"
      acceptance_scenarios:
        - given: "I am on branch 029-some-feature with active spec work"
          when: "I run 'autospec specify' for a new feature"
          then: "I see a warning suggesting I create a worktree instead"
        - given: "I see the worktree suggestion warning"
          when: "I confirm I want to proceed anyway"
          then: "specify continues normally (user override)"

requirements:
    functional:
        - id: "FR-001"
          description: "MUST provide 'autospec worktree new <name>' command to create new worktrees"
          testable: true
          acceptance_criteria: "Command creates git worktree with unique branch and outputs path"
        - id: "FR-002"
          description: "MUST implement global spec numbering lock file in main worktree"
          testable: true
          acceptance_criteria: "Lock file prevents concurrent spec number allocation; all worktrees get unique numbers"
        - id: "FR-003"
          description: "MUST read .worktree-include file to determine which gitignored paths to copy"
          testable: true
          acceptance_criteria: "Paths listed in file are copied; missing file results in warning or prompt"
        - id: "FR-004"
          description: "MUST provide 'autospec worktree list' command showing all worktrees with status"
          testable: true
          acceptance_criteria: "Output shows path, branch, and current spec for each worktree"
        - id: "FR-005"
          description: "MUST provide 'autospec worktree remove <path>' to clean up worktrees"
          testable: true
          acceptance_criteria: "Worktree is removed via git worktree remove; prompts if uncommitted changes"
        - id: "FR-006"
          description: "SHOULD warn users when running specify on an existing spec branch"
          testable: true
          acceptance_criteria: "Warning displayed with suggestion to use worktree; can be bypassed"
        - id: "FR-007"
          description: "SHOULD provide 'autospec worktree init' to create project-specific setup script"
          testable: true
          acceptance_criteria: "Interactive prompts create .autospec/worktree-setup.sh"
        - id: "FR-008"
          description: "MUST execute worktree-setup.sh if present after creating new worktree"
          testable: true
          acceptance_criteria: "Script runs in new worktree directory with appropriate permissions"
        - id: "FR-009"
          description: "MUST store global spec number in main worktree at .autospec/state/spec-counter.lock"
          testable: true
          acceptance_criteria: "File contains current highest spec number; atomic increment operation"
        - id: "FR-010"
          description: "MUST handle concurrent spec creation with file locking"
          testable: true
          acceptance_criteria: "Two simultaneous spec creations in different worktrees get unique numbers"
        - id: "FR-011"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "performance"
          description: "Worktree creation must complete within 30 seconds for typical projects"
          measurable_target: "End-to-end worktree creation under 30 seconds excluding file copy time"
        - id: "NFR-002"
          category: "usability"
          description: "Output the new worktree path in a format easy to cd into"
          measurable_target: "Path output on its own line, copyable, with cd suggestion"
        - id: "NFR-003"
          category: "reliability"
          description: "Spec number allocation must never produce duplicates"
          measurable_target: "Zero duplicate spec numbers even under concurrent creation"
        - id: "NFR-004"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-005"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-006"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern with t.Parallel()"
          measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
        - id: "NFR-007"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"

success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Developers can create isolated worktrees for parallel feature development"
          metric: "Time to create new worktree and start specifying"
          target: "Under 60 seconds from command to ready-to-use worktree"
        - id: "SC-002"
          description: "No spec number collisions when merging features from multiple worktrees"
          metric: "Duplicate spec numbers after merging N worktrees"
          target: "Zero duplicates regardless of number of worktrees"
        - id: "SC-003"
          description: "Gitignored project files are available in new worktrees"
          metric: "Percentage of listed .worktree-include paths successfully copied"
          target: "100% of specified paths copied or error reported"
        - id: "SC-004"
          description: "Users can track and manage their active worktrees"
          metric: "All worktrees visible in list command"
          target: "100% of autospec-created worktrees shown in list"

key_entities:
    - name: "Worktree"
      description: "A git worktree instance representing an isolated working directory for feature development"
      attributes:
        - "path: filesystem path to worktree directory"
        - "branch: git branch checked out in this worktree"
        - "specNumber: the spec number reserved for this worktree (if any)"
        - "isMain: whether this is the main worktree"
    - name: "SpecCounter"
      description: "Global counter for spec numbers, shared across all worktrees"
      attributes:
        - "value: current highest allocated spec number"
        - "lockPath: path to lock file in main worktree"
        - "lastUpdated: timestamp of last allocation"
    - name: "WorktreeConfig"
      description: "Configuration for worktree creation behavior"
      attributes:
        - "includePaths: list of gitignored paths to copy"
        - "setupScript: path to post-creation script"
        - "defaultBranch: base branch for new worktrees (main/master)"

edge_cases:
    - scenario: "User creates worktree while main worktree has uncommitted changes"
      expected_behavior: "Worktree creation proceeds; uncommitted changes remain in main worktree"
    - scenario: "Two users create worktrees simultaneously on different machines"
      expected_behavior: "Lock file with retry mechanism ensures unique spec numbers"
    - scenario: "Main worktree is deleted or moved"
      expected_behavior: "Error with instructions to re-establish main worktree or update paths"
    - scenario: ".worktree-include references non-existent path"
      expected_behavior: "Warning for missing path, continue with other paths"
    - scenario: "Worktree creation fails mid-way (e.g., disk full)"
      expected_behavior: "Clean up partial worktree; release any reserved spec number"
    - scenario: "User tries to create worktree from within another worktree"
      expected_behavior: "Detect main worktree and use its spec counter; create worktree from main"
    - scenario: "Git worktree command not available (old git version)"
      expected_behavior: "Fail fast with clear error about git version requirements"

assumptions:
    - "Git version 2.5+ is available (worktree support)"
    - "Main worktree is always accessible for spec number coordination"
    - "File locking is available on the filesystem"
    - "Users have write access to the parent directory for worktree creation"
    - "Gitignored files that need copying are not too large (reasonable copy time)"

constraints:
    - "Must work with standard git worktree semantics"
    - "Spec counter must be atomic and survive process crashes"
    - "Cannot require network access for spec number allocation"
    - "Must work on Linux, macOS, and Windows"
    - "Lock file mechanism must handle stale locks (process died holding lock)"

out_of_scope:
    - "Automatic worktree creation on specify (user must explicitly create)"
    - "Worktree syncing or rebase automation"
    - "Remote worktree management (all local)"
    - "Integration with specific IDEs or editors"
    - "Automatic cleanup of merged/completed worktrees"
    - "Worktree templates or scaffolding beyond file copying"

_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-16T23:43:02Z"
    artifact_type: "spec"
