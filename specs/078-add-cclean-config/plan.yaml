plan:
  branch: "078-add-cclean-config"
  created: "2026-01-02"
  spec_path: "specs/078-add-cclean-config/spec.yaml"

summary: |
  Add internal configuration options for cclean (claude-clean) formatting within autospec.
  This enables users to configure verbose mode (-V), line numbers (-n), and output style (-s)
  through the existing hierarchical configuration system (env vars > project config > user config > defaults).
  
  The implementation extends the existing config infrastructure by adding a new `cclean` section
  with three fields: verbose, line_numbers, and style. The StreamFormatter in internal/workflow/formatter.go
  will be updated to read these settings from Configuration and apply them when formatting output.
  This aligns with the existing output_style config pattern but adds cclean-specific options.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/ariel-frischer/claude-clean"
      version: "latest"
      purpose: "Formatting Claude's stream-json output"
    - name: "github.com/knadh/koanf/v2"
      version: "v2.x"
      purpose: "Hierarchical configuration management"
  storage: "YAML configuration files"
  testing:
    framework: "go test"
    approach: "Map-based table-driven tests with t.Parallel()"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "Config loading <100ms"
  constraints:
    - "Must not interfere with existing command-line interface"
    - "Must be backward compatible with current cclean behavior"
    - "Must follow koanf configuration patterns established in config package"
    - "Functions must be <40 lines per PRIN-011"
  scale_scope: "Single-user CLI tool"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "Tests will be written before implementation for all new config fields and formatter changes"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "Not applicable - this is a configuration feature, not a workflow phase"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Config loading already has <100ms contract; adding 3 fields has negligible impact"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "N/A"
      notes: "Not applicable - configuration reading is inherently idempotent"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Invalid config values will warn and fall back to defaults per spec edge cases"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "Configuration uses YAML format with XDG-compliant paths"
    - name: "Code Formatting (PRIN-007)"
      status: "PASS"
      notes: "All code will pass go fmt and go vet"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Functions <40 lines, errors wrapped with context, table-driven tests"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "Not applicable - this feature does not modify command templates"

research_findings:
  decisions:
    - topic: "Configuration structure for cclean options"
      decision: "Create nested cclean section in Configuration struct"
      rationale: "Follows existing patterns like notifications and worktree configs; groups related options logically"
      alternatives_considered:
        - "Flat fields like cclean_verbose, cclean_line_numbers"
        - "Reuse output_style field only (doesn't cover verbose/line_numbers)"
    - topic: "Where to apply cclean configuration"
      decision: "Apply in StreamFormatter.mapStyleToConfig()"
      rationale: "StreamFormatter already maps output_style to display.Config; extending this is minimal change"
      alternatives_considered:
        - "Create new formatter type for cclean-specific options"
        - "Apply at agent execution level"
    - topic: "Default values for cclean options"
      decision: "verbose=false, line_numbers=false, style=default"
      rationale: "Matches current behavior (no breaking change); users opt-in to new features"
      alternatives_considered:
        - "Enable verbose by default for debugging"

data_model:
  entities:
    - name: "CcleanConfig"
      description: "Configuration options for cclean output formatting"
      fields:
        - name: "Verbose"
          type: "bool"
          description: "Enable verbose output with usage stats and tool IDs"
          constraints: "Default: false"
        - name: "LineNumbers"
          type: "bool"
          description: "Show line numbers in formatted output"
          constraints: "Default: false"
        - name: "Style"
          type: "string"
          description: "Output formatting style"
          constraints: "Allowed values: default, compact, minimal, plain"
      relationships:
        - target: "Configuration"
          type: "embedded"
          description: "CcleanConfig is embedded in main Configuration struct"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/internal/cclean.md"
      description: "Update with new configuration options and examples"
  source_code:
    - path: "internal/config/config.go"
      description: "Add CcleanConfig field to Configuration struct"
    - path: "internal/config/schema.go"
      description: "Add cclean.* keys to KnownKeys registry"
    - path: "internal/config/defaults.go"
      description: "Add default values for cclean config section"
    - path: "internal/config/cclean.go"
      description: "New file defining CcleanConfig struct"
    - path: "internal/workflow/formatter.go"
      description: "Update to use CcleanConfig from Configuration"
  tests:
    - path: "internal/config/config_test.go"
      description: "Tests for cclean config loading and validation"
    - path: "internal/workflow/formatter_test.go"
      description: "Tests for cclean config application in StreamFormatter"

implementation_phases:
  - phase: 1
    name: "Define CcleanConfig Type"
    goal: "Create the CcleanConfig struct and integrate into Configuration"
    deliverables:
      - "internal/config/cclean.go with CcleanConfig struct"
      - "CcleanConfig field added to Configuration in config.go"
      - "Unit tests for CcleanConfig struct"
  - phase: 2
    name: "Add Schema and Defaults"
    goal: "Register cclean config keys in schema and provide defaults"
    deliverables:
      - "cclean.verbose, cclean.line_numbers, cclean.style in KnownKeys"
      - "Default values in GetDefaults()"
      - "Environment variable support (AUTOSPEC_CCLEAN_*)"
  - phase: 3
    name: "Apply Config in StreamFormatter"
    goal: "Use CcleanConfig values when creating display.Config"
    deliverables:
      - "mapStyleToConfig uses Configuration.Cclean settings"
      - "Fallback handling for invalid style values"
      - "Integration tests for config application"
  - phase: 4
    name: "Documentation and Validation"
    goal: "Update docs and ensure edge cases are handled"
    deliverables:
      - "Updated docs/internal/cclean.md with config examples"
      - "Updated defaults.go template with cclean section"
      - "Edge case tests for invalid values"

open_questions:
  - question: "Should cclean.style override output_style or be independent?"
    context: "Currently output_style controls formatting; cclean.style could conflict"
    proposed_resolution: "cclean.style takes precedence when set; output_style is fallback for backward compatibility"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec v0.7.3"
  created: "2026-01-02T05:19:54Z"
  artifact_type: "plan"
