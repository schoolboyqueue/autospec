feature:
    branch: "055-extract-executor-concerns"
    created: "2025-12-18"
    status: "Completed"
    completed_at: 2025-12-18T23:03:17Z
    input: |
        # Arch 2: Extract Executor Concerns (HIGH PRIORITY)

        **Location:** `internal/workflow/executor.go` (451 LOC, 18 methods)
        **Impact:** HIGH - Improves testability and separation of concerns
        **Effort:** MEDIUM
        **Dependencies:** None, can be done independently

        ## Problem Statement

        Executor class mixes multiple concerns:
        - Execution (Claude commands)
        - Display (progress, spinner)
        - Notifications (notification handler calls)
        - Retry logic (retry state management)

        This makes unit testing difficult and creates tight coupling.

        ## Current Structure

        ```go
        type Executor struct {
            ClaudeCmd            string
            CustomClaudeCmd      string
            MaxRetries           int
            Timeout              time.Duration
            Debug                bool
            NotificationHandler  *notify.Handler
            ProgressDisplay      *progress.ProgressDisplay
            // ... mixed concerns
        }
        ```

        ## Target Structure

        ```go
        // 1. Executor - pure execution
        type Executor struct {
            claude ClaudeRunner // interface
        }

        // 2. ProgressController - display concerns
        type ProgressController struct {
            display *progress.ProgressDisplay
            spinner *spinner.Spinner
        }

        // 3. NotifyDispatcher - notification routing
        type NotifyDispatcher struct {
            handler NotificationHandler // interface
        }
        ```

        ## Implementation Approach

        1. Define ClaudeRunner interface for command execution
        2. Extract ProgressController for all display logic
        3. Extract NotifyDispatcher for notification handling
        4. Refactor Executor to pure execution via ClaudeRunner
        5. Compose components in workflow layer
        6. Update tests to mock individual concerns

        ## Acceptance Criteria

        - [ ] ClaudeRunner interface defined
        - [ ] ProgressController handles all display/spinner logic
        - [ ] NotifyDispatcher handles notification routing
        - [ ] Executor uses ClaudeRunner interface
        - [ ] Each component independently testable
        - [ ] All existing tests pass

        ## Non-Functional Requirements

        - All functions under 40 lines
        - All errors wrapped with context
        - Interfaces in separate file (interfaces.go)
        - Map-based table tests
user_stories:
    - id: "US-001"
      title: "Independently test Claude execution without display dependencies"
      priority: "P1"
      as_a: "developer"
      i_want: "the Claude execution logic to be isolated behind an interface"
      so_that: "I can write unit tests that mock command execution without progress display or notification side effects"
      why_this_priority: "Core enabler for testability - all other separation depends on this interface"
      independent_test: "Create mock ClaudeRunner, inject into Executor, verify Execute calls forward correctly"
      acceptance_scenarios:
        - given: "a mock ClaudeRunner implementation"
          when: "Executor.ExecuteStage is called"
          then: "the mock receives the correct command and the Executor handles success/failure appropriately"
        - given: "a ClaudeRunner that returns an error"
          when: "Executor.ExecuteStage is called"
          then: "the error is wrapped with context and propagated without progress/notification side effects"
    - id: "US-002"
      title: "Test progress display independently from execution"
      priority: "P1"
      as_a: "developer"
      i_want: "progress display logic extracted into a separate ProgressController"
      so_that: "I can test stage transitions, spinner behavior, and status updates without executing Claude commands"
      why_this_priority: "Progress display has complex state transitions that need isolated testing"
      independent_test: "Create ProgressController, call StartStage/CompleteStage/FailStage, verify display state"
      acceptance_scenarios:
        - given: "a ProgressController with mock display"
          when: "StartStage is called with stage info"
          then: "the underlying display receives correct stage number and status"
        - given: "a stage is in progress"
          when: "CompleteStage is called"
          then: "the display shows completed status and any retry count is reset"
        - given: "a stage is in progress"
          when: "FailStage is called with an error"
          then: "the display shows failed status with the error message"
    - id: "US-003"
      title: "Test notification routing independently from execution"
      priority: "P2"
      as_a: "developer"
      i_want: "notification dispatch logic extracted into a separate NotifyDispatcher"
      so_that: "I can test notification routing without triggering actual notifications or executing commands"
      why_this_priority: "Notifications are optional behavior that should not couple to core execution"
      independent_test: "Create NotifyDispatcher with mock handler, verify correct events dispatched"
      acceptance_scenarios:
        - given: "a NotifyDispatcher with a mock notification handler"
          when: "OnStageComplete is called"
          then: "the handler receives the stage name and success status"
        - given: "a NotifyDispatcher with nil handler"
          when: "OnStageComplete is called"
          then: "no error occurs (nil-safe no-op)"
        - given: "a NotifyDispatcher with mock handler"
          when: "OnError is called"
          then: "the handler receives the stage name and error details"
    - id: "US-004"
      title: "Compose separated components in workflow layer"
      priority: "P1"
      as_a: "developer"
      i_want: "the separated components composed together in the workflow orchestration layer"
      so_that: "the refactoring maintains all existing behavior while enabling independent testing"
      why_this_priority: "Must preserve backwards compatibility - existing workflows must continue working"
      independent_test: "Run existing integration tests, verify all pass without modification"
      acceptance_scenarios:
        - given: "components wired together in WorkflowOrchestrator"
          when: "a full specify -> plan -> tasks workflow executes"
          then: "all stages complete with progress display and notifications as before"
        - given: "components wired together"
          when: "a stage fails and retries"
          then: "retry logic works correctly with progress updates and error notifications"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST define ClaudeRunner interface with Execute(command string) error signature"
          testable: true
          acceptance_criteria: "Interface exists in interfaces.go, ClaudeExecutor implements it"
        - id: "FR-002"
          description: "MUST extract ProgressController struct handling all progress display operations"
          testable: true
          acceptance_criteria: "ProgressController handles StartStage, CompleteStage, FailStage; Executor delegates to it"
        - id: "FR-003"
          description: "MUST extract NotifyDispatcher struct handling all notification routing"
          testable: true
          acceptance_criteria: "NotifyDispatcher handles OnStageComplete, OnError; nil-safe for missing handler"
        - id: "FR-004"
          description: "MUST refactor Executor to accept ClaudeRunner interface via dependency injection"
          testable: true
          acceptance_criteria: "Executor.Claude field is type ClaudeRunner (interface), not *ClaudeExecutor (concrete)"
        - id: "FR-005"
          description: "MUST maintain backwards compatibility with existing CLI commands"
          testable: true
          acceptance_criteria: "All existing CLI commands work unchanged: core stages (specify, plan, tasks, implement, constitution), optional stages (clarify, checklist, analyze), and orchestration (all, run, prep)"
        - id: "FR-006"
          description: "MUST add compile-time interface compliance checks for new interfaces"
          testable: true
          acceptance_criteria: "var _ ClaudeRunner = (*ClaudeExecutor)(nil) in interfaces.go"
        - id: "FR-007"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-002"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern with t.Parallel()"
          measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
        - id: "NFR-004"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
        - id: "NFR-005"
          category: "maintainability"
          description: "Interfaces must be defined in interfaces.go following existing pattern"
          measurable_target: "All new interfaces in interfaces.go with documentation"
        - id: "NFR-006"
          category: "testability"
          description: "Each extracted component must have dedicated test file"
          measurable_target: "progress_controller_test.go, notify_dispatcher_test.go exist with coverage"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Developers can test execution logic without progress display side effects"
          metric: "Unit tests exist that mock ClaudeRunner without real display"
          target: "At least 3 tests using mock ClaudeRunner"
        - id: "SC-002"
          description: "Developers can test progress display without execution side effects"
          metric: "Unit tests exist that test ProgressController in isolation"
          target: "At least 3 tests for ProgressController"
        - id: "SC-003"
          description: "Developers can test notifications without execution side effects"
          metric: "Unit tests exist that test NotifyDispatcher in isolation"
          target: "At least 3 tests for NotifyDispatcher"
        - id: "SC-004"
          description: "All existing functionality continues working after refactoring"
          metric: "Existing test suite pass rate"
          target: "100% of existing tests pass without modification"
        - id: "SC-005"
          description: "Executor struct has reduced complexity"
          metric: "Number of fields in Executor struct"
          target: "Executor has 3 or fewer fields (claude, progress, notify)"
key_entities:
    - name: "ClaudeRunner"
      description: "Interface abstracting Claude command execution for testability"
      attributes:
        - "Execute(command string) error"
        - "FormatCommand(prompt string) string"
    - name: "ProgressController"
      description: "Component managing stage progress display and spinner state"
      attributes:
        - "display *progress.ProgressDisplay"
        - "StartStage(info StageInfo) error"
        - "CompleteStage(info StageInfo) error"
        - "FailStage(info StageInfo, err error)"
    - name: "NotifyDispatcher"
      description: "Component routing notifications to optional handler"
      attributes:
        - "handler NotificationHandler"
        - "OnStageComplete(stage string) error"
        - "OnError(stage string, err error)"
    - name: "Executor"
      description: "Refactored orchestrator composing execution, progress, and notification concerns"
      attributes:
        - "claude ClaudeRunner"
        - "progress *ProgressController"
        - "notify *NotifyDispatcher"
edge_cases:
    - scenario: "NotifyDispatcher initialized with nil handler"
      expected_behavior: "All notification methods become no-ops, no panic"
    - scenario: "ProgressController initialized with nil display"
      expected_behavior: "All progress methods become no-ops, no panic"
    - scenario: "Executor receives ClaudeRunner that always errors"
      expected_behavior: "Error propagated with context, retry logic still functions"
    - scenario: "Progress display error during stage transition"
      expected_behavior: "Warning printed but execution continues (non-fatal)"
    - scenario: "Concurrent stage execution (future consideration)"
      expected_behavior: "ProgressController handles sequential stage updates correctly"
assumptions:
    - "ClaudeExecutor already implements all methods needed for ClaudeRunner interface"
    - "Existing lifecycle.RunStage integration can work with extracted components"
    - "No spinner package is currently used - ProgressDisplay handles all display concerns"
    - "NotificationHandler interface can remain unchanged from current notify.Handler"
    - "retry package remains separate and is composed with Executor, not extracted"
constraints:
    - "Must maintain backwards compatibility with all existing CLI commands"
    - "Cannot change the ClaudeExecutor public API"
    - "Must use existing interfaces.go file for new interface definitions"
    - "All existing tests must pass without modification"
    - "No breaking changes to the public workflow package API"
out_of_scope:
    - "Extracting retry logic into a separate component (separate refactoring task)"
    - "Adding new notification types or channels"
    - "Changing progress display visual appearance"
    - "Adding concurrent/parallel stage execution"
    - "Refactoring ClaudeExecutor internals (shell parsing, template expansion)"
    - "Adding new CLI flags or commands"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-18T22:09:09Z"
    artifact_type: "spec"
