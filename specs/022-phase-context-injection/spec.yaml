feature:
  branch: "022-phase-context-injection"
  created: "2025-12-16"
  status: "Draft"
  input: "Improve phase execution with context injection and better status display. Includes: phase completion stats, pre-phase task summaries, and context file injection to eliminate redundant file reads during phase-isolated implementation."

user_stories:
  - id: "US-001"
    title: "View phase task statistics before execution"
    priority: "P1"
    as_a: "developer running autospec implement --phases"
    i_want: "to see a summary of tasks in each phase before it executes"
    so_that: "I understand what will be worked on and can estimate time"
    why_this_priority: "Essential for user awareness and progress tracking during long-running implementations"
    independent_test: "Run autospec implement --phases and verify task count and IDs are displayed before each phase starts"
    acceptance_scenarios:
      - given: "a spec with 7 phases and tasks.yaml containing tasks grouped by phase"
        when: "running autospec implement --phases"
        then: "before each phase, display shows task count, task IDs, and status breakdown (completed/blocked/pending)"

  - id: "US-002"
    title: "View completion statistics after phase finishes"
    priority: "P1"
    as_a: "developer running autospec implement --phases"
    i_want: "to see detailed completion statistics when a phase completes"
    so_that: "I know exactly how many tasks succeeded and if any were blocked"
    why_this_priority: "Critical feedback for understanding implementation progress and identifying issues"
    independent_test: "Complete a phase and verify completion message shows task counts"
    acceptance_scenarios:
      - given: "a phase with 4 tasks where 3 completed and 1 was blocked"
        when: "the phase execution finishes"
        then: "completion message shows '3/4 tasks completed, 1 blocked'"

  - id: "US-003"
    title: "Faster phase startup with injected context"
    priority: "P2"
    as_a: "developer running autospec implement --phases"
    i_want: "Claude to receive pre-bundled context instead of reading multiple files"
    so_that: "each phase starts faster by eliminating redundant file read operations"
    why_this_priority: "Performance optimization that saves 15-30 seconds per phase, totaling 2-5 minutes for large specs"
    independent_test: "Run phase execution and measure time from phase start to first task work; verify no Read tool calls for spec.yaml/plan.yaml/tasks.yaml appear"
    acceptance_scenarios:
      - given: "a phase execution with --phases flag"
        when: "Claude receives the phase command"
        then: "a single context file contains all spec, plan, and phase-specific tasks; Claude does not call Read tool on spec.yaml, plan.yaml, or tasks.yaml"

  - id: "US-004"
    title: "Focused task context in phase sessions"
    priority: "P2"
    as_a: "developer running autospec implement --phases"
    i_want: "Claude to only see tasks relevant to the current phase"
    so_that: "Claude stays focused and doesn't get confused by unrelated tasks from other phases"
    why_this_priority: "Improves accuracy by reducing cognitive load and potential for cross-phase confusion"
    independent_test: "During phase 3 execution, verify injected context only contains phase 3 tasks, not tasks from phases 1, 2, or 4+"
    acceptance_scenarios:
      - given: "a 7-phase spec where phase 3 has tasks T008-T012"
        when: "executing phase 3"
        then: "Claude receives context containing only T008-T012, not T001-T007 or T013+"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST display pre-phase summary showing task count, task IDs (comma-separated), and status breakdown before phase execution begins"
      testable: true
      acceptance_criteria: "Output format: '[Phase N/M] Title\\n  -> X tasks: T001, T002, ...\\n  -> Status: X completed, Y blocked, Z pending'"

    - id: "FR-002"
      description: "MUST display phase completion message with task statistics when phase finishes"
      testable: true
      acceptance_criteria: "Output format: 'Phase N complete (X/Y tasks completed, Z blocked)'"

    - id: "FR-003"
      description: "MUST provide helper function to retrieve task IDs for a specific phase"
      testable: true
      acceptance_criteria: "GetTasksForPhase(tasksPath, phaseNumber) returns slice of TaskItem structs for only that phase"

    - id: "FR-004"
      description: "MUST create PhaseContext struct to bundle spec, plan, and phase-specific tasks"
      testable: true
      acceptance_criteria: "PhaseContext contains phase number, total phases, full spec content, full plan content, and filtered task list"

    - id: "FR-005"
      description: "MUST implement BuildPhaseContext function to extract and bundle all required context"
      testable: true
      acceptance_criteria: "Function reads spec.yaml, plan.yaml, and extracts only matching phase tasks from tasks.yaml"

    - id: "FR-006"
      description: "MUST implement WriteContextFile function to serialize PhaseContext to temporary YAML file"
      testable: true
      acceptance_criteria: "Function creates temp file with header comment and returns path; file is valid YAML"

    - id: "FR-007"
      description: "MUST pass --context-file argument to Claude when executing phase in isolation mode"
      testable: true
      acceptance_criteria: "Command format: /autospec.implement --phase N --context-file /path/to/context.yaml"

    - id: "FR-008"
      description: "MUST update slash command to parse --context-file and read bundled context instead of individual files"
      testable: true
      acceptance_criteria: "autospec.implement.md instructions specify to read context file when --context-file provided"

    - id: "FR-009"
      description: "MUST clean up temporary context files after phase execution completes"
      testable: true
      acceptance_criteria: "Context file is deleted after phase execution regardless of success or failure"

    - id: "FR-010"
      description: "SHOULD format phase statistics consistently using helper functions"
      testable: true
      acceptance_criteria: "FormatPhaseHeader and FormatPhaseCompletion functions produce consistent output"

  non_functional:
    - id: "NFR-001"
      category: "performance"
      description: "Phase startup time MUST be reduced by eliminating file read operations"
      measurable_target: "50-66% reduction in time from phase command to first task work (from 20-30s to 5-10s)"

    - id: "NFR-002"
      category: "performance"
      description: "Helper functions for phase info MUST execute quickly"
      measurable_target: "GetTasksForPhase, FormatPhaseHeader, FormatPhaseCompletion complete in under 10ms"

    - id: "NFR-003"
      category: "reliability"
      description: "Context file creation MUST handle errors gracefully"
      measurable_target: "Clear error messages returned for file read failures, YAML parsing errors, or temp file creation failures"

    - id: "NFR-004"
      category: "usability"
      description: "Phase status display MUST be human-readable and scannable"
      measurable_target: "Status information visible at a glance without scrolling or parsing"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can see task count and IDs before each phase begins"
      metric: "Pre-phase summary displayed"
      target: "100% of phases show summary before execution"

    - id: "SC-002"
      description: "Users receive detailed completion statistics after each phase"
      metric: "Completion message shows task counts"
      target: "100% of phase completions show completed/blocked counts"

    - id: "SC-003"
      description: "Phase startup is faster due to single context file vs multiple reads"
      metric: "Time from phase start to first task work"
      target: "50% reduction (from ~25s to ~10s average)"

    - id: "SC-004"
      description: "Total implementation time is reduced for multi-phase specs"
      metric: "Cumulative time saved from read elimination"
      target: "2-5 minutes saved for 10-phase spec"

    - id: "SC-005"
      description: "Claude receives only relevant phase tasks, not full tasks.yaml"
      metric: "Tasks in injected context"
      target: "Context contains only current phase tasks"

key_entities:
  - name: "PhaseContext"
    description: "Bundled context for a single phase execution containing all information Claude needs"
    attributes:
      - "phase: int - current phase number"
      - "total_phases: int - total number of phases"
      - "spec_dir: string - path to spec directory"
      - "spec: map - full spec.yaml content"
      - "plan: map - full plan.yaml content"
      - "tasks: []TaskItem - only tasks for this phase"

  - name: "PhaseInfo"
    description: "Statistics about a phase (existing struct to be leveraged)"
    attributes:
      - "Number: int - phase number"
      - "Title: string - phase title"
      - "TotalTasks: int - total tasks in phase"
      - "CompletedTasks: int - completed tasks"
      - "BlockedTasks: int - blocked tasks"
      - "ActionableTasks: int - pending tasks ready to work"

edge_cases:
  - scenario: "Phase has zero tasks"
    expected_behavior: "Display '0 tasks' and skip execution, mark phase complete immediately"

  - scenario: "All tasks in phase already completed"
    expected_behavior: "Display status showing all completed, skip execution with message"

  - scenario: "Context file cannot be created (disk full, permissions)"
    expected_behavior: "Return clear error with path that failed and reason; do not proceed with phase"

  - scenario: "Phase number out of range"
    expected_behavior: "Return error indicating valid phase range"

  - scenario: "spec.yaml or plan.yaml missing when building context"
    expected_behavior: "Return specific error identifying which required file is missing"

  - scenario: "Tasks for phase have circular dependencies"
    expected_behavior: "Existing validation catches this; context injection proceeds with warning"

assumptions:
  - "GetPhaseInfo() and related functions in validation package already provide accurate phase statistics"
  - "PhaseInfo struct has all data needed for display (task counts, titles)"
  - "Temporary files can be created in system temp directory"
  - "Claude slash command can accept additional --context-file argument"
  - "YAML serialization of spec/plan content preserves all necessary information"
  - "Context file size will be manageable (spec + plan + phase tasks typically under 100KB)"

constraints:
  - "Must maintain backward compatibility - existing --phases flag behavior preserved"
  - "Must work with existing tasks.yaml format and structure"
  - "Cannot change how tasks.yaml status is updated (remains through autospec update-task)"
  - "Helper functions must meet <10ms performance contract"
  - "Temporary files must be cleaned up to prevent disk space leaks"

out_of_scope:
  - "Task-level context injection (--tasks mode) - documented as future enhancement"
  - "Caching of context between phases"
  - "Parallel phase execution"
  - "Changes to how Claude updates task status"
  - "Modifications to spec.yaml or plan.yaml formats"
  - "Real-time progress updates during phase execution"
  - "Web UI or dashboard for viewing phase progress"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T08:21:17Z"
  artifact_type: "spec"
