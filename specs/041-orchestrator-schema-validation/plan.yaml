plan:
  branch: "041-orchestrator-schema-validation"
  created: "2025-12-18"
  spec_path: "specs/041-orchestrator-schema-validation/spec.yaml"

summary: |
  This implementation adds programmatic schema validation to the autospec orchestrator, replacing
  file-existence checks with full schema validation using the existing artifact validators
  (SpecValidator, PlanValidator, TasksValidator). The key enhancement is that validation errors
  are now injected into the $ARGUMENTS placeholder for retry attempts, giving Claude specific
  error context to fix schema issues. The implementation reuses existing validation infrastructure
  with minimal changes to the orchestrator's ExecuteStage function and workflow methods.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for artifact validation"
    - name: "github.com/spf13/cobra"
      version: "v1.8.1"
      purpose: "CLI command framework"
  storage: "File-based (YAML artifacts in specs/ directory)"
  testing:
    framework: "Go testing package"
    approach: "Map-based table-driven tests with t.Parallel(), mocking ClaudeExecutor for integration tests"
  target_platform: "Cross-platform (Linux, macOS, Windows)"
  project_type: "cli"
  performance_goals: "Validation functions complete in <10ms (existing contract)"
  constraints:
    - "Must reuse existing validation infrastructure - no new schema rules"
    - "Backward compatibility with existing CLI behavior"
    - "Functions must be under 40 lines per Go best practices"
    - "No changes to public API of existing commands"
  scale_scope: "Single-user CLI tool with local file operations"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All new validation wrapper functions and retry context formatting will have unit tests written first"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "This feature directly enhances validation-first workflow by adding schema validation to stage transitions"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Reuses existing validators which already meet <10ms performance contract"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Enhances retry logic by injecting validation errors for intelligent retries"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Existing exit codes remain unchanged; validation failures return exit code 1 (retryable)"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Implementation follows <40 line functions, wrapped errors, map-based tests patterns"

research_findings:
  decisions:
    - topic: "Retry context injection mechanism"
      decision: "Inject retry context via existing $ARGUMENTS placeholder in command templates"
      rationale: "Avoids adding new template parameters, maintains backward compatibility, leverages existing Claude command parsing"
      alternatives_considered:
        - "Add new $RETRY_CONTEXT template parameter"
        - "Pass retry info via environment variable"
        - "Create separate retry prompt file"
    - topic: "Validation function integration point"
      decision: "Pass schema validator functions as the validateFunc parameter to ExecuteStage()"
      rationale: "ExecuteStage already accepts a validation callback; we just need to provide schema-aware validators instead of existence checks"
      alternatives_considered:
        - "Create new ExecuteStageWithSchemaValidation() method"
        - "Add validation type parameter to ExecuteStage()"
    - topic: "Retry context format"
      decision: "Use standardized multi-line format: 'RETRY X/Y\nSchema validation failed:\n- error1\n- error2\n\n<original args>'"
      rationale: "Clear, parseable format that Claude can interpret; separates retry metadata from error details"
      alternatives_considered:
        - "JSON-formatted retry context"
        - "YAML-formatted retry context"
        - "Single-line format"

data_model:
  entities:
    - name: "ValidationResult"
      description: "Existing struct from validation package containing validation outcome and errors"
      fields:
        - name: "Valid"
          type: "bool"
          description: "Whether the artifact passed schema validation"
          constraints: "N/A"
        - name: "Errors"
          type: "[]*ValidationError"
          description: "List of validation errors found"
          constraints: "Empty when Valid is true"
        - name: "Warnings"
          type: "[]*ValidationWarning"
          description: "List of validation warnings (non-blocking)"
          constraints: "N/A"
      relationships:
        - target: "ValidationError"
          type: "one-to-many"
          description: "Contains zero or more validation errors"
    - name: "RetryContext"
      description: "Conceptual entity representing retry information injected into $ARGUMENTS"
      fields:
        - name: "AttemptNumber"
          type: "int"
          description: "Current retry attempt (1-based)"
          constraints: "1 <= AttemptNumber <= MaxRetries"
        - name: "MaxRetries"
          type: "int"
          description: "Maximum retry attempts configured"
          constraints: "1 <= MaxRetries <= 10"
        - name: "ValidationErrors"
          type: "[]string"
          description: "List of validation error messages from failed attempt"
          constraints: "Non-empty when retrying due to validation failure"
        - name: "OriginalArgs"
          type: "string"
          description: "Original $ARGUMENTS content (if any)"
          constraints: "May be empty"
      relationships:
        - target: "ValidationResult"
          type: "derived-from"
          description: "Validation errors extracted from failed ValidationResult"

api_contracts: {}

project_structure:
  documentation:
    - path: "docs/internals.md"
      description: "Update to document retry context format and schema validation behavior"
    - path: "internal/commands/autospec.specify.md"
      description: "Add 'Retry Context' section documenting how to handle retry info in $ARGUMENTS"
    - path: "internal/commands/autospec.plan.md"
      description: "Add 'Retry Context' section documenting how to handle retry info in $ARGUMENTS"
    - path: "internal/commands/autospec.tasks.md"
      description: "Add 'Retry Context' section documenting how to handle retry info in $ARGUMENTS"
  source_code:
    - path: "internal/workflow/executor.go"
      description: "Add buildRetryCommand() helper and modify retry handling to include validation errors"
    - path: "internal/workflow/workflow.go"
      description: "Update validateFunc callbacks to use schema validators instead of existence checks"
    - path: "internal/workflow/schema_validation.go"
      description: "New file with schema validation wrapper functions that return errors compatible with ExecuteStage"
  tests:
    - path: "internal/workflow/executor_test.go"
      description: "Add tests for retry context formatting and schema validation integration"
    - path: "internal/workflow/schema_validation_test.go"
      description: "Unit tests for schema validation wrapper functions"
    - path: "internal/workflow/workflow_test.go"
      description: "Integration tests for full workflow with schema validation"

implementation_phases:
  - phase: 1
    name: "Schema Validation Wrappers"
    goal: "Create wrapper functions that invoke existing validators and return errors compatible with ExecuteStage"
    deliverables:
      - "internal/workflow/schema_validation.go with ValidateSpecSchema(), ValidatePlanSchema(), ValidateTasksSchema() functions"
      - "internal/workflow/schema_validation_test.go with comprehensive unit tests"
      - "Functions return validation errors with full schema error details"
  - phase: 2
    name: "Retry Context Formatting"
    goal: "Implement standardized retry context format and command builder"
    dependencies:
      - "Phase 1"
    deliverables:
      - "FormatRetryContext() function to create retry context string from validation errors"
      - "BuildRetryCommand() function to prepend retry context to original command arguments"
      - "Unit tests for retry context formatting with edge cases"
  - phase: 3
    name: "Executor Integration"
    goal: "Integrate schema validation and retry context into ExecuteStage workflow"
    dependencies:
      - "Phase 2"
    deliverables:
      - "Modify handleValidationFailure() to capture and format validation errors"
      - "Update retry command building to include schema error context"
      - "Integration tests verifying retry commands contain validation errors"
  - phase: 4
    name: "Workflow Method Updates"
    goal: "Wire schema validators into all workflow execution methods"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Update executePlan() to use ValidatePlanSchema()"
      - "Update executeTasks() to use ValidateTasksSchema()"
      - "Update executeSpecify() to use ValidateSpecSchema()"
      - "Ensure consistent validation across run, prep, and individual stage commands"
  - phase: 5
    name: "Command Template Documentation"
    goal: "Document retry context handling in command templates"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Add 'Retry Context' section to autospec.specify.md template"
      - "Add 'Retry Context' section to autospec.plan.md template"
      - "Add 'Retry Context' section to autospec.tasks.md template"
      - "Update docs/internals.md with retry context format specification"
  - phase: 6
    name: "Quality Gates and Final Validation"
    goal: "Ensure all quality gates pass and implementation is complete"
    dependencies:
      - "Phase 5"
    deliverables:
      - "All tests passing (make test)"
      - "Code properly formatted (make fmt)"
      - "No lint errors (make lint)"
      - "Successful build (make build)"

risks:
  - risk: "Retry context injection breaks existing command parsing"
    likelihood: "low"
    impact: "high"
    mitigation: "Test with empty, single-line, and multi-line original $ARGUMENTS to ensure format is robust"
  - risk: "Schema validators return errors in unexpected format"
    likelihood: "low"
    impact: "medium"
    mitigation: "Wrapper functions normalize error output; add defensive error formatting"
  - risk: "Performance regression from schema validation vs existence check"
    likelihood: "low"
    impact: "low"
    mitigation: "Existing validators already meet <10ms contract; add benchmark tests to verify"
  - risk: "Circular dependency between workflow and validation packages"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Keep validation wrappers in workflow package; import validation package unidirectionally"

open_questions:
  - question: "Should retry context be injected for non-validation failures (e.g., command timeout)?"
    context: "Current spec focuses on schema validation errors; other failure modes may benefit from context injection"
    proposed_resolution: "Initial implementation handles only schema validation failures; future enhancement can extend to other failure types"
  - question: "How should very long validation error lists be handled?"
    context: "Some artifacts could theoretically have many validation errors; very long retry context could exceed reasonable command length"
    proposed_resolution: "Limit to first 10 errors with '...and N more errors' suffix if needed"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-18T03:10:50Z"
  artifact_type: "plan"
