feature:
  branch: "065-dag-parallel-execution"
  created: "2025-12-20"
  status: "Draft"
  input: "Add a DAG-based parallel execution command that analyzes task dependencies and executes independent tasks concurrently, improving implementation speed while respecting dependency order. This builds on the --tasks flag from spec 021 which runs tasks sequentially. The parallel execution feature identifies tasks that have no dependency relationship (can run simultaneously without conflicts) and executes them concurrently using multiple Claude sessions or worktrees."

user_stories:
  - id: "US-001"
    title: "Execute independent tasks in parallel"
    priority: "P1"
    as_a: "developer running autospec implement"
    i_want: "to run tasks without shared dependencies in parallel using --parallel flag"
    so_that: "implementation completes faster by utilizing multiple concurrent Claude sessions"
    why_this_priority: "Core feature - parallelization is the entire value proposition of this feature"
    independent_test: "Run autospec implement --parallel on a spec with 3 independent tasks and verify all run concurrently"
    acceptance_scenarios:
      - given: "a tasks.yaml with tasks T001, T002, T003 all having no dependencies"
        when: "user runs 'autospec implement --parallel'"
        then: "all three tasks execute concurrently in separate sessions"
      - given: "a tasks.yaml where T001 and T002 are independent but T003 depends on both"
        when: "user runs 'autospec implement --parallel'"
        then: "T001 and T002 run concurrently, T003 waits until both complete"

  - id: "US-002"
    title: "Visualize task dependency graph"
    priority: "P1"
    as_a: "developer planning parallel execution"
    i_want: "to see the task dependency graph before execution"
    so_that: "I understand which tasks will run in parallel and the execution waves"
    why_this_priority: "Essential for understanding and debugging parallel execution behavior"
    independent_test: "Run autospec dag and verify visual representation shows dependency relationships"
    acceptance_scenarios:
      - given: "a tasks.yaml with complex dependencies"
        when: "user runs 'autospec dag'"
        then: "a visual DAG is displayed showing tasks grouped by execution wave"
      - given: "tasks with dependencies T001 -> T002, T001 -> T003, T002 -> T004, T003 -> T004"
        when: "user runs 'autospec dag'"
        then: "output shows Wave 1: [T001], Wave 2: [T002, T003], Wave 3: [T004]"

  - id: "US-003"
    title: "Control parallel execution concurrency"
    priority: "P1"
    as_a: "developer with limited resources"
    i_want: "to limit the number of concurrent Claude sessions using --max-parallel flag"
    so_that: "I can balance speed with system resource constraints"
    why_this_priority: "Critical for resource management - unlimited parallelism could overwhelm systems"
    independent_test: "Run with --max-parallel 2 on 4 independent tasks and verify only 2 run at once"
    acceptance_scenarios:
      - given: "5 independent tasks and --max-parallel 2"
        when: "running autospec implement --parallel --max-parallel 2"
        then: "at most 2 tasks execute concurrently at any time"
      - given: "user specifies --max-parallel 0 or negative"
        when: "running autospec implement"
        then: "error message indicates invalid value for --max-parallel"

  - id: "US-004"
    title: "Use git worktrees for parallel isolation"
    priority: "P2"
    as_a: "developer needing file-level isolation"
    i_want: "parallel tasks to execute in separate git worktrees"
    so_that: "tasks modifying the same files don't conflict during execution"
    why_this_priority: "Important for correctness but adds complexity; basic parallelism works without this"
    independent_test: "Run --parallel with worktree mode and verify each task runs in separate directory"
    acceptance_scenarios:
      - given: "parallel execution mode is active with worktree isolation"
        when: "tasks T001 and T002 run concurrently"
        then: "each runs in a separate worktree directory (e.g., .worktrees/T001/, .worktrees/T002/)"
      - given: "parallel tasks complete successfully"
        when: "all tasks in a wave finish"
        then: "changes from each worktree are merged back to the main branch"

  - id: "US-005"
    title: "Handle parallel task failures gracefully"
    priority: "P1"
    as_a: "developer with parallel execution"
    i_want: "failures in one parallel task to not abort other running tasks"
    so_that: "maximum work is completed even when some tasks fail"
    why_this_priority: "Critical for reliability - aborting all tasks wastes completed work"
    independent_test: "Start 3 parallel tasks, fail one deliberately, verify other 2 continue to completion"
    acceptance_scenarios:
      - given: "tasks T001, T002, T003 running in parallel"
        when: "T002 fails but T001 and T003 are still running"
        then: "T001 and T003 continue to completion, T002 is marked failed"
      - given: "task T004 depends on failed T002"
        when: "wave 1 completes with T002 failed"
        then: "T004 is skipped with message 'Skipped: dependency T002 failed'"

  - id: "US-006"
    title: "Generate execution plan without running"
    priority: "P2"
    as_a: "developer evaluating parallel execution"
    i_want: "to see the execution plan with wave assignments via --dry-run"
    so_that: "I can preview what will happen before committing to a long execution"
    why_this_priority: "Useful for planning but not required for core functionality"
    independent_test: "Run with --dry-run and verify execution plan is shown without any tasks running"
    acceptance_scenarios:
      - given: "a complex tasks.yaml with multiple dependency chains"
        when: "user runs 'autospec implement --parallel --dry-run'"
        then: "output shows each wave and which tasks run in each, but nothing executes"
      - given: "user combines --dry-run with --max-parallel 2"
        when: "running the dry-run"
        then: "output shows batches respecting the max-parallel limit"

  - id: "US-007"
    title: "Track parallel execution progress"
    priority: "P2"
    as_a: "developer monitoring parallel execution"
    i_want: "real-time progress updates showing all running tasks"
    so_that: "I know which tasks are in progress, completed, or waiting"
    why_this_priority: "Improves user experience but execution works without real-time updates"
    independent_test: "Run parallel execution and observe live progress updates for multiple tasks"
    acceptance_scenarios:
      - given: "3 tasks running in parallel"
        when: "user observes console output"
        then: "status shows all 3 tasks with their current state (running, completed, pending)"
      - given: "task T001 completes while T002 and T003 are still running"
        when: "status updates"
        then: "T001 shows completed, T002 and T003 show running"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST add --parallel flag to implement command CLI"
      testable: true
      acceptance_criteria: "'autospec implement --help' shows --parallel flag with description"
    - id: "FR-002"
      description: "MUST add --max-parallel flag accepting integer value (default 4)"
      testable: true
      acceptance_criteria: "'autospec implement --help' shows --max-parallel with default value"
    - id: "FR-003"
      description: "MUST build dependency graph (DAG) from tasks.yaml before execution"
      testable: true
      acceptance_criteria: "DAG correctly identifies independent tasks and dependency chains"
    - id: "FR-004"
      description: "MUST compute execution waves - groups of tasks that can run concurrently"
      testable: true
      acceptance_criteria: "Tasks in same wave have no dependency relationship"
    - id: "FR-005"
      description: "MUST execute tasks within each wave concurrently up to max-parallel limit"
      testable: true
      acceptance_criteria: "Concurrent execution observable via multiple Claude processes"
    - id: "FR-006"
      description: "MUST wait for all tasks in a wave to complete before starting next wave"
      testable: true
      acceptance_criteria: "No task starts if its dependencies are not yet completed"
    - id: "FR-007"
      description: "MUST add 'autospec dag' subcommand to visualize task dependency graph"
      testable: true
      acceptance_criteria: "'autospec dag --help' shows command documentation"
    - id: "FR-008"
      description: "MUST support --dry-run flag to preview execution plan without running"
      testable: true
      acceptance_criteria: "--dry-run outputs wave assignments without spawning Claude sessions"
    - id: "FR-009"
      description: "MUST handle task failures gracefully - continue other parallel tasks"
      testable: true
      acceptance_criteria: "Failed task does not abort sibling tasks in same wave"
    - id: "FR-010"
      description: "MUST skip tasks whose dependencies failed"
      testable: true
      acceptance_criteria: "Task with failed dependency shows 'Skipped: dependency X failed'"
    - id: "FR-011"
      description: "MUST track parallel execution state in retry state for resumption"
      testable: true
      acceptance_criteria: "retry.json contains per-task state after parallel execution"
    - id: "FR-012"
      description: "SHOULD support worktree mode for file-level isolation (--worktrees flag)"
      testable: true
      acceptance_criteria: "With --worktrees, each task runs in separate git worktree"
    - id: "FR-013"
      description: "MUST be mutually exclusive with --tasks and --phases flags"
      testable: true
      acceptance_criteria: "Using --parallel with --tasks or --phases shows error"
    - id: "FR-014"
      description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
      testable: true
      acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
  non_functional:
    - id: "NFR-001"
      category: "performance"
      description: "DAG computation MUST complete in under 100ms for tasks.yaml with up to 100 tasks"
      measurable_target: "Benchmarks show <100ms for 100 tasks with complex dependencies"
    - id: "NFR-002"
      category: "performance"
      description: "Parallel execution SHOULD reduce total time by factor of min(wave_size, max_parallel)"
      measurable_target: "4 independent tasks with max-parallel 4 complete in ~1x single task time"
    - id: "NFR-003"
      category: "reliability"
      description: "System MUST not corrupt tasks.yaml during parallel updates"
      measurable_target: "Zero data corruption in 100 parallel execution runs"
    - id: "NFR-004"
      category: "usability"
      description: "DAG visualization MUST be understandable without documentation"
      measurable_target: "Users can identify execution waves from output within 10 seconds"
    - id: "NFR-005"
      category: "code_quality"
      description: "All functions must be under 40 lines; extract helpers for complex logic"
      measurable_target: "No function exceeds 40 lines excluding comments"
    - id: "NFR-006"
      category: "code_quality"
      description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
      measurable_target: "Zero bare 'return err' statements in new code"
    - id: "NFR-007"
      category: "code_quality"
      description: "Tests must use map-based table-driven pattern with t.Parallel()"
      measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
    - id: "NFR-008"
      category: "code_quality"
      description: "Accept interfaces, return concrete types"
      measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can execute independent tasks concurrently"
      metric: "Successful completion of --parallel execution on multi-task spec"
      target: "Independent tasks run in parallel, dependent tasks wait appropriately"
    - id: "SC-002"
      description: "Users can visualize task dependencies"
      metric: "autospec dag command produces readable output"
      target: "Execution waves clearly shown with task groupings"
    - id: "SC-003"
      description: "Parallel execution provides time savings"
      metric: "Total execution time for specs with parallelizable tasks"
      target: "At least 50% time reduction when 4+ independent tasks exist"
    - id: "SC-004"
      description: "Failures are isolated and recoverable"
      metric: "Completed tasks remain stable after parallel task failures"
      target: "100% of completed tasks remain marked Completed after sibling failure"
    - id: "SC-005"
      description: "Resource usage is controllable"
      metric: "--max-parallel flag correctly limits concurrency"
      target: "Never exceeds specified max-parallel limit"

key_entities:
  - name: "DependencyGraph"
    description: "Directed acyclic graph representing task dependencies"
    attributes:
      - "nodes (map of task ID to task)"
      - "edges (dependency relationships)"
      - "roots (tasks with no dependencies)"
  - name: "ExecutionWave"
    description: "Group of tasks that can execute concurrently"
    attributes:
      - "wave_number (1, 2, 3...)"
      - "task_ids (list of tasks in this wave)"
      - "status (pending, running, completed)"
  - name: "ParallelExecutor"
    description: "Orchestrator for concurrent task execution"
    attributes:
      - "max_parallel (concurrency limit)"
      - "active_tasks (currently running)"
      - "completed_tasks (finished tasks)"
      - "failed_tasks (failed task IDs)"
  - name: "TaskResult"
    description: "Outcome of a single task execution"
    attributes:
      - "task_id"
      - "success (boolean)"
      - "error_message (if failed)"
      - "duration"

edge_cases:
  - scenario: "All tasks have dependencies forming a linear chain"
    expected_behavior: "Falls back to sequential execution (one task per wave)"
  - scenario: "Circular dependency detected in DAG"
    expected_behavior: "Error before execution: 'Circular dependency detected: T001 -> T002 -> T001'"
  - scenario: "All tasks are independent (no dependencies)"
    expected_behavior: "All tasks in wave 1, limited only by max-parallel"
  - scenario: "Task fails in middle wave, later tasks depend on it"
    expected_behavior: "Dependent tasks are skipped, independent tasks continue"
  - scenario: "User interrupts with Ctrl+C during parallel execution"
    expected_behavior: "All running tasks are sent termination signal, state is saved"
  - scenario: "Two parallel tasks modify same file"
    expected_behavior: "Without --worktrees: last write wins (potential conflict). With --worktrees: merge required after wave"
  - scenario: "max-parallel exceeds available system resources"
    expected_behavior: "System may slow down but execution continues; warning if max-parallel > 8"
  - scenario: "tasks.yaml is modified during parallel execution"
    expected_behavior: "Original DAG is used; changes detected at next wave boundary"
  - scenario: "Using --parallel with --from-task"
    expected_behavior: "Parallel execution starts from the wave containing specified task"
  - scenario: "Worktree already exists for a task"
    expected_behavior: "Clean existing worktree before reusing, with warning"

assumptions:
  - "tasks.yaml follows existing schema with task IDs and dependencies field"
  - "Task dependencies are acyclic (validated by existing infrastructure)"
  - "Each task can execute independently in isolation (no implicit shared state)"
  - "System has sufficient resources to run max-parallel concurrent Claude sessions"
  - "Git worktree command is available on the system (for --worktrees mode)"
  - "File conflicts in parallel execution are rare and can be resolved manually"
  - "Claude sessions can be spawned and managed independently"

constraints:
  - "Must build on existing --tasks infrastructure from spec 021"
  - "Must integrate with existing retry state infrastructure (retry.json)"
  - "Must use existing task validation functions (GetTasksInDependencyOrder, etc.)"
  - "Claude CLI invocation patterns must match existing execution modes"
  - "Exit codes must follow existing conventions (0=success, 1=validation fail, 2=retries exhausted)"
  - "Must not break existing sequential execution modes"

out_of_scope:
  - "Automatic file conflict resolution (manual merge required)"
  - "Distributed execution across multiple machines"
  - "Dynamic dependency adjustment during execution"
  - "Task prioritization within waves (all tasks in wave are equal priority)"
  - "Per-task resource limits or quotas"
  - "Integration with external CI/CD systems"
  - "Worktree cleanup automation (manual cleanup acceptable for MVP)"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-20T00:54:12Z"
  artifact_type: "spec"
