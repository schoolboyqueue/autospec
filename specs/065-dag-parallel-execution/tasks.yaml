tasks:
    branch: "065-dag-parallel-execution"
    created: "2025-12-20"
    spec_path: "specs/065-dag-parallel-execution/spec.yaml"
    plan_path: "specs/065-dag-parallel-execution/plan.yaml"
summary:
    total_tasks: 32
    total_phases: 7
    parallel_opportunities: 12
    estimated_complexity: "high"
phases:
    - number: 1
      title: "Setup"
      purpose: "Project initialization and new package structure"
      tasks:
        - id: "T001"
          title: "Create internal/dag/ package directory structure"
          status: "Completed"
          type: "setup"
          parallel: false
          story_id: null
          file_path: "internal/dag/"
          dependencies: []
          acceptance_criteria:
            - "Directory internal/dag/ exists"
            - "Package declaration is 'package dag'"
    - number: 2
      title: "Foundational - DAG Infrastructure"
      purpose: "Core DAG types and wave computation that MUST be complete before user stories"
      tasks:
        - id: "T002"
          title: "Implement DependencyGraph and TaskNode types in internal/dag/graph.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/graph.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "DependencyGraph struct with nodes (map[string]*TaskNode), roots ([]string), waves ([]ExecutionWave)"
            - "TaskNode struct with id, dependencies, dependents, depth, status fields"
            - "TaskStatus enum type with Pending, Running, Completed, Failed, Skipped values"
            - "NewDependencyGraph() constructor function"
            - "AddTask(id string, deps []string) method"
            - "BuildFromTasks(tasks []validation.Task) constructor"
        - id: "T003"
          title: "Implement cycle detection in internal/dag/graph.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: null
          file_path: "internal/dag/graph.go"
          dependencies: ["T001"]
          acceptance_criteria:
            - "DetectCycle() method returns error with cycle path if found"
            - "Uses DFS-based cycle detection algorithm"
            - "Error format: 'circular dependency detected: T001 -> T002 -> T001'"
        - id: "T004"
          title: "Implement wave computation algorithm in internal/dag/waves.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: "internal/dag/waves.go"
          dependencies: ["T002", "T003"]
          acceptance_criteria:
            - "ComputeWaves() method on DependencyGraph"
            - "ExecutionWave struct with number, taskIDs, status, results fields"
            - "WaveStatus enum with Pending, Running, Completed, PartialFailed values"
            - "Tasks grouped by maximum dependency depth"
            - "Returns ordered []ExecutionWave"
        - id: "T005"
          title: "Write unit tests for DependencyGraph in internal/dag/graph_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/graph_test.go"
          dependencies: ["T002", "T003"]
          acceptance_criteria:
            - "Map-based table-driven tests with t.Parallel()"
            - "Tests for: empty graph, single task, linear chain, diamond pattern"
            - "Tests for: cycle detection (simple cycle, complex cycle)"
            - "Tests for: root identification, dependent computation"
        - id: "T006"
          title: "Write unit tests for wave computation in internal/dag/waves_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: null
          file_path: "internal/dag/waves_test.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "Map-based table-driven tests with t.Parallel()"
            - "Tests for: all independent (single wave), linear chain (one per wave)"
            - "Tests for: diamond dependencies, complex multi-wave graphs"
            - "Tests for: max 100 tasks <100ms benchmark"
    - number: 3
      title: "User Story 1 - Execute independent tasks in parallel (US-001)"
      purpose: "Core feature - parallelization is the entire value proposition"
      story_reference: "US-001"
      independent_test: "Run autospec implement --parallel on a spec with 3 independent tasks and verify all run concurrently"
      tasks:
        - id: "T007"
          title: "Implement ParallelExecutor type in internal/workflow/parallel_executor.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "ParallelExecutor struct with maxParallel, graph, worktreeManager, dagRoot, failedTasks fields"
            - "TaskResult struct with taskID, success, error, duration, worktreePath fields"
            - "NewParallelExecutor(graph, maxParallel, worktreeManager) constructor"
            - "Functions under 40 lines"
            - "Errors wrapped with context"
        - id: "T008"
          title: "Implement wave-by-wave execution with errgroup in parallel_executor.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T007"]
          acceptance_criteria:
            - "ExecuteWaves() method orchestrates wave-by-wave execution"
            - "Uses golang.org/x/sync/errgroup for goroutine coordination"
            - "Respects maxParallel limit using semaphore pattern"
            - "Waits for all tasks in wave before proceeding to next"
            - "Collects TaskResult for each task"
        - id: "T009"
          title: "Implement task execution wrapper calling Claude session"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-001"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T008"]
          acceptance_criteria:
            - "executeTask() internal method spawns Claude session for single task"
            - "Uses existing workflow.ExecuteTask or similar pattern"
            - "Returns TaskResult with success/error/duration"
            - "Handles context cancellation gracefully"
        - id: "T010"
          title: "Write unit tests for ParallelExecutor in parallel_executor_test.go"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-001"
          file_path: "internal/workflow/parallel_executor_test.go"
          dependencies: ["T009"]
          acceptance_criteria:
            - "Map-based table-driven tests with t.Parallel()"
            - "Tests for: single wave execution, multi-wave execution"
            - "Tests for: max-parallel limiting (verify semaphore)"
            - "Tests with mock Claude executor to avoid real sessions"
    - number: 4
      title: "User Story 2 - Visualize task dependency graph (US-002)"
      purpose: "Essential for understanding and debugging parallel execution behavior"
      story_reference: "US-002"
      independent_test: "Run autospec dag and verify visual representation shows dependency relationships"
      tasks:
        - id: "T011"
          title: "Implement ASCII visualization in internal/dag/visualize.go"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-002"
          file_path: "internal/dag/visualize.go"
          dependencies: ["T004"]
          acceptance_criteria:
            - "RenderASCII() method on DependencyGraph"
            - "Shows waves with box/tree drawing characters"
            - "Format: 'Wave 1: [T001] -> Wave 2: [T002, T003] -> Wave 3: [T004]'"
            - "Uses portable ASCII characters (no Unicode)"
            - "Functions under 40 lines"
        - id: "T012"
          title: "Implement autospec dag subcommand in internal/cli/util/dag.go"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-002"
          file_path: "internal/cli/util/dag.go"
          dependencies: ["T011"]
          acceptance_criteria:
            - "NewDagCmd() returns *cobra.Command"
            - "Loads tasks.yaml from current spec context"
            - "Builds DependencyGraph and calls RenderASCII()"
            - "Outputs to stdout"
            - "Registered in root command"
        - id: "T013"
          title: "Write tests for ASCII visualization in internal/dag/visualize_test.go"
          status: "Completed"
          type: "test"
          parallel: true
          story_id: "US-002"
          file_path: "internal/dag/visualize_test.go"
          dependencies: ["T011"]
          acceptance_criteria:
            - "Map-based table-driven tests with t.Parallel()"
            - "Tests output format for: single wave, multiple waves"
            - "Tests for: empty graph edge case"
            - "Verifies ASCII characters only (no Unicode)"
        - id: "T014"
          title: "Write tests for dag command in internal/cli/util/dag_test.go"
          status: "Completed"
          type: "test"
          parallel: true
          story_id: "US-002"
          file_path: "internal/cli/util/dag_test.go"
          dependencies: ["T012"]
          acceptance_criteria:
            - "Map-based table-driven tests"
            - "Tests command with valid tasks.yaml"
            - "Tests error handling for missing tasks.yaml"
            - "Tests error handling for circular dependencies"
    - number: 5
      title: "User Story 3 - Control parallel execution concurrency (US-003)"
      purpose: "Critical for resource management"
      story_reference: "US-003"
      independent_test: "Run with --max-parallel 2 on 4 independent tasks and verify only 2 run at once"
      tasks:
        - id: "T015"
          title: "Add --parallel and --max-parallel flags to implement command"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/cli/stages/implement.go"
          dependencies: ["T009"]
          acceptance_criteria:
            - "--parallel bool flag enables parallel execution"
            - "--max-parallel int flag with default value 4"
            - "Flags visible in 'autospec implement --help'"
            - "Validation: error if --max-parallel <= 0"
            - "Warning if --max-parallel > 8"
        - id: "T016"
          title: "Add mutual exclusivity check for --parallel with --tasks and --phases"
          status: "Completed"
          type: "implementation"
          parallel: true
          story_id: "US-003"
          file_path: "internal/cli/stages/implement.go"
          dependencies: ["T015"]
          acceptance_criteria:
            - "Error message if --parallel used with --tasks"
            - "Error message if --parallel used with --phases"
            - "Error format: 'cannot use --parallel with --tasks or --phases'"
        - id: "T017"
          title: "Integrate ParallelExecutor dispatch in orchestrator"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-003"
          file_path: "internal/workflow/orchestrator.go"
          dependencies: ["T015", "T016"]
          acceptance_criteria:
            - "ExecuteParallel() method or similar on Orchestrator"
            - "Creates ParallelExecutor with configured max-parallel"
            - "Dispatches to parallel execution when --parallel flag set"
            - "Returns aggregated results from all waves"
        - id: "T018"
          title: "Write tests for CLI flag validation"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-003"
          file_path: "internal/cli/stages/implement_test.go"
          dependencies: ["T016", "T017"]
          acceptance_criteria:
            - "Tests for valid --parallel usage"
            - "Tests for invalid --max-parallel values (0, negative)"
            - "Tests for mutual exclusivity errors"
            - "Tests for warning on max-parallel > 8"
    - number: 6
      title: "User Story 5 - Handle parallel task failures gracefully (US-005)"
      purpose: "Critical for reliability - aborting all tasks wastes completed work"
      story_reference: "US-005"
      independent_test: "Start 3 parallel tasks, fail one deliberately, verify other 2 continue to completion"
      tasks:
        - id: "T019"
          title: "Implement graceful failure handling in ParallelExecutor"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T010"]
          acceptance_criteria:
            - "Failed task does not cancel sibling goroutines"
            - "Failed tasks recorded in failedTasks map"
            - "Wave marked PartialFailed if any task fails"
            - "Other tasks in wave continue to completion"
        - id: "T020"
          title: "Implement dependency skip logic for failed upstream tasks"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-005"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T019"]
          acceptance_criteria:
            - "Before executing task, check if any dependency in failedTasks"
            - "If dependency failed, skip task with message"
            - "Skip message format: 'Skipped: dependency T002 failed'"
            - "Skipped tasks marked with Skipped status"
        - id: "T021"
          title: "Write tests for failure handling scenarios"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-005"
          file_path: "internal/workflow/parallel_executor_test.go"
          dependencies: ["T020"]
          acceptance_criteria:
            - "Test: one task fails, siblings continue"
            - "Test: dependent task skipped when upstream fails"
            - "Test: multiple failures in same wave"
            - "Test: cascade of skipped tasks through dependency chain"
    - number: 7
      title: "User Story 4 - Use git worktrees for parallel isolation (US-004)"
      purpose: "Important for correctness with overlapping file modifications"
      story_reference: "US-004"
      independent_test: "Run --parallel with worktree mode and verify each task runs in separate directory"
      tasks:
        - id: "T022"
          title: "Add --worktrees flag to implement command"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/cli/stages/implement.go"
          dependencies: ["T017"]
          acceptance_criteria:
            - "--worktrees bool flag enables worktree isolation"
            - "Only valid when used with --parallel"
            - "Error if --worktrees used without --parallel"
        - id: "T023"
          title: "Implement worktree creation per task in ParallelExecutor"
          status: "InProgress"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T022"]
          acceptance_criteria:
            - "Creates .worktrees/<task-id>/ for each parallel task"
            - "Uses existing worktree.Manager from spec 064"
            - "Worktree branch named task-id"
            - "Claude session runs in worktree directory"
        - id: "T024"
          title: "Implement sequential merge into DAG-ROOT after wave completion"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-004"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T023"]
          acceptance_criteria:
            - "After wave completes, merge worktrees sequentially"
            - "Merge into DAG-ROOT branch (current branch at start)"
            - "If conflict detected, pause with user resolution prompt"
            - "Cleanup worktree after successful merge"
        - id: "T025"
          title: "Add worktree isolation warning prompt when --parallel without --worktrees"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-004"
          file_path: "internal/cli/stages/implement.go"
          dependencies: ["T022"]
          acceptance_criteria:
            - "Shows warning: 'Running without worktree isolation; file conflicts possible. Recommend using --worktrees. Continue? [y/N]'"
            - "Default is No (exits if user presses Enter)"
            - "--yes flag bypasses prompt"
            - "Prompt only shown when tasks exist in parallel waves"
        - id: "T026"
          title: "Write tests for worktree integration"
          status: "Pending"
          type: "test"
          parallel: false
          story_id: "US-004"
          file_path: "internal/workflow/parallel_executor_test.go"
          dependencies: ["T024"]
          acceptance_criteria:
            - "Test: worktrees created with correct naming"
            - "Test: worktrees cleaned up after merge"
            - "Test: merge conflict triggers pause (mocked)"
            - "Test: --worktrees without --parallel shows error"
    - number: 8
      title: "User Story 6 - Generate execution plan without running (US-006)"
      purpose: "Useful for planning and previewing execution"
      story_reference: "US-006"
      independent_test: "Run with --dry-run and verify execution plan is shown without any tasks running"
      tasks:
        - id: "T027"
          title: "Add --dry-run flag to implement command"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-006"
          file_path: "internal/cli/stages/implement.go"
          dependencies: ["T017"]
          acceptance_criteria:
            - "--dry-run bool flag previews execution without running"
            - "Only valid with --parallel flag"
            - "Outputs wave assignments and task groupings"
            - "Shows batch sizes respecting --max-parallel"
        - id: "T028"
          title: "Implement dry-run output formatter"
          status: "Completed"
          type: "implementation"
          parallel: false
          story_id: "US-006"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T027"]
          acceptance_criteria:
            - "DryRun() method outputs execution plan"
            - "Shows each wave with task IDs and batch subdivisions"
            - "Shows max-parallel batching if wave exceeds limit"
            - "No Claude sessions spawned"
        - id: "T029"
          title: "Write tests for dry-run output"
          status: "Completed"
          type: "test"
          parallel: false
          story_id: "US-006"
          file_path: "internal/workflow/parallel_executor_test.go"
          dependencies: ["T028"]
          acceptance_criteria:
            - "Test: dry-run outputs waves without execution"
            - "Test: max-parallel batching shown correctly"
            - "Test: dry-run with empty graph"
    - number: 9
      title: "User Story 7 - Track parallel execution progress (US-007)"
      purpose: "Improves user experience with real-time progress updates"
      story_reference: "US-007"
      independent_test: "Run parallel execution and observe live progress updates for multiple tasks"
      tasks:
        - id: "T030"
          title: "Implement single-line progress display for parallel tasks"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-007"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T020"]
          acceptance_criteria:
            - "Uses carriage return (\\r) for in-place updates"
            - "Format: 'Wave N: T001 ● T002 ● T003 ○' where ● = running, ○ = pending, ✓ = done, ✗ = failed"
            - "Updates as tasks change state"
            - "Graceful degradation if terminal doesn't support ANSI"
        - id: "T031"
          title: "Implement parallel execution state persistence in retry.json"
          status: "Pending"
          type: "implementation"
          parallel: true
          story_id: "US-007"
          file_path: "internal/retry/state.go"
          dependencies: ["T020"]
          acceptance_criteria:
            - "ParallelState struct persisted in retry.json"
            - "Tracks currentWave, taskStates, failedDependencies"
            - "Atomic file writes to prevent corruption"
            - "Loaded on resume to restore state"
        - id: "T032"
          title: "Implement resume prompt with R/W/S/A options"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: "US-007"
          file_path: "internal/workflow/parallel_executor.go"
          dependencies: ["T031"]
          acceptance_criteria:
            - "On resume after interrupt, shows prompt with options"
            - "R (default): Resume incomplete tasks only"
            - "W: Whole wave restart"
            - "S: Skip to next wave"
            - "A: Abort"
            - "Pressing Enter selects R (Resume)"
    - number: 10
      title: "Polish & Cross-Cutting Concerns"
      purpose: "Documentation and final integration"
      tasks:
        - id: "T033"
          title: "Create docs/parallel-execution.md user guide"
          status: "Pending"
          type: "documentation"
          parallel: true
          story_id: null
          file_path: "docs/parallel-execution.md"
          dependencies: ["T032"]
          acceptance_criteria:
            - "Documents --parallel, --max-parallel, --worktrees, --dry-run flags"
            - "Explains wave computation and DAG visualization"
            - "Includes usage examples"
            - "Documents resume behavior after interruption"
        - id: "T034"
          title: "Verify all quality gates pass (make test, fmt, lint, build)"
          status: "Pending"
          type: "implementation"
          parallel: false
          story_id: null
          file_path: ""
          dependencies: ["T033"]
          acceptance_criteria:
            - "make test exits 0"
            - "make fmt shows no changes"
            - "make lint shows no errors"
            - "make build exits 0"
dependencies:
    user_story_order:
        - story_id: "US-001"
          depends_on: []
          blocks: ["US-003", "US-005"]
        - story_id: "US-002"
          depends_on: []
          blocks: []
        - story_id: "US-003"
          depends_on: ["US-001"]
          blocks: ["US-004", "US-006"]
        - story_id: "US-005"
          depends_on: ["US-001"]
          blocks: ["US-007"]
        - story_id: "US-004"
          depends_on: ["US-003"]
          blocks: []
        - story_id: "US-006"
          depends_on: ["US-003"]
          blocks: []
        - story_id: "US-007"
          depends_on: ["US-005"]
          blocks: []
    phase_order:
        - phase: 1
          blocks: [2]
        - phase: 2
          blocks: [3, 4]
        - phase: 3
          blocks: [5, 6]
        - phase: 4
          blocks: [5]
        - phase: 5
          blocks: [7, 8]
        - phase: 6
          blocks: [9]
        - phase: 7
          blocks: [9]
        - phase: 8
          blocks: [10]
        - phase: 9
          blocks: [10]
        - phase: 10
          blocks: []
parallel_execution:
    - phase: 2
      parallel_groups:
        - tasks: ["T002", "T003"]
          rationale: "Different functions in same file, no shared dependencies"
    - phase: 4
      parallel_groups:
        - tasks: ["T011", "T013"]
          rationale: "Visualization and its tests can be developed together"
        - tasks: ["T014"]
          rationale: "Command tests independent of visualization tests"
    - phase: 5
      parallel_groups:
        - tasks: ["T016"]
          rationale: "Mutual exclusivity check independent of main flag addition"
    - phase: 7
      parallel_groups:
        - tasks: ["T025"]
          rationale: "Warning prompt independent of worktree creation logic"
    - phase: 9
      parallel_groups:
        - tasks: ["T030", "T031"]
          rationale: "Progress display and state persistence are independent modules"
implementation_strategy:
    mvp_scope:
        phases: [1, 2, 3, 4, 5]
        description: "Setup + DAG Infrastructure + Core Parallel Execution + Visualization + CLI Flags"
        validation: "Run autospec implement --parallel on a multi-task spec and verify concurrent execution with --max-parallel limiting"
    incremental_delivery:
        - milestone: "DAG Foundation Ready"
          phases: [1, 2]
          deliverable: "DAG types and wave computation with full test coverage"
        - milestone: "Core Parallel Execution"
          phases: [1, 2, 3]
          deliverable: "Parallel task execution working with errgroup coordination"
        - milestone: "Visualization Available"
          phases: [1, 2, 4]
          deliverable: "autospec dag command shows execution waves"
        - milestone: "MVP Complete"
          phases: [1, 2, 3, 4, 5]
          deliverable: "Full parallel execution with CLI flags, concurrency control, and visualization"
        - milestone: "Failure Handling"
          phases: [1, 2, 3, 5, 6]
          deliverable: "Graceful failure handling with skip logic"
        - milestone: "Worktree Isolation"
          phases: [1, 2, 3, 5, 6, 7]
          deliverable: "Git worktree isolation for file conflict prevention"
        - milestone: "Full Feature"
          phases: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
          deliverable: "Complete feature with progress display, state persistence, and documentation"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-20T01:49:53Z"
    artifact_type: "tasks"
