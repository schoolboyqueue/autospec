plan:
  branch: "065-dag-parallel-execution"
  created: "2025-12-20"
  spec_path: "specs/065-dag-parallel-execution/spec.yaml"

summary: |
  This plan implements DAG-based parallel task execution for autospec, enabling independent tasks
  to run concurrently in separate Claude sessions. The implementation leverages the existing
  topological sort in GetTasksInDependencyOrder() and extends it with wave computation to identify
  tasks that can execute simultaneously. A new ParallelExecutor orchestrates concurrent Claude
  sessions with configurable max-parallel limits. Optional git worktree isolation prevents file
  conflicts when parallel tasks modify overlapping files. The 'autospec dag' command provides
  ASCII visualization of dependency graphs and execution waves for planning and debugging.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.1"
      purpose: "CLI command structure and flag parsing"
    - name: "gopkg.in/yaml.v3"
      version: "v3.0.1"
      purpose: "YAML parsing for tasks.yaml"
    - name: "golang.org/x/sync/errgroup"
      version: "v0.10.0"
      purpose: "Coordinated goroutine management with error propagation"
  storage: "File-based (tasks.yaml, retry.json)"
  testing:
    framework: "Go testing with testify"
    approach: "Map-based table-driven tests with t.Parallel(); unit tests for DAG/wave logic, integration tests for end-to-end execution"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "DAG computation <100ms for 100 tasks; parallel execution reduces time by factor of min(wave_size, max_parallel)"
  constraints:
    - "Must build on existing --tasks infrastructure"
    - "Must integrate with existing retry state (retry.json)"
    - "Must use existing task validation functions"
    - "Functions must be <40 lines"
    - "Errors must be wrapped with context"
  scale_scope: "Up to 100 tasks with complex dependency graphs"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "All new code will have tests written before implementation per NFR-007"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "PASS"
      notes: "DAG validation occurs before execution; dependency cycles detected early"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "NFR-001 requires DAG computation <100ms; benchmarks will verify"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "PASS"
      notes: "Per-task retry state in retry.json; interrupted waves can resume"
    - name: "Standardized Exit Codes (PRIN-005)"
      status: "PASS"
      notes: "Will follow existing exit code conventions (0=success, 1=validation, etc.)"
    - name: "YAML-First Artifacts (PRIN-006)"
      status: "PASS"
      notes: "Task state persisted in tasks.yaml; DAG output is structured YAML-compatible"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "NFR-005/006/007/008 enforce function length, error wrapping, table tests"
    - name: "Command Template Independence (PRIN-012)"
      status: "N/A"
      notes: "No new command templates created; uses existing /autospec.implement"

research_findings:
  decisions:
    - topic: "Wave computation algorithm"
      decision: "Extend GetTasksInDependencyOrder with depth tracking to group tasks by dependency level"
      rationale: "Reuses existing proven topological sort; depth naturally defines execution waves"
      alternatives_considered:
        - "Kahn's algorithm with level tracking"
        - "Separate BFS pass after toposort"
    - topic: "Concurrency primitive for parallel execution"
      decision: "Use golang.org/x/sync/errgroup for coordinated goroutine management"
      rationale: "Built-in context cancellation, error propagation, and wait semantics; widely used pattern"
      alternatives_considered:
        - "Manual sync.WaitGroup with channel-based errors"
        - "Worker pool pattern"
    - topic: "Progress display for parallel tasks"
      decision: "Single updating status line using ANSI escape codes (carriage return)"
      rationale: "Compact display, shows all parallel task states at once, works in most terminals"
      alternatives_considered:
        - "Multi-line output with per-task lines"
        - "Progress bar per task"
    - topic: "Worktree naming convention"
      decision: "Use .worktrees/<task-id>/ directory structure"
      rationale: "Clear mapping from task to worktree; easy cleanup; matches existing worktree manager"
      alternatives_considered:
        - ".worktrees/<feature>-<task-id>/"
        - "Temporary directories"
    - topic: "Merge strategy for worktree changes"
      decision: "Sequential merge into DAG-ROOT branch (current branch) after wave completion"
      rationale: "Keeps main untouched; feature branch collects all changes; conflicts pause for resolution"
      alternatives_considered:
        - "Parallel merge with octopus strategy"
        - "Cherry-pick individual commits"

data_model:
  entities:
    - name: "DependencyGraph"
      description: "Directed acyclic graph representing task dependencies with wave assignments"
      fields:
        - name: "nodes"
          type: "map[string]*TaskNode"
          description: "Task ID to node mapping"
          constraints: "All referenced task IDs must exist"
        - name: "roots"
          type: "[]string"
          description: "Task IDs with no dependencies (wave 1 candidates)"
          constraints: "Non-empty for valid graphs"
        - name: "waves"
          type: "[]ExecutionWave"
          description: "Computed execution waves in order"
          constraints: "Every task appears in exactly one wave"
      relationships:
        - target: "TaskNode"
          type: "one-to-many"
          description: "Graph contains multiple task nodes"
        - target: "ExecutionWave"
          type: "one-to-many"
          description: "Graph produces ordered waves"

    - name: "TaskNode"
      description: "Node in dependency graph representing a single task"
      fields:
        - name: "id"
          type: "string"
          description: "Task identifier (T001, T002, etc.)"
          constraints: "Must match tasks.yaml task ID"
        - name: "dependencies"
          type: "[]string"
          description: "IDs of tasks this depends on"
          constraints: "All referenced IDs must exist in graph"
        - name: "dependents"
          type: "[]string"
          description: "IDs of tasks that depend on this"
          constraints: "Computed from reverse dependency lookup"
        - name: "depth"
          type: "int"
          description: "Maximum distance from any root node"
          constraints: ">=0; determines wave assignment"
        - name: "status"
          type: "TaskStatus"
          description: "Current execution status"
          constraints: "One of: Pending, Running, Completed, Failed, Skipped"
      relationships:
        - target: "ExecutionWave"
          type: "many-to-one"
          description: "Task belongs to exactly one wave"

    - name: "ExecutionWave"
      description: "Group of tasks that can execute concurrently"
      fields:
        - name: "number"
          type: "int"
          description: "Wave number (1, 2, 3...)"
          constraints: ">0; sequential numbering"
        - name: "taskIDs"
          type: "[]string"
          description: "Tasks in this wave"
          constraints: "No task depends on another in same wave"
        - name: "status"
          type: "WaveStatus"
          description: "Wave execution status"
          constraints: "One of: Pending, Running, Completed, PartialFailed"
        - name: "results"
          type: "map[string]*TaskResult"
          description: "Execution results per task"
          constraints: "Populated after wave execution"
      relationships:
        - target: "TaskNode"
          type: "one-to-many"
          description: "Wave contains multiple tasks"
        - target: "TaskResult"
          type: "one-to-many"
          description: "Wave produces results for each task"

    - name: "ParallelExecutor"
      description: "Orchestrator for concurrent task execution across waves"
      fields:
        - name: "maxParallel"
          type: "int"
          description: "Maximum concurrent Claude sessions"
          constraints: ">=1; default 4; error if <=0"
        - name: "graph"
          type: "*DependencyGraph"
          description: "The task dependency graph"
          constraints: "Must be validated and acyclic"
        - name: "worktreeManager"
          type: "worktree.Manager"
          description: "Git worktree manager for isolation"
          constraints: "Optional; nil if --worktrees not specified"
        - name: "dagRoot"
          type: "string"
          description: "Branch name where worktree changes merge"
          constraints: "Current branch at execution start"
        - name: "failedTasks"
          type: "map[string]error"
          description: "Tasks that failed execution"
          constraints: "Used to skip dependent tasks"
      relationships:
        - target: "DependencyGraph"
          type: "one-to-one"
          description: "Executor operates on one graph"
        - target: "worktree.Manager"
          type: "one-to-one"
          description: "Optional worktree manager"

    - name: "TaskResult"
      description: "Outcome of a single task execution"
      fields:
        - name: "taskID"
          type: "string"
          description: "Task identifier"
          constraints: "Must match task in graph"
        - name: "success"
          type: "bool"
          description: "Whether task completed successfully"
          constraints: "True if Claude session exited 0 and task marked Completed"
        - name: "error"
          type: "error"
          description: "Error message if failed"
          constraints: "Non-nil only when success=false"
        - name: "duration"
          type: "time.Duration"
          description: "Execution time"
          constraints: ">=0"
        - name: "worktreePath"
          type: "string"
          description: "Path to worktree if used"
          constraints: "Empty if worktrees not enabled"
      relationships:
        - target: "TaskNode"
          type: "many-to-one"
          description: "Result belongs to one task"

    - name: "ParallelState"
      description: "Persistent state for parallel execution resume"
      fields:
        - name: "currentWave"
          type: "int"
          description: "Wave currently executing or last attempted"
          constraints: ">=1"
        - name: "taskStates"
          type: "map[string]string"
          description: "Per-task execution state"
          constraints: "Keys are task IDs; values are status strings"
        - name: "failedDependencies"
          type: "map[string][]string"
          description: "Map of skipped tasks to their failed dependencies"
          constraints: "Used for skip messages"
        - name: "startTime"
          type: "time.Time"
          description: "When parallel execution started"
          constraints: "Used for duration calculation"
      relationships:
        - target: "TaskResult"
          type: "one-to-many"
          description: "State tracks results across runs"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "docs/parallel-execution.md"
      description: "User guide for --parallel flag and DAG visualization"
  source_code:
    - path: "internal/dag/"
      description: "DAG computation, wave generation, and graph operations"
    - path: "internal/dag/graph.go"
      description: "DependencyGraph and TaskNode types"
    - path: "internal/dag/waves.go"
      description: "Wave computation algorithm"
    - path: "internal/dag/visualize.go"
      description: "ASCII visualization for autospec dag command"
    - path: "internal/workflow/parallel_executor.go"
      description: "ParallelExecutor for concurrent task execution"
    - path: "internal/cli/util/dag.go"
      description: "autospec dag subcommand implementation"
    - path: "internal/cli/stages/implement.go"
      description: "Extended with --parallel, --max-parallel, --worktrees flags"
  tests:
    - path: "internal/dag/*_test.go"
      description: "Unit tests for DAG computation and visualization"
    - path: "internal/workflow/parallel_executor_test.go"
      description: "Unit tests for parallel execution logic"
    - path: "internal/cli/util/dag_test.go"
      description: "Tests for dag command"

implementation_phases:
  - phase: 1
    name: "DAG Infrastructure"
    goal: "Build dependency graph computation and wave generation with full test coverage"
    deliverables:
      - "internal/dag/graph.go: DependencyGraph, TaskNode types"
      - "internal/dag/waves.go: ComputeWaves() function"
      - "internal/dag/graph_test.go: Comprehensive tests for graph building"
      - "internal/dag/waves_test.go: Tests for wave computation including edge cases"
      - "Benchmark tests verifying <100ms for 100 tasks"

  - phase: 2
    name: "DAG Visualization"
    goal: "Implement ASCII visualization and autospec dag command"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/dag/visualize.go: ASCII tree/box rendering"
      - "internal/cli/util/dag.go: dag subcommand"
      - "internal/dag/visualize_test.go: Tests for visualization output"
      - "internal/cli/util/dag_test.go: Command integration tests"

  - phase: 3
    name: "Parallel Executor Core"
    goal: "Implement concurrent task execution with errgroup coordination"
    dependencies:
      - "Phase 1"
    deliverables:
      - "internal/workflow/parallel_executor.go: ParallelExecutor type"
      - "Wave-by-wave execution with max-parallel limiting"
      - "Graceful failure handling (continue siblings, skip dependents)"
      - "internal/workflow/parallel_executor_test.go: Comprehensive tests"

  - phase: 4
    name: "CLI Integration"
    goal: "Add --parallel, --max-parallel, --dry-run, --worktrees flags to implement command"
    dependencies:
      - "Phase 3"
    deliverables:
      - "Extended implement command with new flags"
      - "Mutual exclusivity with --tasks and --phases"
      - "Integration with orchestrator dispatch"
      - "User prompts for worktree warning and resume options"

  - phase: 5
    name: "Worktree Integration"
    goal: "Enable git worktree isolation for parallel tasks"
    dependencies:
      - "Phase 3"
      - "Phase 4"
    deliverables:
      - "Worktree creation per parallel task"
      - "Sequential merge into DAG-ROOT branch after wave"
      - "Conflict detection with user pause"
      - "Worktree cleanup after successful merge"

  - phase: 6
    name: "Progress Display and Polish"
    goal: "Real-time progress updates and execution state persistence"
    dependencies:
      - "Phase 4"
    deliverables:
      - "Single-line updating status display"
      - "Parallel execution state in retry.json"
      - "Resume logic with R/W/S/A prompt"
      - "Documentation in docs/parallel-execution.md"

risks:
  - risk: "Git worktree conflicts during parallel merge"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Sequential merge strategy; pause on conflict for user resolution; provide clear conflict instructions"

  - risk: "Claude session resource exhaustion with high max-parallel"
    likelihood: "low"
    impact: "high"
    mitigation: "Default max-parallel of 4; warning if >8; allow user override"

  - risk: "Race conditions in task status updates"
    likelihood: "medium"
    impact: "medium"
    mitigation: "Mutex-protected status updates; atomic file writes for retry.json"

  - risk: "Complex DAG edge cases not covered"
    likelihood: "low"
    impact: "medium"
    mitigation: "Comprehensive test suite including diamond dependencies, single chains, all-parallel, and cycle detection"

  - risk: "Terminal compatibility for ANSI progress display"
    likelihood: "low"
    impact: "low"
    mitigation: "Graceful degradation to line-by-line output if terminal doesn't support carriage return"

open_questions:
  - question: "Should --worktrees be the default for --parallel?"
    context: "Worktrees prevent file conflicts but add complexity; spec says prompt user without worktrees"
    proposed_resolution: "Keep opt-in with warning prompt; users can set implement_worktrees=true in config"

  - question: "How to handle --from-task with --parallel?"
    context: "Spec mentions starting from wave containing task; need to clarify wave recalculation"
    proposed_resolution: "Recalculate waves from remaining tasks; start from wave containing specified task"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-20T01:46:17Z"
  artifact_type: "plan"
