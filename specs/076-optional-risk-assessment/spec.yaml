feature:
    branch: "076-optional-risk-assessment"
    created: "2026-01-01"
    status: "Completed"
    completed_at: 2026-01-01T21:05:56Z
    input: "implement .dev/tasks/optional-risk-assessment.md"
user_stories:
    - id: "US-001"
      title: "Disable risk assessment by default"
      priority: "P1"
      as_a: "CLI user"
      i_want: "risk assessment to be disabled by default when generating plan.yaml"
      so_that: "I avoid cognitive overhead and token usage for simple features that don't need formal risk analysis"
      why_this_priority: "Core functionality - this is the main purpose of the feature"
      independent_test: "Run plan generation with default config and verify no risks section appears"
      acceptance_scenarios:
        - given: "A project with default configuration (no enable_risk_assessment setting)"
          when: "I run the plan stage"
          then: "The generated plan.yaml does not contain a risks section"
        - given: "A project with enable_risk_assessment: false explicitly set"
          when: "I run the plan stage"
          then: "The generated plan.yaml does not contain a risks section"
    - id: "US-002"
      title: "Opt-in to risk assessment via config"
      priority: "P1"
      as_a: "CLI user working on complex features"
      i_want: "to enable risk assessment through configuration"
      so_that: "I get formal risk analysis when I need it for high-impact features"
      why_this_priority: "Core functionality - provides the opt-in mechanism"
      independent_test: "Set enable_risk_assessment: true in config and verify risks section appears"
      acceptance_scenarios:
        - given: "A project with enable_risk_assessment: true in .autospec/config.yml"
          when: "I run the plan stage"
          then: "The generated plan.yaml includes a risks section with proper schema"
        - given: "A user config with enable_risk_assessment: true in ~/.config/autospec/config.yml"
          when: "I run the plan stage in a project without local config override"
          then: "The generated plan.yaml includes a risks section"
    - id: "US-003"
      title: "Visual indicator for risk assessment injection"
      priority: "P2"
      as_a: "CLI user in verbose mode"
      i_want: "to see when risk assessment instructions are being injected"
      so_that: "I understand what prompts are being sent to the AI"
      why_this_priority: "Useful for debugging but not essential for core functionality"
      independent_test: "Run with verbose output and verify [+RiskAssessment] indicator appears when enabled"
      acceptance_scenarios:
        - given: "enable_risk_assessment: true is configured"
          when: "I run the plan stage with verbose output"
          then: "I see a [+RiskAssessment] indicator showing the injection"
        - given: "enable_risk_assessment: false (default)"
          when: "I run the plan stage with verbose output"
          then: "No [+RiskAssessment] indicator appears"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST add EnableRiskAssessment bool field to Config struct with mapstructure tag"
          testable: true
          acceptance_criteria: "Config struct has EnableRiskAssessment field that parses from enable_risk_assessment YAML key"
        - id: "FR-002"
          description: "MUST set enable_risk_assessment default to false in config defaults"
          testable: true
          acceptance_criteria: "New configs without explicit setting have EnableRiskAssessment=false"
        - id: "FR-003"
          description: "MUST create BuildRiskAssessmentInstructions() function following InjectableInstruction pattern"
          testable: true
          acceptance_criteria: "Function returns InjectableInstruction with Name, DisplayHint, and Content fields"
        - id: "FR-004"
          description: "MUST create InjectRiskAssessment(command, enabled) function that conditionally injects"
          testable: true
          acceptance_criteria: "Returns unmodified command when disabled; returns command with risk instructions appended when enabled"
        - id: "FR-005"
          description: "MUST remove risks section from embedded autospec.plan.md template"
          testable: true
          acceptance_criteria: "Template no longer contains risks: schema fragment"
        - id: "FR-006"
          description: "MUST inject risk assessment instructions in buildPlanCommand when config enables it"
          testable: true
          acceptance_criteria: "Plan command includes risk instructions when EnableRiskAssessment=true"
        - id: "FR-007"
          description: "MUST update docs/risks.md with opt-in documentation"
          testable: true
          acceptance_criteria: "Documentation explains how to enable risk assessment via config"
        - id: "FR-008"
          description: "MUST update docs/reference.md with enable_risk_assessment config option"
          testable: true
          acceptance_criteria: "Config reference includes enable_risk_assessment with description and default"
        - id: "FR-009"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-002"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern"
          measurable_target: "All new test functions use map[string]struct pattern"
        - id: "NFR-004"
          category: "code_quality"
          description: "Accept interfaces, return concrete types"
          measurable_target: "Function signatures follow interface-in, concrete-out pattern where applicable"
        - id: "NFR-005"
          category: "maintainability"
          description: "Follow existing injection pattern from autocommit.go"
          measurable_target: "Risk assessment injection uses same InjectableInstruction pattern"
        - id: "NFR-006"
          category: "compatibility"
          description: "Backward compatible with existing configs"
          measurable_target: "Configs without enable_risk_assessment work unchanged"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "Default plan generation produces output without risks section"
          metric: "Plan.yaml content inspection"
          target: "Zero occurrences of risks: key in default-generated plan.yaml"
        - id: "SC-002"
          description: "Enabled plan generation produces output with risks section"
          metric: "Plan.yaml content inspection"
          target: "Valid risks: section present when config enabled"
        - id: "SC-003"
          description: "Validation accepts plans with or without risks"
          metric: "autospec artifact command exit code"
          target: "Exit code 0 for both cases"
        - id: "SC-004"
          description: "Injection indicator visible in verbose mode when enabled"
          metric: "CLI output inspection"
          target: "[+RiskAssessment] appears in verbose output when enabled"
        - id: "SC-005"
          description: "Documentation is complete and accurate"
          metric: "Documentation review"
          target: "Both docs/risks.md and docs/reference.md updated with config option"
key_entities:
    - name: "EnableRiskAssessment config field"
      description: "Boolean configuration option controlling risk assessment injection"
      attributes:
        - "Type: bool"
        - "Default: false"
        - "YAML key: enable_risk_assessment"
    - name: "InjectableInstruction"
      description: "Struct pattern for conditional instruction injection"
      attributes:
        - "Name: identifier for the injection"
        - "DisplayHint: user-friendly description"
        - "Content: actual instruction text"
    - name: "Risk assessment instructions"
      description: "The injected content describing risk schema and guidance"
      attributes:
        - "YAML schema for risks section"
        - "Guidance on risk categories to consider"
        - "Note to skip for trivial features"
edge_cases:
    - scenario: "Config has invalid value type for enable_risk_assessment"
      expected_behavior: "Config parsing fails with clear error message"
    - scenario: "Both user and project config specify conflicting enable_risk_assessment values"
      expected_behavior: "Project config takes precedence per priority rules"
    - scenario: "Environment variable AUTOSPEC_ENABLE_RISK_ASSESSMENT is set"
      expected_behavior: "Environment variable takes highest precedence"
    - scenario: "Plan template is missing (embedded template corruption)"
      expected_behavior: "Build fails at compile time since templates are embedded"
assumptions:
    - "Existing InjectableInstruction pattern in autocommit.go is stable and appropriate for reuse"
    - "The risks: section in plan.yaml validation schema is already optional"
    - "Users who want risk assessment will configure it once at project or user level"
    - "YAML key naming follows existing snake_case convention (enable_risk_assessment)"
constraints:
    - "Must not modify embedded templates in ways that make them project-specific (constitution principle)"
    - "Must follow existing injection pattern for consistency"
    - "Must maintain backward compatibility with existing configs and generated plans"
    - "Risk instructions must be self-contained (template remains agnostic)"
out_of_scope:
    - "CLI flag to enable/disable risk assessment per-invocation (config only)"
    - "Different risk templates for different project types"
    - "Risk assessment for other stages (specify, tasks)"
    - "Integration with external risk management tools"
    - "Risk severity calculations or scoring"
    - "Automatic risk detection based on code analysis"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec 0.7.3"
    created: "2026-01-01T20:32:33Z"
    artifact_type: "spec"
