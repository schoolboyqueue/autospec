feature:
  branch: "048-file-read-discipline"
  created: "2025-12-18"
  status: "Draft"
  input: |
    Add file reading discipline section to internal/commands/autospec.implement.md template. This addresses a CRITICAL issue where Claude reads the same file 5-23 times per session, wasting 30-50K tokens.

    ## Problem Statement
    Analysis of 29 autospec sessions revealed extreme file re-reading:
    - preflight_test.go read 18 times in one session
    - workflow.go read 16 times in one session
    - parse-claude-conversation.sh read 14 times in one session
    - schema_validation.go read 6-7 times in sessions

    Claude does not recognize that file contents remain in its context window after the initial Read tool call.

    ## Required Changes
    Add a new section to internal/commands/autospec.implement.md after the context loading section:

    ### Section Title: 'CRITICAL: File Reading Discipline'

    ### Content to Add:
    1. 'Read Once, Remember Forever' rule block
    2. Maximum File Read Counts table
    3. 'Pre-Task File Discovery' protocol
    4. Explicit prohibitions

user_stories:
  - id: "US-001"
    title: "Reduce Token Waste from Redundant File Reads"
    priority: "P1"
    as_a: "developer using autospec implement"
    i_want: "Claude to read each file only once per session (with minimal exceptions)"
    so_that: "I save 30-50K tokens per session and get faster, more cost-effective implementation runs"
    why_this_priority: "This is the highest-impact efficiency fix identified - affects every implementation session"
    independent_test: "Run an implementation session and count Read tool calls per unique file"
    acceptance_scenarios:
      - given: "The implement.md template contains the file reading discipline section"
        when: "Claude executes an implementation workflow"
        then: "Claude reads each file at most twice (initial read + post-edit verification)"
      - given: "Claude has already read a file during the current session"
        when: "Claude needs to reference content from that file"
        then: "Claude references the content from context instead of re-reading the file"
      - given: "Claude is about to start implementation of multiple tasks"
        when: "Claude begins the implementation phase"
        then: "Claude identifies and reads all required files once upfront"

  - id: "US-002"
    title: "Clear Guidance on File Reading Limits"
    priority: "P1"
    as_a: "Claude agent executing the implement workflow"
    i_want: "explicit rules about when and how many times I can read files"
    so_that: "I have clear guidelines to follow and can avoid wasteful re-reading patterns"
    why_this_priority: "Without explicit limits, Claude defaults to cautious re-reading behavior"
    independent_test: "Review the implement.md template for presence of maximum read count guidance"
    acceptance_scenarios:
      - given: "The implement.md template exists"
        when: "I look for file reading guidance"
        then: "I find a table showing maximum read counts for different scenarios"
      - given: "I am unsure if I need to re-read a file"
        when: "I consult the file reading discipline section"
        then: "I find explicit prohibitions telling me not to re-read"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST add a 'CRITICAL: File Reading Discipline' section to internal/commands/autospec.implement.md"
      testable: true
      acceptance_criteria: "Section exists in the template with the exact heading 'CRITICAL: File Reading Discipline'"

    - id: "FR-002"
      description: "MUST include a 'Read Once, Remember Forever' rule block explaining that file contents persist in context"
      testable: true
      acceptance_criteria: "Section contains explanation that Read tool results remain in context window"

    - id: "FR-003"
      description: "MUST include a Maximum File Read Counts table with scenarios and limits"
      testable: true
      acceptance_criteria: "Table exists with columns: Scenario, Max Reads; includes rows for understanding (1), editing (2), referencing (0), debugging (2)"

    - id: "FR-004"
      description: "MUST include a Pre-Task File Discovery protocol"
      testable: true
      acceptance_criteria: "Section contains numbered protocol steps for identifying files upfront, reading once, and noting line numbers"

    - id: "FR-005"
      description: "MUST include explicit prohibitions against common re-reading patterns"
      testable: true
      acceptance_criteria: "Section contains DO NOT directives for: re-reading 'to make sure', re-reading when switching tasks, grep-then-read-then-grep patterns"

    - id: "FR-006"
      description: "MUST position the section prominently after the context loading step (step 3)"
      testable: true
      acceptance_criteria: "New section appears as step 4 (or 3.5/3a) immediately after 'Load and analyze the implementation context'"

    - id: "FR-007"
      description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
      testable: true
      acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"

  non_functional:
    - id: "NFR-001"
      category: "usability"
      description: "Section must be scannable with clear visual hierarchy"
      measurable_target: "Uses headers, bullet points, tables, and checkmark/X formatting"

    - id: "NFR-002"
      category: "usability"
      description: "Section must use warning/critical styling to emphasize importance"
      measurable_target: "Contains CRITICAL keyword in heading; uses bold for prohibitions"

    - id: "NFR-003"
      category: "maintainability"
      description: "Change is template-only with no Go code modifications required"
      measurable_target: "Only internal/commands/autospec.implement.md is modified"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Implementation sessions show reduced file re-reading"
      metric: "Maximum Read tool calls per unique file in a session"
      target: "At most 2 reads per file (down from 5-23)"

    - id: "SC-002"
      description: "Token usage per implementation session decreases"
      metric: "Estimated token savings per session"
      target: "30-50K fewer tokens per session"

    - id: "SC-003"
      description: "File reading discipline guidance is present and complete"
      metric: "All required components present in implement.md"
      target: "100% of FR-001 through FR-006 acceptance criteria met"

key_entities:
  - name: "implement.md template"
    description: "The slash command template that guides Claude through implementation workflows"
    attributes:
      - "Located at internal/commands/autospec.implement.md"
      - "Contains numbered steps for implementation workflow"
      - "Processed by Claude Code as a slash command"

  - name: "File Reading Discipline Section"
    description: "New section to be added containing rules and guidance for file reading"
    attributes:
      - "Read Once Remember Forever rule"
      - "Maximum File Read Counts table"
      - "Pre-Task File Discovery protocol"
      - "Explicit prohibitions list"

edge_cases:
  - scenario: "File is modified externally during session"
    expected_behavior: "Guidance allows one re-read after external modification notification"

  - scenario: "Claude makes changes to a file and needs to verify"
    expected_behavior: "Post-edit verification counts as the second (allowed) read"

  - scenario: "Very large file where only a portion was initially read"
    expected_behavior: "Reading additional portions of the same file counts toward the limit"

  - scenario: "Test failure requires re-reading test file and implementation file"
    expected_behavior: "Debugging scenario allows up to 2 reads per file"

assumptions:
  - "Claude Code's Read tool results persist in the context window for the entire session"
  - "Session analysis data showing 5-23 reads per file is accurate and representative"
  - "Adding explicit guidance in the template will influence Claude's file reading behavior"
  - "The implement.md template is the primary mechanism for guiding Claude's implementation workflow"

constraints:
  - "Template change only - no modifications to Go source code"
  - "Must integrate with existing template structure without breaking other steps"
  - "Section must be scannable/skimmable, not a wall of text"
  - "Must use markdown formatting compatible with Claude Code rendering"

out_of_scope:
  - "Enforcing file read limits programmatically (this is guidance only)"
  - "Changes to other slash command templates"
  - "Token counting or tracking implementation"
  - "Changes to the autospec CLI code"
  - "Automated validation of file read counts"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-18T07:35:36Z"
  artifact_type: "spec"
