feature:
    branch: "057-fix-description-propagation"
    created: "2025-12-18"
    status: "Completed"
    completed_at: 2025-12-18T23:47:44Z
    input: |
        When running `autospec run -a "feature description"`, the description argument is passed to
        all four core stages (specify, plan, tasks, implement), not just the specify stage. This is
        inconsistent with `autospec all` which correctly only passes description to specify. The fix
        ensures `-a` behaves like `all` - description only to specify. Direct commands and individual
        stage runs continue to work as intended with stage-specific hints.
user_stories:
    - id: "US-001"
      title: "Full workflow with feature description"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "to run `autospec run -a \"feature description\"` and have the description only passed to the specify stage"
      so_that: "later stages (plan, tasks, implement) work from refined artifacts rather than raw input, preventing conflicts and incorrect implementations"
      why_this_priority: "Core bug fix - current behavior causes Claude to potentially ignore structured workflow artifacts in favor of original description"
      independent_test: "Run `autospec run -a \"add auth\"` and verify via logging or inspection that plan/tasks/implement receive empty prompts"
      acceptance_scenarios:
        - given: "a user runs `autospec run -a \"add user authentication\"`"
          when: "the workflow executes all four core stages"
          then: "only the specify stage receives the description; plan, tasks, and implement receive empty strings"
        - given: "a user runs `autospec run -a \"add auth using Firebase\"`"
          when: "the specify stage creates a spec that changes approach (e.g., to JWT)"
          then: "the implement stage follows the spec/plan artifacts, not the original Firebase mention"
    - id: "US-002"
      title: "Individual stage hint via run command"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "to run `autospec run -p \"focus on security\"` and have the hint passed to the plan stage"
      so_that: "I can provide stage-specific guidance when running individual stages"
      why_this_priority: "Must verify that the fix does not regress individual stage functionality"
      independent_test: "Run `autospec run -p \"security focus\"` and verify plan stage receives the hint"
      acceptance_scenarios:
        - given: "a user runs `autospec run -p \"focus on security\"`"
          when: "the plan stage executes"
          then: "the plan stage receives \"focus on security\" as its prompt"
        - given: "a user runs `autospec run -t \"prioritize P1\"`"
          when: "the tasks stage executes"
          then: "the tasks stage receives \"prioritize P1\" as its prompt"
        - given: "a user runs `autospec run -i \"skip docs\"`"
          when: "the implement stage executes"
          then: "the implement stage receives \"skip docs\" as its prompt"
    - id: "US-003"
      title: "Multiple stage hints via run command"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "to run `autospec run -ti \"focus on tests\"` and have the hint passed to both tasks and implement stages"
      so_that: "I can provide guidance to multiple selected stages"
      why_this_priority: "Must verify multi-stage selection continues to work with hints"
      independent_test: "Run `autospec run -ti \"test focus\"` and verify both stages receive the hint"
      acceptance_scenarios:
        - given: "a user runs `autospec run -ti \"focus on tests\"`"
          when: "the tasks and implement stages execute"
          then: "both stages receive \"focus on tests\" as their prompts"
        - given: "a user runs `autospec run -pt \"security and coverage\"`"
          when: "the plan and tasks stages execute"
          then: "both stages receive \"security and coverage\" as their prompts"
    - id: "US-004"
      title: "Explicit stage selection with describe"
      priority: "P2"
      as_a: "developer using autospec"
      i_want: "to run `autospec run -spt \"add auth\"` with explicit stage flags and have the description propagate to all selected stages"
      so_that: "my explicit stage selection is honored (unlike `-a` which has smart behavior)"
      why_this_priority: "Edge case - explicit selection should honor user intent"
      independent_test: "Run `autospec run -spt \"desc\"` and verify all three stages receive the description"
      acceptance_scenarios:
        - given: "a user explicitly selects stages with `autospec run -spt \"add auth\"`"
          when: "the workflow executes specify, plan, and tasks"
          then: "all three stages receive \"add auth\" as their prompts (explicit selection honored)"
        - given: "a user explicitly selects stages with `autospec run -sp \"add auth\"`"
          when: "the workflow executes specify and plan"
          then: "both stages receive \"add auth\" as their prompts"
    - id: "US-005"
      title: "Behavior parity between run -a and all"
      priority: "P1"
      as_a: "developer using autospec"
      i_want: "`autospec run -a \"desc\"` and `autospec all \"desc\"` to behave identically regarding description propagation"
      so_that: "the documented equivalence between these commands is accurate"
      why_this_priority: "Documentation states these are equivalent; they must behave the same"
      independent_test: "Run both commands with same description and compare which stages receive prompts"
      acceptance_scenarios:
        - given: "a user runs `autospec all \"add auth\"`"
          when: "the full workflow executes"
          then: "only specify receives description; plan, tasks, implement receive empty strings"
        - given: "a user runs `autospec run -a \"add auth\"`"
          when: "the full workflow executes"
          then: "only specify receives description; plan, tasks, implement receive empty strings (matching `all` behavior)"
requirements:
    functional:
        - id: "FR-001"
          description: "MUST add `isFullWorkflow` field to `stageExecutionContext` struct in run.go to track when `-a` flag is used"
          testable: true
          acceptance_criteria: "Field exists and is set to true when `-a` flag triggers `stageConfig.SetAll()`, false otherwise"
        - id: "FR-002"
          description: "MUST modify `executePlan` method to pass empty string when `isFullWorkflow` is true, otherwise pass `featureDescription`"
          testable: true
          acceptance_criteria: "Plan stage receives empty prompt when running with `-a`, receives description when running with `-p` flag"
        - id: "FR-003"
          description: "MUST modify `executeTasks` method to pass empty string when `isFullWorkflow` is true, otherwise pass `featureDescription`"
          testable: true
          acceptance_criteria: "Tasks stage receives empty prompt when running with `-a`, receives description when running with `-t` flag"
        - id: "FR-004"
          description: "MUST modify `executeImplement` method to pass empty string when `isFullWorkflow` is true, otherwise pass `featureDescription`"
          testable: true
          acceptance_criteria: "Implement stage receives empty prompt when running with `-a`, receives description when running with `-i` flag"
        - id: "FR-005"
          description: "MUST preserve current behavior for individual stage flags (`-p`, `-t`, `-i`) passing prompts to selected stages"
          testable: true
          acceptance_criteria: "Running `autospec run -p \"hint\"` passes \"hint\" to plan stage"
        - id: "FR-006"
          description: "MUST preserve current behavior for multi-stage flags (`-ti`, `-pt`) passing prompts to all selected stages"
          testable: true
          acceptance_criteria: "Running `autospec run -ti \"hint\"` passes \"hint\" to both tasks and implement stages"
        - id: "FR-007"
          description: "SHOULD add clarifying notes to command templates (plan.md, tasks.md, implement.md) explaining that $ARGUMENTS is for stage hints, not feature descriptions"
          testable: true
          acceptance_criteria: "Templates include notes about using artifacts as primary sources when $ARGUMENTS looks like a feature description"
        - id: "FR-008"
          description: "MUST pass all quality gates: make test, make fmt, make lint, and make build"
          testable: true
          acceptance_criteria: "All commands exit 0; no test failures, format changes, lint errors, or build failures"
    non_functional:
        - id: "NFR-001"
          category: "code_quality"
          description: "All functions must be under 40 lines; extract helpers for complex logic"
          measurable_target: "No function exceeds 40 lines excluding comments"
        - id: "NFR-002"
          category: "code_quality"
          description: "All errors must be wrapped with context using fmt.Errorf(\"doing X: %w\", err)"
          measurable_target: "Zero bare 'return err' statements in new code"
        - id: "NFR-003"
          category: "code_quality"
          description: "Tests must use map-based table-driven pattern with t.Parallel()"
          measurable_target: "All new test functions use map[string]struct pattern and call t.Parallel()"
        - id: "NFR-004"
          category: "reliability"
          description: "Fix must be backward compatible with existing workflows (explicit stage selection still works)"
          measurable_target: "No breaking changes to documented CLI behavior for non -a flag usage"
        - id: "NFR-005"
          category: "maintainability"
          description: "New logic must be clearly documented with comments explaining the semantic difference between feature description and stage hint"
          measurable_target: "Key decision points in code have explanatory comments"
success_criteria:
    measurable_outcomes:
        - id: "SC-001"
          description: "`autospec run -a` and `autospec all` exhibit identical description propagation behavior"
          metric: "Both commands pass description only to specify stage"
          target: "100% parity between commands for description handling"
        - id: "SC-002"
          description: "Individual stage runs still receive hints correctly"
          metric: "Prompt received by stage matches CLI argument"
          target: "All individual stage flags (-s, -p, -t, -i) pass argument to selected stage"
        - id: "SC-003"
          description: "Multi-stage selections still receive hints correctly"
          metric: "Prompt received by each stage matches CLI argument"
          target: "All multi-stage flag combinations (-ti, -pt, etc.) pass argument to all selected stages"
        - id: "SC-004"
          description: "All new tests pass and cover the key scenarios"
          metric: "Test coverage for description propagation logic"
          target: "Tests exist and pass for: -a flag, individual flags, multi-flag combinations"
key_entities:
    - name: "stageExecutionContext"
      description: "Context struct holding state for stage execution in run.go"
      attributes:
        - "featureDescription: the user-provided argument"
        - "isFullWorkflow: new field indicating if -a flag was used"
        - "orchestrator: handles actual stage execution"
        - "specName: the feature spec name"
    - name: "stageConfig"
      description: "Configuration struct tracking which stages are selected"
      attributes:
        - "specify, plan, tasks, implement: boolean flags"
        - "SetAll(): method that sets all core stages to true"
    - name: "featureDescription"
      description: "The user-provided argument passed to autospec run"
      attributes:
        - "For -a: initial feature description (only for specify)"
        - "For individual flags: stage-specific hint (for selected stages)"
edge_cases:
    - scenario: "User runs `autospec run -a` with empty description"
      expected_behavior: "All stages receive empty strings (specify gets empty, others get empty - no change in behavior)"
    - scenario: "User runs `autospec run -sptai` mixing explicit and -a flags"
      expected_behavior: "-a flag behavior takes precedence - description only to specify (since -a implies full workflow intent)"
    - scenario: "User runs `autospec run -sp` with description (explicit specify + plan)"
      expected_behavior: "Both stages receive description (explicit selection honored, not using -a)"
    - scenario: "User previously relied on description propagating to all stages with -a"
      expected_behavior: "Behavior changes - this is documented as a breaking change that aligns -a with `all` command behavior"
assumptions:
    - "The `stageConfig.SetAll()` method is called only when the -a flag is used"
    - "The current `all` command behavior (description only to specify) is the correct/intended behavior"
    - "Users who need hints for later stages can run individual stages separately"
    - "No users are intentionally relying on the current -a description propagation behavior"
constraints:
    - "Must not modify the `all` command behavior (it already works correctly)"
    - "Must not break individual stage commands (autospec plan, autospec implement, etc.)"
    - "Must maintain backward compatibility for explicit stage flag combinations"
    - "Changes limited to run.go and related test files for the core fix"
out_of_scope:
    - "Adding a `--propagate-description` backward compatibility flag (only if users complain)"
    - "Modifying the `all` command implementation (already correct)"
    - "Changing direct command behavior (autospec plan, autospec implement, etc.)"
    - "Modifying optional stage handling (clarify, checklist, analyze, constitution)"
    - "Performance optimizations unrelated to the bug fix"
_meta:
    version: "1.0.0"
    generator: "autospec"
    generator_version: "autospec dev"
    created: "2025-12-18T23:36:37Z"
    artifact_type: "spec"
