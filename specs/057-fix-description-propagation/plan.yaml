plan:
  branch: "057-fix-description-propagation"
  created: "2025-12-18"
  spec_path: "specs/057-fix-description-propagation/spec.yaml"

summary: |
  This fix aligns the `autospec run -a` command with `autospec all` by ensuring the feature
  description is only passed to the specify stage. The current bug propagates the description
  to all stages (plan, tasks, implement), which can cause Claude to ignore the structured
  artifacts in favor of the original description.

  The implementation adds an `isFullWorkflow` boolean field to `stageExecutionContext` that
  tracks when `-a` is used. Each execute method (executePlan, executeTasks, executeImplement)
  checks this field and passes an empty string when true, matching the behavior of `all`.

technical_context:
  language: "Go"
  framework: "Cobra CLI"
  primary_dependencies:
    - name: "github.com/spf13/cobra"
      version: "v1.8.0"
      purpose: "CLI framework for command parsing and flag handling"
  storage: "None"
  testing:
    framework: "Go testing package"
    approach: "Map-based table-driven tests with t.Parallel()"
  target_platform: "Linux, macOS, Windows"
  project_type: "cli"
  performance_goals: "No additional latency - simple boolean check"
  constraints:
    - "Must not break existing individual stage flags (-p, -t, -i)"
    - "Must maintain backward compatibility for explicit stage combinations"
    - "Changes limited to run.go and test files"
  scale_scope: "Single file modification with focused unit tests"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "New tests will be written for description propagation scenarios before implementation"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "This fix affects command execution, not artifact validation"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Single boolean check adds negligible overhead"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "N/A"
      notes: "Fix does not affect retry behavior"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Will use error wrapping, keep functions under 40 lines, use map-based tests"
    - name: "Command Template Independence (PRIN-012)"
      status: "PASS"
      notes: "FR-007 template notes use generic language; no prohibited patterns"

research_findings:
  decisions:
    - topic: "How to track when -a flag is used"
      decision: "Add isFullWorkflow boolean field to stageExecutionContext"
      rationale: "Clean, explicit field that clearly conveys intent; set at construction time when -a triggers SetAll()"
      alternatives_considered:
        - "Check if all core stages are selected via stageConfig.IsAllCoreStages()"
        - "Add a flag to stageConfig itself"
    - topic: "Where to check isFullWorkflow"
      decision: "In each execute method (executePlan, executeTasks, executeImplement)"
      rationale: "Keeps the logic local to where prompts are passed; easy to understand and test"
      alternatives_considered:
        - "Centralize in executeStages function"
        - "Modify featureDescription at context creation time"
    - topic: "Template updates for $ARGUMENTS guidance"
      decision: "Add clarifying notes to plan.md, tasks.md, implement.md templates"
      rationale: "Documents expected usage and helps Claude distinguish feature descriptions from stage hints"
      alternatives_considered:
        - "Skip template updates (lower priority SHOULD requirement)"

data_model:
  entities:
    - name: "stageExecutionContext"
      description: "Context struct holding state for stage execution in run.go"
      fields:
        - name: "orchestrator"
          type: "*workflow.WorkflowOrchestrator"
          description: "Handles actual stage execution"
          constraints: "Required, non-nil"
        - name: "notificationHandler"
          type: "*notify.Handler"
          description: "Handles command notifications"
          constraints: "May be nil"
        - name: "featureDescription"
          type: "string"
          description: "User-provided argument (feature description or stage hint)"
          constraints: "May be empty"
        - name: "isFullWorkflow"
          type: "bool"
          description: "NEW: True when -a flag triggered SetAll(), indicating description should only go to specify"
          constraints: "Set at context creation time"
        - name: "resume"
          type: "bool"
          description: "Whether to resume interrupted implementation"
          constraints: "Only relevant for implement stage"
        - name: "implementMethod"
          type: "string"
          description: "Method for running implement (single-session, phases, tasks)"
          constraints: "One of: single-session, phases, tasks"
        - name: "specName"
          type: "string"
          description: "Name of the feature spec (e.g., 007-yaml-output)"
          constraints: "Set after specify stage completes"
        - name: "specDir"
          type: "string"
          description: "Full path to spec directory"
          constraints: "Set after specify stage completes"
        - name: "ranImplement"
          type: "bool"
          description: "Tracks if implement stage ran for summary"
          constraints: "Set by executeImplement"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "specs/057-fix-description-propagation/"
      description: "Feature specification, plan, and tasks for this fix"
  source_code:
    - path: "internal/cli/run.go"
      description: "Primary file to modify - add isFullWorkflow field and conditional logic"
    - path: "internal/commands/plan.md"
      description: "Template to update with $ARGUMENTS guidance (optional)"
    - path: "internal/commands/tasks.md"
      description: "Template to update with $ARGUMENTS guidance (optional)"
    - path: "internal/commands/implement.md"
      description: "Template to update with $ARGUMENTS guidance (optional)"
  tests:
    - path: "internal/cli/run_test.go"
      description: "Add tests for description propagation with -a flag and individual flags"

implementation_phases:
  - phase: 1
    name: "Core Fix - Add isFullWorkflow tracking"
    goal: "Add the isFullWorkflow field and implement conditional description propagation"
    deliverables:
      - "Add isFullWorkflow bool field to stageExecutionContext struct"
      - "Modify executeStages to set isFullWorkflow=true when -a flag is used"
      - "Modify executePlan to pass empty string when isFullWorkflow=true"
      - "Modify executeTasks to pass empty string when isFullWorkflow=true"
      - "Modify executeImplement to pass empty string when isFullWorkflow=true"
  - phase: 2
    name: "Testing - Verify description propagation"
    goal: "Add comprehensive tests for all description propagation scenarios"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Test: -a flag propagates description only to specify"
      - "Test: individual -p flag propagates description to plan"
      - "Test: individual -t flag propagates description to tasks"
      - "Test: individual -i flag propagates description to implement"
      - "Test: combined -ti flags propagate description to both tasks and implement"
      - "Test: explicit -spt flags propagate description to all selected stages"
  - phase: 3
    name: "Template Documentation (Optional)"
    goal: "Add clarifying notes to templates about $ARGUMENTS usage"
    dependencies:
      - "Phase 1"
    deliverables:
      - "Update plan.md template with $ARGUMENTS guidance"
      - "Update tasks.md template with $ARGUMENTS guidance"
      - "Update implement.md template with $ARGUMENTS guidance"

risks:
  - risk: "Breaking change for users relying on current -a behavior"
    likelihood: "low"
    impact: "medium"
    mitigation: "Document as intentional fix aligning -a with documented all command behavior"
  - risk: "Edge case with mixing -a and explicit stage flags"
    likelihood: "low"
    impact: "low"
    mitigation: "Spec defines -a takes precedence; add test for edge case"

open_questions:
  - question: "Should we log when description is suppressed for debugging?"
    context: "Users might want visibility into why later stages don't receive input"
    proposed_resolution: "Add debug log line when isFullWorkflow causes empty string to be passed"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-18T23:38:25Z"
  artifact_type: "plan"
