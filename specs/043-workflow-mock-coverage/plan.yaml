plan:
  branch: "043-workflow-mock-coverage"
  created: "2025-12-18"
  spec_path: "specs/043-workflow-mock-coverage/spec.yaml"

summary: |
  This plan addresses the 79.4% → 85% test coverage gap in internal/workflow/ by targeting
  functions with 0% coverage (PromptUserToContinue, runPreflightChecks, executeAndVerifyTask,
  executeSingleTaskSession, executeSinglePhaseSession) and those with <60% coverage (executeTaskLoop,
  startProgressDisplay, CleanupContextFile).

  The primary finding from spec research is that existing tests don't actually call the target
  functions—they test string formatting instead. The approach is three-phased: Phase 1 writes
  integration tests that actually invoke methods using the existing MockClaudeExecutor and
  newTestOrchestratorWithSpecName() infrastructure. Phase 2 introduces minimal interface refactoring
  for stdin/preflight testability via dependency injection. Phase 3 covers edge cases and error paths.

technical_context:
  language: "Go"
  framework: "None"
  primary_dependencies:
    - name: "testing"
      version: "stdlib"
      purpose: "Go test framework"
    - name: "github.com/ariel-frischer/autospec/internal/validation"
      version: "internal"
      purpose: "Task and phase validation utilities"
    - name: "github.com/ariel-frischer/autospec/internal/config"
      version: "internal"
      purpose: "Configuration management"
    - name: "github.com/ariel-frischer/autospec/internal/spec"
      version: "internal"
      purpose: "Spec detection and metadata"
    - name: "github.com/ariel-frischer/autospec/internal/retry"
      version: "internal"
      purpose: "Retry state management"
  storage: "Filesystem (temporary directories for tests)"
  testing:
    framework: "testing (Go stdlib)"
    approach: "Map-based table-driven unit tests with integration tests using mock-claude.sh and MockClaudeExecutor"
  target_platform: "linux, darwin, windows"
  project_type: "cli"
  performance_goals: "Tests complete in <5 seconds each"
  constraints:
    - "Cannot use t.Parallel() in tests using t.Setenv()"
    - "Must maintain backward compatibility with existing public API"
    - "Interface injection must be optional (nil-safe)"
  scale_scope: "Internal package test coverage improvement"

constitution_check:
  constitution_path: ".autospec/memory/constitution.yaml"
  gates:
    - name: "Test-First Development (PRIN-001)"
      status: "PASS"
      notes: "This feature is entirely about adding tests; tests define expected behavior"
    - name: "Validation-First Workflow (PRIN-002)"
      status: "N/A"
      notes: "Not a workflow phase transition; internal test improvement"
    - name: "Performance Standards (PRIN-003)"
      status: "PASS"
      notes: "Tests must complete in <5 seconds per NFR-006"
    - name: "Idempotency and Retry Logic (PRIN-004)"
      status: "N/A"
      notes: "Tests exercise existing retry logic but don't modify it"
    - name: "Go Coding Standards (PRIN-011)"
      status: "PASS"
      notes: "Tests will use map-based table-driven pattern; functions under 40 lines"

research_findings:
  decisions:
    - topic: "Mock strategy for Claude CLI invocation"
      decision: "Use existing MockClaudeExecutor (Go-level) for unit tests and mock-claude.sh for integration tests"
      rationale: "Infrastructure already exists and is well-tested; no need to introduce new mock frameworks"
      alternatives_considered:
        - "Create new mock framework (rejected: adds complexity)"
        - "Use gomock or testify/mock (rejected: existing mocks sufficient)"
    - topic: "PromptUserToContinue testability approach"
      decision: "Add PromptUserToContinueWithReader(reader io.Reader) variant; original function delegates to it"
      rationale: "Minimal refactoring, maintains backward compatibility, enables test injection"
      alternatives_considered:
        - "Global stdin override (rejected: not thread-safe)"
        - "Context-based injection (rejected: over-engineered for this use case)"
    - topic: "runPreflightChecks testability approach"
      decision: "Create PreflightChecker interface with optional injection into WorkflowOrchestrator"
      rationale: "Follows accept-interfaces-return-concrete pattern; nil-safe allows zero changes to existing callers"
      alternatives_considered:
        - "Refactor to accept functions directly (rejected: less idiomatic)"
        - "Environment variable mocking (rejected: flaky, not thread-safe)"
    - topic: "Test helper functions location"
      decision: "Add helpers to existing workflow_test.go or mocks_test.go"
      rationale: "Keeps test code together; existing helpers (newTestOrchestratorWithSpecName) already in workflow_test.go"
      alternatives_considered:
        - "Separate test_helpers_test.go file (acceptable alternative)"
        - "internal/testutil package (rejected: too much overhead for this scope)"

data_model:
  entities:
    - name: "PreflightChecker"
      description: "Interface for running preflight checks with testable injection"
      fields:
        - name: "RunChecks"
          type: "func() (*PreflightResult, error)"
          description: "Runs all preflight validations"
          constraints: "Must return non-nil PreflightResult on success"
        - name: "PromptUser"
          type: "func(warning string) (bool, error)"
          description: "Prompts user to continue despite warnings"
          constraints: "Must handle EOF gracefully"
      relationships: []
    - name: "MockPreflightChecker"
      description: "Test double implementing PreflightChecker for unit tests"
      fields:
        - name: "RunChecksResult"
          type: "*PreflightResult"
          description: "Configured result to return"
          constraints: "None"
        - name: "RunChecksError"
          type: "error"
          description: "Configured error to return"
          constraints: "None"
        - name: "PromptUserResult"
          type: "bool"
          description: "Configured prompt response"
          constraints: "None"
        - name: "RunChecksCalled"
          type: "bool"
          description: "Tracks if RunChecks was called"
          constraints: "None"
      relationships:
        - target: "PreflightChecker"
          type: "implements"
          description: "MockPreflightChecker implements PreflightChecker interface"

api_contracts:
  endpoints: []

project_structure:
  documentation:
    - path: "specs/043-workflow-mock-coverage/spec.yaml"
      description: "Feature specification"
    - path: "specs/043-workflow-mock-coverage/plan.yaml"
      description: "Implementation plan"
  source_code:
    - path: "internal/workflow/preflight.go"
      description: "Preflight checks and PromptUserToContinue (to be modified)"
    - path: "internal/workflow/workflow.go"
      description: "WorkflowOrchestrator with runPreflightChecks (to be modified)"
    - path: "internal/workflow/mocks_test.go"
      description: "Mock implementations for testing (to be extended)"
  tests:
    - path: "internal/workflow/workflow_test.go"
      description: "Primary test file (to be extended with integration tests)"
    - path: "internal/workflow/preflight_test.go"
      description: "Preflight-specific tests (to be extended)"

implementation_phases:
  - phase: 1
    name: "Quick Wins - Integration Tests"
    goal: "Write tests that actually call executeSingleTaskSession, executeSinglePhaseSession, executeAndVerifyTask, and executeTaskLoop using existing mock infrastructure"
    deliverables:
      - "TestExecuteSingleTaskSession_Integration - creates orchestrator, sets up artifacts, calls method"
      - "TestExecuteSinglePhaseSession_Integration - creates orchestrator, sets up phase, calls method"
      - "TestExecuteAndVerifyTask_Integration - loads task, calls method, verifies state change"
      - "TestExecuteTaskLoop_Integration - sets up task list, calls method, verifies execution"
      - "Coverage increase from 79.4% to ~82%"
  - phase: 2
    name: "Minor Refactoring - Dependency Injection"
    goal: "Add PromptUserToContinueWithReader and PreflightChecker interface for testability"
    dependencies:
      - "Phase 1"
    deliverables:
      - "PromptUserToContinueWithReader(reader io.Reader) function"
      - "PreflightChecker interface in preflight.go"
      - "MockPreflightChecker in mocks_test.go"
      - "Optional PreflightChecker field in WorkflowOrchestrator"
      - "TestPromptUserToContinue_WithReader - covers y/n/yes/no/empty/EOF inputs"
      - "TestRunPreflightChecks_WithMock - covers pass/warn/fail scenarios"
      - "Coverage increase from ~82% to ~84%"
  - phase: 3
    name: "Edge Cases - Error Path Coverage"
    goal: "Cover remaining edge cases for startProgressDisplay, CleanupContextFile, and error paths"
    dependencies:
      - "Phase 2"
    deliverables:
      - "TestStartProgressDisplay_NilDisplay - verify nil ProgressDisplay doesn't panic"
      - "TestStartProgressDisplay_ErrorPath - verify warning is printed on error"
      - "TestCleanupContextFile_NotExists - verify non-existent file returns nil"
      - "TestCleanupContextFile_Error - verify error is handled gracefully"
      - "TestExecuteTaskLoop_EdgeCases - empty list, all completed, all blocked"
      - "Final coverage ≥85%"

risks:
  - risk: "Integration tests may be flaky due to file system operations"
    likelihood: "medium"
    impact: "low"
    mitigation: "Use t.TempDir() for isolated test directories; clean up after tests"
  - risk: "Mock infrastructure may not accurately simulate real Claude behavior"
    likelihood: "low"
    impact: "medium"
    mitigation: "Existing mock-claude.sh is already used successfully; extend rather than replace"
  - risk: "Interface injection could introduce subtle behavioral changes"
    likelihood: "low"
    impact: "medium"
    mitigation: "Make injection optional with nil-safe defaults; existing tests must pass unchanged"
  - risk: "Cannot use t.Parallel() in integration tests due to t.Setenv()"
    likelihood: "high"
    impact: "low"
    mitigation: "Accept sequential execution for tests using environment variables; document in test comments"

open_questions:
  - question: "Should MockPreflightChecker be exported for use in other packages?"
    context: "Currently all mocks are in mocks_test.go and only available within workflow package"
    proposed_resolution: "Keep unexported initially; export later if needed by other packages"
  - question: "Should we add benchmarks to verify test performance stays under 5 seconds?"
    context: "NFR-006 requires individual test functions complete in under 5 seconds"
    proposed_resolution: "Add timing assertions in tests that may be slow; defer benchmarks unless needed"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-18T04:01:38Z"
  artifact_type: "plan"
