feature:
  branch: "017-update-agent-context-go"
  created: "2025-12-16"
  status: "Draft"
  input: "Migrate update-agent-context.sh shell script to Go CLI command"

user_stories:
  - id: "US-001"
    title: "Update agent context files from plan.yaml"
    priority: "P1"
    as_a: "developer using autospec"
    i_want: "to update AI agent context files (CLAUDE.md, GEMINI.md, etc.) with project information extracted from plan.yaml"
    so_that: "AI coding assistants have accurate, up-to-date context about the project's technologies and recent changes"
    why_this_priority: "Core functionality that the script currently provides - essential for AI-assisted development workflows"
    independent_test: "Run command after creating plan.yaml and verify agent context files are updated with technology information"
    acceptance_scenarios:
      - given: "A project with a valid plan.yaml containing technology information (language, framework, database)"
        when: "I run 'autospec update-agent-context'"
        then: "All existing agent context files are updated with the new technology entries and recent changes"
      - given: "A project with no existing agent context files"
        when: "I run 'autospec update-agent-context'"
        then: "A default CLAUDE.md file is created from the template with the project information"

  - id: "US-002"
    title: "Update specific agent context file"
    priority: "P1"
    as_a: "developer using multiple AI assistants"
    i_want: "to update only a specific agent's context file"
    so_that: "I can selectively update context for the AI tool I'm currently using without affecting others"
    why_this_priority: "Essential for targeted updates and avoiding unnecessary file modifications"
    independent_test: "Run command with --agent flag and verify only the specified agent file is modified"
    acceptance_scenarios:
      - given: "A project with multiple agent context files (CLAUDE.md, GEMINI.md)"
        when: "I run 'autospec update-agent-context --agent claude'"
        then: "Only CLAUDE.md is updated with the new information"
      - given: "A project without the specified agent file"
        when: "I run 'autospec update-agent-context --agent cursor'"
        then: "The Cursor agent file is created from the template in the appropriate location"

  - id: "US-003"
    title: "JSON output for integration"
    priority: "P2"
    as_a: "developer building automation workflows"
    i_want: "to get JSON output from the update-agent-context command"
    so_that: "I can parse the results programmatically and integrate with other tools"
    why_this_priority: "Enables Claude Code slash commands and other automation to consume structured output"
    independent_test: "Run command with --json flag and validate output is valid JSON with expected fields"
    acceptance_scenarios:
      - given: "A project with plan.yaml and agent context files"
        when: "I run 'autospec update-agent-context --json'"
        then: "JSON output includes updated files list, extracted technologies, and success status"

requirements:
  functional:
    - id: "FR-001"
      description: "MUST parse plan.yaml to extract Language/Version, Primary Dependencies, Storage, and Project Type fields"
      testable: true
      acceptance_criteria: "Unit test demonstrates extraction of all four fields from sample plan.yaml"
    - id: "FR-002"
      description: "MUST support updating existing agent context files by appending to Active Technologies and Recent Changes sections"
      testable: true
      acceptance_criteria: "Unit test with mock file system shows existing sections are modified, not overwritten"
    - id: "FR-003"
      description: "MUST support creating new agent context files from a template when they don't exist"
      testable: true
      acceptance_criteria: "Test creates new agent file and validates template placeholders are replaced"
    - id: "FR-004"
      description: "MUST support all agent types: claude, gemini, copilot, cursor, qwen, opencode, codex, windsurf, kilocode, auggie, roo, codebuddy, qoder, amp, shai, q, bob"
      testable: true
      acceptance_criteria: "Test validates file path resolution for each supported agent type"
    - id: "FR-005"
      description: "MUST maintain Recent Changes section with maximum 3 entries (newest first)"
      testable: true
      acceptance_criteria: "Test shows oldest entry is removed when adding new entry to full list"
    - id: "FR-006"
      description: "MUST update timestamp in agent files when modified"
      testable: true
      acceptance_criteria: "Test confirms **Last updated** field contains current date after update"
    - id: "FR-007"
      description: "MUST detect current spec from git branch or SPECIFY_FEATURE environment variable"
      testable: true
      acceptance_criteria: "Test validates spec detection using existing internal/spec package"
    - id: "FR-008"
      description: "SHOULD provide --json flag for machine-readable output"
      testable: true
      acceptance_criteria: "Test validates JSON output structure matches expected schema"
    - id: "FR-009"
      description: "MUST reuse existing Go code from internal/git, internal/spec, and internal/validation packages"
      testable: true
      acceptance_criteria: "Code review confirms reuse of GetRepositoryRoot, DetectCurrentSpec, and validation patterns"
  non_functional:
    - id: "NFR-001"
      category: "performance"
      description: "Command execution must complete within 1 second for typical projects"
      measurable_target: "< 1000ms for projects with < 10 agent files"
    - id: "NFR-002"
      category: "reliability"
      description: "File operations must be atomic to prevent partial updates on failure"
      measurable_target: "Implementation uses temp file + rename pattern for atomic writes"
    - id: "NFR-003"
      category: "usability"
      description: "Error messages must clearly indicate what went wrong and suggest remediation"
      measurable_target: "All error paths include actionable hints"

success_criteria:
  measurable_outcomes:
    - id: "SC-001"
      description: "Users can update agent context files using a single autospec command"
      metric: "Command success rate"
      target: "100% success when plan.yaml exists and is valid"
    - id: "SC-002"
      description: "Claude Code slash commands can call the new command instead of the shell script"
      metric: "Integration compatibility"
      target: "JSON output matches expected format for slash command parsing"
    - id: "SC-003"
      description: "Shell script can be deprecated after Go command is stable"
      metric: "Feature parity"
      target: "100% of shell script functionality replicated in Go"

key_entities:
  - name: "AgentType"
    description: "Enumeration of supported AI agent types with their file paths and display names"
    attributes:
      - "identifier (string): short name like 'claude', 'gemini'"
      - "filePath (string): path to context file relative to repo root"
      - "displayName (string): human-readable name for logging"
  - name: "PlanData"
    description: "Parsed technology information extracted from plan.yaml"
    attributes:
      - "language (string): Language/Version field"
      - "framework (string): Primary Dependencies field"
      - "database (string): Storage field"
      - "projectType (string): Project Type field"
  - name: "UpdateResult"
    description: "Result of updating an agent context file"
    attributes:
      - "filePath (string): path to updated file"
      - "created (bool): true if file was created, false if updated"
      - "technologiesAdded ([]string): list of new tech entries"

edge_cases:
  - scenario: "plan.yaml doesn't exist"
    expected_behavior: "Return error with message directing user to run autospec plan first"
  - scenario: "plan.yaml exists but has empty/missing technology fields"
    expected_behavior: "Skip adding technology entries, still update timestamp and log warning"
  - scenario: "Agent file exists but is read-only"
    expected_behavior: "Return error with clear permission message"
  - scenario: "Template file doesn't exist when creating new agent file"
    expected_behavior: "Return error suggesting user run autospec init"
  - scenario: "Multiple spec directories match the branch prefix"
    expected_behavior: "Return error listing the conflicting directories"
  - scenario: "Active Technologies or Recent Changes section doesn't exist in agent file"
    expected_behavior: "Create the missing section at the end of the file"

assumptions:
  - "Plan.yaml follows the autospec YAML schema with technical_context section"
  - "Agent context files use Markdown format with ## section headers"
  - "Template file exists at .autospec/templates/agent-file-template.md (note: different path from shell script)"
  - "Users have write permissions to the repository root directory"
  - "The internal/git and internal/spec packages provide all needed repository detection functionality"

constraints:
  - "Must maintain backward compatibility with existing agent file formats"
  - "Must not modify content outside of Active Technologies, Recent Changes, and Last updated sections"
  - "Must preserve manual additions users have made to their agent files"
  - "Go standard library preferred; minimize external dependencies"
  - "Tests must be unit tests with mocks only - no integration/e2e tests that call external services (cost constraint)"

out_of_scope:
  - "Migrating other shell scripts (create-new-feature.sh, check-prerequisites.sh)"
  - "Changing the agent file template format"
  - "Adding support for new agent types beyond what the shell script supports"
  - "Modifying the plan.yaml schema or validation"
  - "Interactive prompts for missing information"

_meta:
  version: "1.0.0"
  generator: "autospec"
  generator_version: "autospec dev"
  created: "2025-12-16T03:32:57Z"
  artifact_type: "spec"
